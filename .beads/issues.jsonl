{"id":"test-loom-27c","title":"Implement enricher pipeline with pluggable interfaces","description":"internal/enricher/ - Enricher interface + 5 implementations: grouper (by package), patterns (no-op), simplifier (prune+cap), annotator (no-op), scorer (equal weight). All have LLM-ready interfaces for iteration 2.","status":"closed","priority":2,"issue_type":"task","owner":"olesho@gmail.com","created_at":"2026-02-19T09:05:56.360211-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T09:06:00.702199-06:00","closed_at":"2026-02-19T09:06:00.702199-06:00","close_reason":"All 5 enricher files implemented with default code-only implementations"}
{"id":"test-loom-2gr","title":"Reset button in Package Map only resets zoom, not item selections","description":"The Reset button in the Package Map control bar (id=zoom-reset) only resets the zoom level to 1x. It does NOT clear item selections (selectedTypeIDs, selectedIfaceIDs), uncheck checkboxes in overlays/sidebar, remove selection badges from blocks, or remove highlight borders. Users expect Reset to return the entire Package Map to its initial state, including clearing all selections.\n\nSteps to reproduce:\n1. Open the interactive UI with any module that has interfaces/types\n2. Click a package block to open its overlay popup\n3. Check one or more interface/type checkboxes\n4. Observe: selection badges appear, blocks get highlighted\n5. Click the Reset button\n6. Bug: selections persist — badges, highlights, and checkboxes remain\n\nRoot cause: server.go lines 1559-1562 — the zoom-reset click handler only sets scale=1 and calls applyZoom(). It needs to also clear selectedTypeIDs/selectedIfaceIDs, uncheck all checkboxes, dismiss any open overlay, and call updateSelectionUI().\n\nFix location: goifaces/internal/server/server.go, the zoom-reset event listener.","status":"closed","priority":2,"issue_type":"bug","owner":"olesho@gmail.com","created_at":"2026-02-27T07:44:04.388935-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-27T07:47:36.224688-06:00","closed_at":"2026-02-27T07:47:36.224688-06:00","close_reason":"Fixed: Reset button now clears selectedTypeIDs/selectedIfaceIDs, unchecks all sidebar checkboxes, dismisses overlay, and calls updateSelectionUI()"}
{"id":"test-loom-2ri","title":"Accept any filesystem path in CLI (not just Go modules)","description":"Currently the CLI only accepts paths to Go modules. Allow passing any filesystem path (directory) so users can point at any folder, similar to how a git repo path works. The tool should still attempt Go analysis but gracefully handle non-Go directories.","design":"## Summary\n\nThis task modifies the resolver and analyzer to accept any filesystem directory path, not just Go modules. Currently, `resolver.Resolve()` hard-fails if no `go.mod` is found anywhere in the directory tree. The change makes the go.mod requirement optional: if found, behavior is unchanged; if not found, the raw directory is returned and the analyzer attempts Go analysis anyway, gracefully producing empty results for non-Go directories. This lets users point the tool at any folder without cryptic errors.\n\n## Technical Approach\n\nThe change follows the existing error-handling pattern where non-fatal issues are logged as warnings (like `go mod download` failures). The key insight is that most downstream code already handles the `modulePath == \"\"` case — the filter includes all results when no module path is set, and `readModulePath()` returns empty string if no `go.mod` exists.\n\n**Strategy: Make go.mod optional in the resolver, handle package-load failures gracefully in the analyzer.**\n\nNo new dependencies. No new files. Minimal changes to two existing files.\n\n## Files to Modify\n\n### 1. `goifaces/internal/resolver/resolver.go` — Make go.mod lookup non-fatal\n\n**Current behavior (lines 39-43):** `findModuleRoot()` returns an error if no `go.mod` is found, which propagates up and kills the process.\n\n**New behavior:**\n- In `Resolve()`, replace the hard error from `findModuleRoot()` with a warning log. If no `go.mod` is found, use `absPath` (the validated input directory) as the return value instead of the module root.\n- Skip `goModDownload()` when no go.mod was found (it would fail anyway).\n- Log a warning: `\"no go.mod found, using directory as-is\"`\n\nSpecific change to lines 39-52:\n```go\n// Find module root (nearest go.mod) — optional\nmodRoot, err := findModuleRoot(absPath)\nif err != nil {\n    // No go.mod found — use the input directory directly.\n    // Go analysis will be attempted but may produce empty results.\n    logger.Warn(\"no go.mod found, using directory as-is\", \"dir\", absPath)\n    return absPath, cleanup, nil\n}\n\nlogger.Info(\"resolved local directory\", \"input\", input, \"module_root\", modRoot)\n\n// Run go mod download to ensure deps are available\nif err := goModDownload(ctx, modRoot, logger); err != nil {\n    logger.Warn(\"go mod download failed\", \"error\", err)\n}\n\nreturn modRoot, cleanup, nil\n```\n\n### 2. `goifaces/internal/analyzer/analyzer.go` — Handle package-load failure gracefully\n\n**Current behavior (lines 31-34):** `packages.Load()` failure returns a hard error.\n\n**New behavior:**\n- If `packages.Load()` returns an error AND `modulePath` is empty (no go.mod was found), return an empty `Result` with a warning log instead of a hard error. This covers the case where the user points at a non-Go directory.\n- If `packages.Load()` returns an error AND `modulePath` is non-empty (a go.mod exists but packages still fail), keep the existing hard error — something is genuinely wrong.\n\nSpecific change to lines 31-34:\n```go\npkgs, err := packages.Load(cfg, \"./...\")\nif err != nil {\n    if modulePath == \"\" {\n        // No go.mod and package loading failed — this is likely a non-Go directory.\n        logger.Warn(\"no Go packages found\", \"dir\", dir, \"error\", err)\n        return \u0026Result{}, nil\n    }\n    return nil, fmt.Errorf(\"loading packages: %w\", err)\n}\n```\n\n### 3. `goifaces/internal/resolver/resolver_test.go` — Add test for no-go.mod directory\n\nAdd a new test function `TestResolve_NoGoMod` that:\n- Creates a temp directory with no go.mod\n- Calls `Resolve()` with that directory\n- Asserts no error is returned\n- Asserts the returned dir is the input directory itself\n\nAlso add a test `TestResolve_WithGoMod` as a positive control:\n- Creates a temp directory with a go.mod\n- Calls `Resolve()` with that directory\n- Asserts no error and returned dir is the directory (since go.mod is at root)\n\n### 4. `goifaces/main_test.go` — No changes needed\n\nThe behavioral contract tests (`TestNoArgsLeadsToEmptyInput`, etc.) don't need updates since the path handling in main.go is unchanged — only the downstream resolver behavior changes.\n\n## Dependencies\n\n- No external packages needed\n- Internal: relies on existing `findModuleRoot()` error to detect non-Go directories\n- No task dependencies\n\n## Edge Cases \u0026 Error Handling\n\n1. **Non-existent path** — Still returns a hard error (os.Stat fails). No change needed.\n2. **Path is a file, not directory** — Still returns a hard error. No change needed.\n3. **Directory with go.mod but broken Go code** — `packages.Load()` may error; since modulePath is non-empty, the hard error is preserved. Correct behavior.\n4. **Directory without go.mod but with .go files** — `packages.Load()` may succeed (Go files without a module). The analysis proceeds and results are shown. Good behavior.\n5. **Empty directory** — `packages.Load()` returns error, modulePath is empty, so we return empty Result. User sees \"No interfaces or implementations found.\" Good behavior.\n6. **Subdirectory of a Go module (no go.mod in dir but go.mod in parent)** — `findModuleRoot()` succeeds (it walks up). Existing behavior preserved.\n7. **GitHub URL pointing to non-Go repo** — `fetchRepo()` uses `findModuleRootRecursive()` which still hard-fails. This is intentional: cloning a non-Go repo from GitHub is likely a user error and should be flagged. The task scope is for local filesystem paths only.\n8. **POST /api/load with non-Go local path** — `RunAnalysis()` calls `resolver.Resolve()` which now succeeds, then `analyzer.Analyze()` returns empty result, then the UI shows no data. The existing error handling in `handleLoad()` passes through the error if `RunAnalysis()` fails, but now it won't fail for non-Go dirs.\n\n## Testing Strategy\n\n### Unit Tests\n1. **`TestResolve_NoGoMod`** — Temp dir without go.mod → Resolve returns the dir, no error\n2. **`TestResolve_WithGoMod`** — Temp dir with go.mod → Resolve returns module root, no error\n3. **`TestResolve_NonExistentPath`** — Nonexistent path → Resolve returns error (regression guard)\n4. **`TestResolve_FileNotDir`** — File path → Resolve returns error (regression guard)\n\n### Manual Verification\n1. Run `goifaces /tmp` (or any non-Go directory) — should show \"No interfaces or implementations found\" instead of crashing\n2. Run `goifaces .` (in a Go module) — should work exactly as before\n3. Run `goifaces /some/go/subdir` (subdirectory of a module) — should still find the parent go.mod\n4. Run `go test ./internal/resolver/... ./internal/analyzer/...` — all tests pass","status":"closed","priority":2,"issue_type":"feature","assignee":"falcon","owner":"olesho@gmail.com","created_at":"2026-02-26T16:36:05.982756-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-26T17:27:04.78132-06:00","closed_at":"2026-02-26T17:27:04.78132-06:00","close_reason":"Completed: resolver now returns input directory when no go.mod found, analyzer gracefully handles non-Go directories, tests and docs updated"}
{"id":"test-loom-2ul","title":"Fix color differentiation not rendering in browser for interfaces vs implementations","description":"The classDef and cssClass directives for color-coding interfaces (blue #2374ab) vs implementations (green #4a9c6d) are present in the generated Mermaid source but not rendering visually in the browser. The styles were added in mermaid.go but may not be taking effect with Mermaid.js v11 in-browser rendering. Need to investigate why and fix.","status":"closed","priority":1,"issue_type":"bug","owner":"olesho@gmail.com","created_at":"2026-02-19T16:25:51.602997-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T16:43:48.291601-06:00","closed_at":"2026-02-19T16:43:48.291601-06:00","close_reason":"Closed"}
{"id":"test-loom-2vm","title":"Replace Entities tab with Implementations and Interfaces selectable lists","description":"Replace the top-level 'Entities' tab with two separate tabs: 'Implementations' and 'Interfaces'. Each tab shows a multi-select list of items. Selecting items dynamically redraws the Mermaid chart to show ONLY selected items and their direct relations.\n\n## Current Behavior\n- Top menu has two tabs: 'Package Map' and 'Entities'\n- 'Entities' tab shows a Prev/Next slide navigator cycling through pre-built entity slides\n- Each slide is a fixed grouping of types/interfaces (hub-and-spoke split)\n\n## Desired Behavior\n- Top menu has three tabs: 'Package Map', 'Implementations', 'Interfaces'\n- Remove the Prev/Next buttons and slide selector entirely — no more pre-built slides\n- 'Implementations' tab: shows a scrollable list of all implementation types with checkboxes (multi-select)\n- 'Interfaces' tab: shows a scrollable list of all interfaces with checkboxes (multi-select)\n- When the user changes selection in either list, a single Mermaid diagram is generated on-the-fly based on the selection:\n  - ONLY the selected items\n  - PLUS any items directly related to them via implementation relations\n- Examples:\n  - Select 'Implementation-1' → chart shows Implementation-1 + all interfaces it implements (e.g. Interface-1, Interface-2)\n  - Select 'Interface-1' → chart shows Interface-1 + all types that implement it (e.g. Implementation-1)\n  - Select multiple items → union of all their relations\n\n## Architecture Change\n- Remove the hub-and-spoke slide splitting logic from the serving path — slides are no longer pre-built\n- The server passes the full lists of interfaces, types, and relations to the template as JSON data\n- Client-side JS handles filtering and Mermaid diagram generation based on user selection\n- Mermaid.js re-render via mermaid.run() after updating the pre block\n- The split package and BuildSlides can remain for backward compat (e.g. file export) but are not used in the web UI flow\n\n## Technical Details\n- All UI is in goifaces/internal/server/server.go (slidesHTMLTemplate)\n- Data model: analyzer.Result has .Interfaces, .Types, .Relations\n- Mermaid generation: diagram.GenerateMermaid() in diagram/mermaid.go\n- The server must pass full lists of interfaces, types, and relations to the template as JSON\n\n## Key Files\n- goifaces/internal/server/server.go — HTML template + HTTP handlers (ServeSlides)\n- goifaces/internal/diagram/mermaid.go — GenerateMermaid() function\n- goifaces/internal/diagram/slides.go — BuildSlides() + Slide type\n- goifaces/internal/analyzer/types.go — InterfaceDef, TypeDef, Relation types\n\n## Testing Requirements\n- Write tests that verify the filtering logic:\n  1. Selecting an implementation includes ONLY that implementation + interfaces it implements\n  2. Selecting an interface includes ONLY that interface + implementations that implement it\n  3. Selecting multiple items produces the union of their relations\n  4. Selecting nothing shows an empty or placeholder diagram\n  5. Items with no relations (orphans) show only themselves when selected\n- Tests should validate the generated Mermaid output contains exactly the expected nodes and relations","design":"## Summary\n\nReplace the existing slide-based entity navigator (Prev/Next cycling through pre-built hub-and-spoke slides) with a three-tab interactive UI: **Package Map**, **Implementations**, and **Interfaces**. The Implementations and Interfaces tabs each show a scrollable multi-select checkbox list. Checking items dynamically regenerates the Mermaid class diagram client-side to show only selected items plus their direct relations. This gives users precise control over which entities appear in the diagram, replacing the fixed groupings of the current slide system.\n\n## Technical Approach\n\n### Architecture Decision: Client-Side Filtering\n\nMermaid generation and filtering happen entirely in the browser via JavaScript. The Go server passes the full dataset (interfaces, types, relations) as JSON embedded in the HTML template. Client-side JS filters the dataset based on checkbox selections and builds Mermaid classDiagram syntax, then calls \\`mermaid.run()\\` to re-render.\n\n**Why client-side**: Instant response to selection changes (no network round-trip), simpler server, and the Mermaid class diagram syntax is straightforward to generate in JS.\n\n**Testability**: A Go function \\`FilterBySelection()\\` in the \\`diagram\\` package implements the same filtering logic. Integration tests validate this function. The JS mirrors it for the client-side UX.\n\n### UI Layout\n\n- **Tab bar**: \\`[Package Map] [Implementations] [Interfaces]\\` — styled as horizontal buttons\n- **Package Map tab**: Shows the pre-rendered package map flowchart (same as current slide 0). No checkbox list.\n- **Implementations tab**: Left panel = scrollable checkbox list of all implementation types. Right panel = Mermaid diagram.\n- **Interfaces tab**: Left panel = scrollable checkbox list of all interfaces. Right panel = Mermaid diagram.\n- Selections from both lists are combined: if you select items in Implementations AND switch to Interfaces and select more, the diagram shows the union of all selections + their direct relations.\n- Zoom controls and Copy Source button remain in the control bar.\n\n### Data Flow\n\n1. \\`main.go\\` builds \\`analyzer.Result\\` (unchanged)\n2. \\`main.go\\` calls \\`diagram.GeneratePackageMap(result, opts)\\` to get the package map Mermaid string\n3. \\`main.go\\` calls \\`diagram.PrepareInteractiveData(result, opts)\\` to get a struct with interfaces, types, relations (with sanitized IDs and method signatures)\n4. \\`main.go\\` calls \\`server.ServeInteractive(ctx, data)\\` passing the prepared data\n5. Server renders the HTML template with JSON data embedded\n6. Client JS handles tab switching, checkbox events, diagram generation\n\n## Files to Modify\n\n### 1. \\`goifaces/internal/diagram/mermaid.go\\`\n- **Export** \\`nodeID()\\` → \\`NodeID()\\` (public) so the server/main can compute consistent node IDs\n- **Export** \\`sanitizeSignature()\\` → \\`SanitizeSignature()\\` (public) for preparing method strings\n- Update all internal callers to use the new names\n\n### 2. \\`goifaces/internal/diagram/slides.go\\`\n- **Export** \\`generatePackageMapMermaid()\\` → \\`GeneratePackageMapMermaid()\\` (public) so main.go can call it directly\n- Update internal callers\n\n### 3. \\`goifaces/internal/server/server.go\\`\n- **Remove** \\`slidesHTMLTemplate\\`, \\`slideEntry\\`, \\`slidesData\\`, \\`ServeSlides()\\` — the slide-based UI is fully replaced\n- **Add** new types:\n  - \\`InteractiveInterface\\` — \\`{ID, Name, PkgName, Methods []string, SourceFile}\\`\n  - \\`InteractiveType\\` — \\`{ID, Name, PkgName, SourceFile}\\`\n  - \\`InteractiveRelation\\` — \\`{TypeID, InterfaceID}\\`\n  - \\`InteractiveData\\` — \\`{PackageMapMermaid, Interfaces, Types, Relations, RepoAddress}\\`\n- **Add** \\`ServeInteractive(ctx, data InteractiveData, port, openBrowser, logger)\\` function\n- **Add** new HTML template \\`interactiveHTMLTemplate\\` with:\n  - Tab bar (Package Map / Implementations / Interfaces)\n  - Package Map panel: \\`\u003cpre class=\"mermaid\"\u003e\\` with pre-rendered content\n  - Implementations panel: checkbox list + diagram container\n  - Interfaces panel: checkbox list + diagram container\n  - JavaScript:\n    - Tab switching logic (show/hide panels)\n    - Checkbox change handler → collect all selected IDs from both lists → filter relations → build Mermaid string → clear old SVG → insert into \\`\u003cpre\u003e\\` → call \\`mermaid.run()\\`\n    - Mermaid string builder (mirrors Go's GenerateMermaid format: classDiagram header, direction LR, classDef styles, class blocks, relation lines, cssClass assignments)\n    - Copy Source copies the current JS-generated Mermaid source\n  - CSS: tab styling, side-by-side layout for list+diagram, checkbox list scrollable with max-height\n\n### 4. \\`goifaces/main.go\\`\n- Replace \\`diagram.BuildSlides()\\` call with:\n  1. \\`diagram.GeneratePackageMapMermaid(result, diagramOpts)\\`\n  2. \\`diagram.PrepareInteractiveData(result, diagramOpts)\\`\n- Replace \\`server.ServeSlides()\\` with \\`server.ServeInteractive()\\`\n- Remove imports/flags no longer needed (\\`split\\` package import, \\`hub-threshold\\`, \\`chunk-size\\`, \\`slide-threshold\\` flags)\n- Note: The \\`-output\\` file mode still calls \\`GenerateMermaid()\\` directly (unchanged)\n\n### 5. \\`goifaces/internal/integration_test.go\\`\n- **Update** existing slide-based tests: tests that assert slide count, Package Map title, hub presence per slide — these need to be rewritten or removed since the slide system is gone\n- **Add** new tests for \\`FilterBySelection()\\`:\n  1. Select one implementation → result contains that impl + all interfaces it implements\n  2. Select one interface → result contains that interface + all types implementing it\n  3. Select multiple items → union of their relations\n  4. Select nothing → empty result (no interfaces, no types, no relations)\n  5. Select an orphan (item with no relations) → result contains only that item, no relations\n  6. Select from both lists → combined result\n- **Keep** existing \\`GenerateMermaid\\` tests, \\`normalizeOutput\\` helper, and format tests — these are unaffected\n\n### 6. \\`goifaces/docs/architecture.md\\`\n- Update the \\`internal/server\\` section to describe the interactive tabbed UI\n- Update the \\`internal/diagram\\` section to mention the exported functions and \\`FilterBySelection\\`\n- Remove references to slide/splitter model from server description\n\n### 7. \\`goifaces/docs/cli-reference.md\\`\n- Remove \\`--slide-threshold\\`, \\`--hub-threshold\\`, \\`--chunk-size\\` flags documentation\n- These flags become obsolete since we no longer split into slides\n\n## Files to Create\n\n### 1. \\`goifaces/internal/diagram/filter.go\\`\nNew file containing:\n- \\`PrepareInteractiveData(result *analyzer.Result, opts DiagramOptions) InteractiveData\\` — converts analyzer.Result into the data structure the server needs, computing node IDs and sanitizing method signatures\n- \\`InteractiveData\\`, \\`InteractiveInterface\\`, \\`InteractiveType\\`, \\`InteractiveRelation\\` types (or these could live in the server package — but putting them in diagram keeps the data preparation close to the Mermaid generation logic)\n- \\`FilterBySelection(result *analyzer.Result, selectedTypeIDs, selectedIfaceIDs []string) *analyzer.Result\\` — filters a Result to only include selected items + their direct relations (for testing the filtering logic that JS mirrors)\n\n**Note**: The types defined here are the Go-side data model. The server package references them. This avoids the server depending on analyzer directly.\n\n## Dependencies\n\n- No new external packages needed\n- Internal: \\`server\\` now depends on \\`diagram\\` types (already the case via \\`diagram.Slide\\`)\n- Mermaid.js CDN (already used, same version)\n\n## Edge Cases \u0026 Error Handling\n\n1. **No selections**: Show a placeholder message (\"Select items from the list to view their relationships\") instead of an empty diagram\n2. **Orphans**: Items with no relations — when selected, show only that item as a standalone node with no arrows\n3. **Large lists**: The checkbox list should be scrollable with a max-height. Consider adding a search/filter input above the list for repositories with many types (future enhancement, not required for this task)\n4. **Empty result**: If the analyzer finds no interfaces or types, the existing early-exit in main.go handles this (line 125-128)\n5. **Mermaid re-render errors**: Wrap \\`mermaid.run()\\` in try/catch; on error, show the raw Mermaid source as text so the user can debug\n6. **Package Map tab**: Static content, no filtering needed. Just show/hide on tab switch.\n7. **Template JSON escaping**: Use Go template's \\`json\\` pipeline or marshal to JSON string and embed safely to avoid XSS from type/interface names containing special characters\n\n## Testing Strategy\n\n### Go tests (integration_test.go)\n\nTest \\`FilterBySelection()\\` with synthetic data:\n\n1. **Single implementation selected**: Create result with 2 types (A, B) and 2 interfaces (I, J). A implements I and J. B implements J. Select only A → result has A, I, J and relations A→I, A→J. B is excluded.\n2. **Single interface selected**: Select only I → result has I, A and relation A→I. B and J excluded.\n3. **Multiple selections**: Select A and J → union: A→I, A→J, B→J. Result has A, B, I, J.\n4. **Empty selection**: Select nothing → empty result.\n5. **Orphan selection**: Add type C with no relations. Select C → result has only C, no interfaces, no relations.\n6. **Cross-tab selections**: Select type A + interface J → same as union logic.\n\n### Go tests for exported functions\n\n- Test \\`NodeID()\\` returns consistent sanitized IDs\n- Test \\`SanitizeSignature()\\` handles edge cases\n- Test \\`PrepareInteractiveData()\\` produces correct structure with proper IDs\n\n### Manual verification\n\n- Run the server, verify tab switching works\n- Check that selecting items redraws the diagram correctly\n- Verify Package Map tab still displays properly\n- Test Copy Source copies the current filtered diagram\n- Test zoom controls work on dynamically generated diagrams\n- Visual verify with \\`bash scripts/visual-verify.sh\\`","status":"closed","priority":1,"issue_type":"feature","assignee":"spark","owner":"olesho@gmail.com","created_at":"2026-02-21T17:05:17.151559-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-21T17:27:10.56385-06:00","closed_at":"2026-02-21T17:27:10.56385-06:00","close_reason":"Completed: interactive 3-tab UI with FilterBySelection, tests, code review fixes"}
{"id":"test-loom-2w9","title":"Remove Mermaid-based Package Map tab","description":"Remove the non-HTML 'Package Map' tab that uses Mermaid rendering. Keep the following tabs intact: 'Package Map (html)', 'Interfaces', and 'Implementations'.","design":"## Summary\n\nRemove the Mermaid-based \\\"Package Map\\\" tab from the interactive server UI, making the HTML treemap-based \\\"Package Map (html)\\\" the sole package map view. This eliminates the redundant Mermaid flowchart tab while keeping the treemap, Interfaces, and Implementations tabs intact. The Mermaid CDN and initialization must remain since the Interfaces and Implementations tabs still use Mermaid for rendering class diagrams.\n\n## Technical Approach\n\nThis is a surgical removal confined to a single file: \\`goifaces/internal/server/server.go\\` (the HTML template). The Go backend function \\`GeneratePackageMapMermaid()\\` is NOT deleted because it is also used by \\`BuildSlides()\\` in slides.go for the non-interactive output mode. Instead, we stop passing it to the template and remove all references from the HTML/CSS/JS.\n\nKey decisions:\n- **Keep Mermaid CDN + init**: Still needed by Impls/Ifaces tabs\n- **Keep zoom controls**: They apply to all tabs via \\`getActiveContainer()\\`\n- **Rename \\\"Package Map (html)\\\" → \\\"Package Map\\\"**: Since it's now the only package map tab\n- **Make treemap the default active tab**: It replaces the old pkgmap as default\n- **Remove /mermaid.md endpoint**: It only served the package map mermaid source\n- **Remove PackageMapMermaid from template data struct**: No longer needed by the template\n\n## Files to Modify\n\n### 1. \\`goifaces/internal/server/server.go\\` (primary — all changes here)\n\n#### HTML Tab Bar (lines 400-405)\n- Remove: \\`\u003cbutton class=\\\"tab-btn active\\\" data-tab=\\\"pkgmap\\\"\u003ePackage Map\u003c/button\u003e\\`\n- Change: \\`data-tab=\\\"pkgmap-html\\\"\\` → \\`data-tab=\\\"pkgmap-html\\\"\\` but rename label from \\\"Package Map (html)\\\" to \\\"Package Map\\\"\n- Add \\`active\\` class to the Package Map (html) button since it becomes the default tab\n\n#### HTML Panel: Remove pkgmap panel (lines 414-421)\n- Delete the entire \\`\u003c!-- Package Map tab --\u003e\\` div (\\`#panel-pkgmap\\`)\n\n#### HTML Panel: Update pkgmap-html panel (lines 423-428)\n- Add \\`active\\` class: \\`\u003cdiv class=\\\"tab-panel full-width\\\" ...\\` → \\`\u003cdiv class=\\\"tab-panel active full-width\\\" ...\\`\n\n#### JavaScript State Variables (line 481-484)\n- Change \\`currentTab = 'pkgmap'\\` → \\`currentTab = 'pkgmap-html'\\`\n- Remove \\`var pkgMapRendered = false;\\`\n\n#### JavaScript: switchTab function (lines 868-884)\n- Remove the \\`if (tab === 'pkgmap' \u0026\u0026 !pkgMapRendered)\\` block (lines 875-877)\n\n#### JavaScript: renderPackageMap function (lines 886-895)\n- Delete the entire \\`renderPackageMap()\\` function\n\n#### JavaScript: Initial render block (lines 897-910)\n- Delete the entire deferred initial render of \\`pkgmap-mermaid\\` (lines 897-910). Replace with immediate treemap layout trigger:\n  \\`\\`\\`js\n  requestAnimationFrame(function() {\n    layoutTreemap();\n    pkgMapHtmlRendered = true;\n  });\n  \\`\\`\\`\n\n#### JavaScript: fixSvgWidth function (lines 912-930)\n- Keep — still used by Impls/Ifaces mermaid rendering\n\n#### JavaScript: getActiveContainer function (lines 1099-1104)\n- Remove the \\`if (currentTab === 'pkgmap') return ...\\` line (line 1100)\n\n#### JavaScript: copy-src handler (lines 1123-1139)\n- Remove the \\`if (currentTab === 'pkgmap')\\` branch (lines 1125-1126) that reads from \\`pkgmap-mermaid\\`\n\n#### Go struct: interactiveData (lines 1169-1175)\n- Remove \\`PackageMapMermaid string\\` field\n\n#### Go function: ServeInteractive templateData (line 1204-1208)\n- Remove \\`PackageMapMermaid: data.PackageMapMermaid,\\` line\n\n#### Go function: /mermaid.md endpoint (lines 1222-1226)\n- Remove the entire \\`mux.HandleFunc(\\\"/mermaid.md\\\", ...)\\` handler\n\n### 2. \\`goifaces/main.go\\` (line 166, 168)\n- Remove: \\`pkgMapMermaid := diagram.GeneratePackageMapMermaid(result, diagramOpts)\\`\n- Remove: \\`interactiveData.PackageMapMermaid = pkgMapMermaid\\`\n\n### 3. \\`goifaces/internal/diagram/filter.go\\` (line 45)\n- Remove: \\`PackageMapMermaid string \\`json:\\\"packageMapMermaid\\\"\\`\\` from \\`InteractiveData\\` struct\n\n## Files NOT to Modify\n\n- \\`goifaces/internal/diagram/slides.go\\`: \\`GeneratePackageMapMermaid()\\` is still used by \\`BuildSlides()\\` for non-interactive output. Keep all code.\n- \\`goifaces/internal/integration_test.go\\`: Tests \\`GeneratePackageMapMermaid\\` via \\`BuildSlides\\`, not via the interactive UI. No changes needed.\n- Mermaid CDN script tag and \\`mermaid.initialize()\\` block: Still required by Implementations and Interfaces tabs.\n\n## Dependencies\n\n- No external packages to add or remove\n- Mermaid CDN stays (used by other tabs)\n- No task dependencies — this is independent\n\n## Edge Cases \u0026 Error Handling\n\n1. **Default tab on load**: With pkgmap removed, the default must be pkgmap-html. The treemap must render immediately on page load (currently it only renders lazily when the tab is clicked). The initial render block must trigger \\`layoutTreemap()\\` on page load.\n2. **Copy Source button**: Currently has a branch for pkgmap that reads mermaid source. After removal, the pkgmap-html branch (which builds text from the tree data) becomes the first check.\n3. **URL /mermaid.md**: After removing the endpoint, requests to it will 404 — acceptable since no external consumers depend on it.\n\n## Testing Strategy\n\n1. **Build**: Run \\`go build ./...\\` to verify compilation\n2. **Run tests**: Run \\`go test ./...\\` to verify all existing tests pass\n3. **Manual verification**: Start the server and verify:\n   - Only 3 tabs visible: \\\"Package Map\\\", \\\"Implementations\\\", \\\"Interfaces\\\"\n   - \\\"Package Map\\\" tab shows the HTML treemap (not a Mermaid flowchart)\n   - Treemap renders on initial page load (no need to click the tab first)\n   - Zoom controls work on all tabs\n   - Copy Source works on the treemap tab (outputs text tree, not mermaid)\n   - Implementations and Interfaces tabs still render Mermaid class diagrams correctly\n   - No JavaScript console errors","status":"closed","priority":2,"issue_type":"task","assignee":"nova","owner":"olesho@gmail.com","created_at":"2026-02-24T16:01:45.451613-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-24T16:42:53.684272-06:00","closed_at":"2026-02-24T16:42:53.684272-06:00","close_reason":"Removed Mermaid-based Package Map tab. Treemap is now the default and only package map view. Updated docs."}
{"id":"test-loom-2xn","title":"Show repository address in webpage title","description":"Add the repository address (local path or GitHub URL) to the HTML page title when serving diagrams via the web UI.","design":"## Summary\n\nThe browser tab currently shows a hardcoded title \\\"goifaces — Interface Diagram (Slides)\\\" regardless of which repository is being analyzed. This task threads the original user input (local path or GitHub URL) through the call chain so it appears in the HTML `\u003ctitle\u003e` tag and `\u003ch1\u003e` heading, giving users immediate context about which repository they're viewing.\n\n## Technical Approach\n\n**Strategy**: Pass the original `input` string from `main.go` through to the server functions as a new `repoAddr` parameter. Use Go template variables to inject it into the HTML `\u003ctitle\u003e` and `\u003ch1\u003e` tags.\n\n**Display format**: \\\"goifaces — \u003crepo-address\u003e\\\" where `\u003crepo-address\u003e` is:\n- The GitHub URL as-is (e.g. \\\"https://github.com/user/repo\\\") for remote repos\n- The resolved absolute path (e.g. \\\"/Users/x/project\\\") for local repos\n\n**Why this approach**: Minimal changes, no new types/abstractions needed. The `input` string is already available in `main.go` — it just needs to be forwarded. Using the raw input preserves what the user typed, which is the most recognizable identifier for them.\n\n**Trade-off considered**: We could shorten the display (e.g. just \\\"user/repo\\\" for GitHub, or basename for local paths) but the full address is more unambiguous and the `\u003ctitle\u003e` tag has no practical length limit.\n\n## Files to Modify\n\n### 1. `goifaces/internal/server/server.go`\n\n**Changes:**\n\na) Add a `RepoTitle` field to the anonymous struct in `Serve()` (line 219):\n```go\ndata := struct {\n    MermaidContent string\n    MermaidRaw     string\n    RepoTitle      string\n}{\n    MermaidContent: mermaidContent,\n    MermaidRaw:     mermaidContent,\n    RepoTitle:      repoTitle,\n}\n```\n\nb) Add a `RepoTitle` field to `slidesData` struct (line 306):\n```go\ntype slidesData struct {\n    Slides     []slideEntry\n    SlideCount int\n    RepoTitle  string\n}\n```\n\nc) Update `Serve` function signature (line 213) to accept `repoTitle string`:\n```go\nfunc Serve(ctx context.Context, mermaidContent string, port int, openBrowser bool, repoTitle string, logger *slog.Logger) error\n```\n\nd) Update `ServeSlides` function signature (line 599) to accept `repoTitle string`:\n```go\nfunc ServeSlides(ctx context.Context, slides []diagram.Slide, port int, openBrowser bool, repoTitle string, logger *slog.Logger) error\n```\n\ne) In `ServeSlides`, pass `repoTitle` into `slidesData` (around line 614):\n```go\ndata := slidesData{\n    Slides:     entries,\n    SlideCount: len(slides),\n    RepoTitle:  repoTitle,\n}\n```\n\nf) Update `htmlTemplate` — change the `\u003ctitle\u003e` (line 23) and `\u003ch1\u003e` (line 139):\n```html\n\u003ctitle\u003egoifaces — {{.RepoTitle}}\u003c/title\u003e\n...\n\u003ch1\u003egoifaces — {{.RepoTitle}}\u003c/h1\u003e\n```\n\ng) Update `slidesHTMLTemplate` — change the `\u003ctitle\u003e` (line 316) and `\u003ch1\u003e` (line 458):\n```html\n\u003ctitle\u003egoifaces — {{.RepoTitle}}\u003c/title\u003e\n...\n\u003ch1\u003egoifaces — {{.RepoTitle}}\u003c/h1\u003e\n```\n\n### 2. `goifaces/main.go`\n\n**Changes:**\n\na) Update the `server.ServeSlides` call (line 159) to pass `input`:\n```go\nif err := server.ServeSlides(ctx, slides, *port, openBrowser, input, logger); err != nil {\n```\n\nNote: The `Serve()` function is currently unused by main (only `ServeSlides` is called in the else branch on line 159), but its signature should still be updated for consistency.\n\n## Files to Create\n\nNone.\n\n## Dependencies\n\nNo external packages needed. Only uses Go standard library (`html/template` handles escaping automatically for `{{.RepoTitle}}`).\n\n## Edge Cases \u0026 Error Handling\n\n1. **HTML injection**: Go's `html/template` auto-escapes template variables, so special characters in paths (e.g. `\u003c`, `\u003e`, `\u0026`, quotes) are safely handled.\n2. **Very long paths**: Local absolute paths can be long. This is acceptable — browser tabs truncate long titles naturally.\n3. **Empty input**: Cannot happen — `main.go` exits with usage error if `input` is empty (line 57-61).\n4. **GitHub URL with query params or fragments**: Displayed as-is, which is fine since the user typed it.\n\n## Testing Strategy\n\n1. **Unit tests**: No existing server tests exist. This change is primarily UI/template-level. The implementation agent should verify the template still parses correctly by ensuring existing integration tests pass (`go test ./...`).\n2. **Manual verification**: Run `goifaces ./some-local-path` and check the browser tab title shows the path. Run with a GitHub URL and verify it shows the URL.\n3. **Lint check**: Run `golangci-lint run ./...` to ensure code quality.\n\n## Documentation Updates\n\n- Update `docs/architecture.md` if it mentions the server functions' signatures.\n- No CLI flag changes, so `docs/cli-reference.md` doesn't need updating.","status":"closed","priority":2,"issue_type":"task","owner":"olesho@gmail.com","created_at":"2026-02-21T15:16:54.118313-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-21T15:21:38.183528-06:00","closed_at":"2026-02-21T15:21:38.183528-06:00","close_reason":"Added repoAddress parameter to Serve and ServeSlides functions, updated HTML templates to show repo address in title and h1"}
{"id":"test-loom-376","title":"Add 'Package Map (html)' tab with native HTML/CSS treemap layout alongside existing Mermaid tab","description":"Replace the Mermaid-based Package Map diagram with a native HTML/CSS chart. Research and choose the most 'liquid' (fluid/responsive) layout approach so the chart fills most of the available screen space. Candidates to evaluate: CSS Grid, Flexbox, force-directed layout (JS), treemap, or other space-filling algorithms. The goal is maximum screen utilization — no wasted whitespace — while keeping the diagram readable and interactive.","design":"## Summary\n\nAdd a new **\"Package Map (html)\"** tab alongside the existing Mermaid-based \"Package Map\" tab. The new tab renders a native HTML/CSS **squarified treemap** layout, filling the entire viewport with proportionally-sized rectangles representing packages. This allows side-by-side comparison of both visualization approaches before deciding which to keep. All existing Mermaid code, tabs, and endpoints remain completely untouched.\n\n## Technical Approach\n\n### Layout Algorithm: Squarified Treemap\n\n**Why treemap?** The task requires \"maximum screen utilization — no wasted whitespace.\" Treemaps fill 100% of the available rectangle. Other options considered:\n- **CSS Grid / Flexbox**: Good for uniform layouts but dont allocate space proportionally. Lots of wasted space with unequal package sizes.\n- **Force-directed (JS)**: Good for relationship graphs with edges, but the package map is a hierarchy with no edges. Also leaves whitespace between nodes.\n- **Treemap**: Perfect fit. Fills all space, naturally represents hierarchies via nesting, sizes boxes proportionally.\n\n**Algorithm**: Squarified treemap (Bruls, Huizing, van Wijk 2000). Produces rectangles with aspect ratios close to 1:1 (squares), making labels readable. ~80 lines of vanilla JS — no external library needed.\n\n**Sizing metric**: Each packages area = `max(interfaces + types, 1)`. The `max(..., 1)` ensures intermediate directory nodes still get visible area.\n\n### Architecture: Server generates JSON data, client renders treemap\n\n1. **Server-side (Go)**: New function `PreparePackageMapData()` produces a JSON-serializable tree structure from `analyzer.Result`. Reuses the existing `pkgNode` tree-building logic (`insertNode`, `longestCommonPrefix`, etc.) but outputs data instead of Mermaid text.\n2. **Client-side (JS)**: Squarified treemap algorithm + DOM rendering inside the new tab panel. Responds to container resize via `ResizeObserver`.\n3. **Keep ALL existing Mermaid code**: `GeneratePackageMapMermaid()`, the \"Package Map\" tab, the `/mermaid.md` endpoint — all stay exactly as they are.\n\n### Key Design Decision: Two Tabs Side-by-Side\n- Existing \"Package Map\" tab (Mermaid) is **completely untouched**\n- New \"Package Map (html)\" tab is added as the second tab button\n- Tab order: `Package Map` | `Package Map (html)` | `Implementations` | `Interfaces`\n\n## Files to Create\n\nNone. All changes are modifications to existing files.\n\n## Files to Modify\n\n### 1. `goifaces/internal/diagram/filter.go`\n**What**: Add `PackageMapNodes` field to `InteractiveData` struct (line 33). Add new `PackageMapNode` type.\n\nNew type (add before `InteractiveData`):\n```go\ntype PackageMapNode struct {\n    Name       string            `json:\"name\"`\n    RelPath    string            `json:\"relPath\"`\n    PkgPath    string            `json:\"pkgPath\"`\n    Interfaces int               `json:\"interfaces\"`\n    Types      int               `json:\"types\"`\n    Value      int               `json:\"value\"`\n    Children   []*PackageMapNode `json:\"children,omitempty\"`\n}\n```\n\nAdd field to `InteractiveData` (line 38, before `RepoAddress`):\n```go\nPackageMapNodes []*PackageMapNode `json:\"packageMapNodes,omitempty\"`\n```\n\n### 2. `goifaces/internal/diagram/slides.go`\n**What**: Add new exported function `PreparePackageMapData()` that reuses existing tree-building code (`insertNode`, `longestCommonPrefix`, `pkgNode`, etc.) but converts the `pkgNode` tree to `[]*PackageMapNode` instead of Mermaid text. Add it after `GeneratePackageMapMermaid()` (after line 246).\n\nNew function signature:\n```go\nfunc PreparePackageMapData(result *analyzer.Result) []*PackageMapNode\n```\n\nLogic:\n1. Aggregate per-package stats (same pattern as lines 173-189 of `GeneratePackageMapMermaid`)\n2. Sort and strip common prefix (same pattern as lines 196-207)\n3. Build `pkgNode` tree (same pattern as lines 210-218)\n4. New recursive conversion function: `convertTree(*pkgNode) []*PackageMapNode`\n5. Compute `Value` field: for leaves, `max(interfaces+types, 1)`; for parents, sum of children values\n\nThe existing `GeneratePackageMapMermaid()` and ALL its helpers remain completely unchanged.\n\n### 3. `goifaces/main.go`\n**What**: Call `PreparePackageMapData()` and set the result on `interactiveData`. Add one line after line 169 (after `interactiveData.RepoAddress = input`):\n\n```go\ninteractiveData.PackageMapNodes = diagram.PreparePackageMapData(result)\n```\n\n### 4. `goifaces/internal/server/server.go`\nThis is where the bulk of changes happen — all within the existing HTML template string and the `ServeInteractive()` function.\n\n#### 4a. Template data struct (line 682): Add `PackageMapJSON` field\n```go\ntype interactiveData struct {\n    PackageMapMermaid string\n    DataJSON          template.JS\n    PackageMapJSON    template.JS  // NEW\n    RepoAddress       string\n}\n```\n\nIn `ServeInteractive()` (after line 708), JSON-marshal `data.PackageMapNodes` and assign to `templateData.PackageMapJSON`:\n```go\npkgMapBytes, err := json.Marshal(data.PackageMapNodes)\nif err != nil {\n    return fmt.Errorf(\"marshaling package map data: %w\", err)\n}\n```\nThen in `templateData` construction (line 710), add:\n```go\nPackageMapJSON: template.JS(pkgMapBytes),\n```\n\n#### 4b. HTML: Add new tab button (after line 285)\nInsert after the existing Package Map button:\n```html\n\u003cbutton class=\"tab-btn\" data-tab=\"pkgmap-html\"\u003ePackage Map (html)\u003c/button\u003e\n```\n\n#### 4c. HTML: Add new tab panel (after line 304, after `panel-pkgmap` closing `\u003c/div\u003e`)\n```html\n\u003c!-- Package Map HTML tab --\u003e\n\u003cdiv class=\"tab-panel full-width\" id=\"panel-pkgmap-html\"\u003e\n  \u003cdiv class=\"treemap-viewport\" id=\"pkgmap-html-viewport\"\u003e\n    \u003cdiv class=\"treemap-container\" id=\"pkgmap-html-container\"\u003e\u003c/div\u003e\n  \u003c/div\u003e\n\u003c/div\u003e\n```\n\nThe `full-width` class makes it fill edge-to-edge like the existing Mermaid tab (CSS at line 157).\n\n#### 4d. CSS: Add treemap styles (before `\u003c/style\u003e` closing tag at line 279)\n```css\n/* Treemap (HTML Package Map) */\n.treemap-viewport {\n  flex: 1;\n  overflow: hidden;\n  padding: 0.5rem;\n  position: relative;\n}\n.treemap-container {\n  width: 100%;\n  height: 100%;\n  position: relative;\n  transform-origin: top left;\n  transition: transform 0.2s ease;\n}\n.treemap-node {\n  position: absolute;\n  overflow: hidden;\n  border: 1px solid rgba(0,0,0,0.15);\n  border-radius: 3px;\n  display: flex;\n  flex-direction: column;\n  justify-content: center;\n  align-items: center;\n  text-align: center;\n  cursor: default;\n  transition: border-color 0.15s;\n}\n.treemap-node:hover {\n  border-color: rgba(0,0,0,0.5);\n  z-index: 10;\n}\n.treemap-node .tm-name {\n  font-weight: 600;\n  font-size: 0.85rem;\n  line-height: 1.2;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n  max-width: 95%;\n}\n.treemap-node .tm-stats {\n  font-size: 0.7rem;\n  opacity: 0.7;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n  max-width: 95%;\n}\n.treemap-group {\n  position: absolute;\n  overflow: hidden;\n  border: 2px solid rgba(0,0,0,0.2);\n  border-radius: 4px;\n}\n.treemap-group-label {\n  position: absolute;\n  top: 0; left: 0; right: 0;\n  padding: 2px 6px;\n  font-size: 0.7rem;\n  font-weight: 600;\n  background: rgba(0,0,0,0.06);\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  z-index: 1;\n}\n.treemap-tooltip {\n  position: fixed;\n  padding: 6px 10px;\n  background: #333;\n  color: #fff;\n  font-size: 0.75rem;\n  border-radius: 4px;\n  pointer-events: none;\n  z-index: 100;\n  white-space: nowrap;\n  box-shadow: 0 2px 8px rgba(0,0,0,0.2);\n}\n```\n\n**Dark mode overrides** (add inside the existing `@media (prefers-color-scheme: dark)` block at line 38):\n```css\n.treemap-node {\n  border-color: rgba(255,255,255,0.12);\n}\n.treemap-node:hover {\n  border-color: rgba(255,255,255,0.4);\n}\n.treemap-group {\n  border-color: rgba(255,255,255,0.15);\n}\n.treemap-group-label {\n  background: rgba(255,255,255,0.08);\n}\n.treemap-tooltip {\n  background: #555;\n}\n```\n\nNote: The treemap node fill colors (from `pastelPalette`) will need darkened variants in dark mode. Apply `filter: brightness(0.55) saturate(1.2)` on `.treemap-node` and `.treemap-group` in dark mode, which converts the light pastels to suitable dark-mode fills while preserving color identity. The text color for treemap nodes should switch to `#e0e0e0` in dark mode.\n\n#### 4e. JavaScript: Squarified treemap algorithm + rendering\n\nAdd inside the IIFE (after the initial package map render block, ~line 448). Key components:\n\n1. **Data**: `var pkgMapData = {{.PackageMapJSON}};` — Inline the JSON tree data.\n\n2. **Squarify algorithm**: `function squarify(nodes, rect)` — Implements the squarified treemap algorithm:\n   - Sort nodes by value descending\n   - Iteratively place nodes in rows, choosing horizontal/vertical layout based on which produces better (closer to 1:1) aspect ratios\n   - Returns array of `{x, y, w, h, node}` positioned rectangles\n\n3. **Render function**: `function renderTreemap(container, nodes, rect, depth, colorIdx)` — Recursively renders the treemap:\n   - Leaf nodes: creates `div.treemap-node` with `span.tm-name` + `span.tm-stats`, colored from pastel palette\n   - Parent nodes: creates `div.treemap-group` with `div.treemap-group-label`, recursively renders children in sub-rectangle (minus header height ~18px)\n   - Sets `position: absolute` with `left/top/width/height` from algorithm output\n   - Hides labels when rectangles are too small (\u003c 30px height: hide stats; \u003c 20px: hide name)\n   - Attaches `mouseenter`/`mouseleave` events for tooltip\n\n4. **Layout function**: `function layoutTreemap()` — Reads `#pkgmap-html-viewport` dimensions, clears `#pkgmap-html-container`, calls squarify + renderTreemap.\n\n5. **Lazy rendering** — Only render when the tab is first activated. Add `var pkgMapHtmlRendered = false;` flag (like the existing `pkgMapRendered` flag at line 356).\n\n6. **ResizeObserver** on `#pkgmap-html-viewport` to call `layoutTreemap()` on size change (debounced at 150ms).\n\n7. **Pastel palette** — Same 10 colors as the Go-side `pastelPalette` (lines 142-153), as a JS array of `{fill, stroke, text}` objects.\n\n8. **Tooltip** — Create a single shared `div.treemap-tooltip` (hidden by default) appended to `document.body`. On `mouseenter` of any `.treemap-node`, show tooltip near cursor with: package full path, N interfaces, M types. On `mouseleave`, hide. On `mousemove`, reposition.\n\n9. **Cap nesting depth at 3** — Flatten deeper packages into the third level to avoid too-small sub-rectangles.\n\n#### 4f. Update `getActiveContainer()` (line 637)\nAdd case for the new tab:\n```js\nfunction getActiveContainer() {\n  if (currentTab === pkgmap) return document.getElementById(pkgmap-container);\n  if (currentTab === pkgmap-html) return document.getElementById(pkgmap-html-container);\n  if (currentTab === ifaces) return document.getElementById(ifaces-diagram-container);\n  return document.getElementById(impls-diagram-container);\n}\n```\n\n#### 4g. Update `switchTab()` function (line 418)\nAdd lazy-render trigger for the new tab:\n```js\nif (tab === pkgmap-html \u0026\u0026 !pkgMapHtmlRendered) {\n  layoutTreemap();\n  pkgMapHtmlRendered = true;\n}\n```\n\n#### 4h. Update \"Copy Source\" button (line 660)\nWhen `currentTab === pkgmap-html`, generate a text representation from the package map data instead of Mermaid source:\n```\ninternal/analyzer: 2 ifaces, 5 types\ninternal/server: 1 iface, 3 types\n...\n```\nAlso update the button title dynamically: set `title=\"Copy Package List\"` when on the HTML tab, `title=\"Copy Mermaid Source\"` otherwise. Do this in `switchTab()`.\n\n#### 4i. Keep `/mermaid.md` endpoint unchanged\nNo changes — it still serves Mermaid text for the original Package Map tab.\n\n## Dependencies\n\n- **No external packages**. The squarified treemap algorithm is vanilla JS within the template.\n- Internal dependency on `analyzer.Result` (unchanged).\n- `GeneratePackageMapMermaid()` is still called — no existing code removed.\n\n## Edge Cases and Error Handling\n\n1. **Empty result (no packages)**: Show a centered \"No packages found\" message in the treemap viewport.\n2. **Single package**: Treemap degenerates to a single rectangle filling the container. Works naturally.\n3. **Very many packages (50+)**: Small rectangles may not fit labels. Hide `.tm-stats` when height \u003c 30px, hide `.tm-name` when \u003c 20px. Tooltip on hover shows all info.\n4. **Very deep hierarchy (5+ levels)**: Cap nesting at 3 levels — flatten deeper packages into the third level.\n5. **Packages with 0 interfaces and 0 types**: Use `value = 1` so they are still visible.\n6. **Window resize**: `ResizeObserver` recalculates layout. Debounce at 150ms.\n7. **Dark mode**: Use CSS `@media (prefers-color-scheme: dark)` overrides with `filter: brightness(0.55) saturate(1.2)` on treemap nodes and lighter border/text colors.\n\n## Testing Strategy\n\n### Automated tests (in `goifaces/internal/integration_test.go`)\n\n1. **`TestPreparePackageMapData`** — Unit test for the new function:\n   - Multi-package input produces correct tree structure\n   - Values are computed correctly (sum of children for parents, max(ifaces+types, 1) for leaves)\n   - Common prefix is stripped\n   - Hierarchy is correctly nested\n\n2. **`TestPreparePackageMapDataEmpty`** — Empty result produces nil/empty slice.\n\n3. **`TestPreparePackageMapDataSinglePackage`** — Single package produces a single root node.\n\n4. **Existing tests pass unchanged** — All existing tests for `GeneratePackageMapMermaid()`, `TestPackageMapMultiPackage`, `TestPackageMapRelativePaths`, etc. must still pass since that code is untouched.\n\n### Manual verification\n\n1. Run `go run . \u003crepo-path\u003e` and open the browser\n2. Verify the \"Package Map\" (Mermaid) tab still works exactly as before\n3. Click \"Package Map (html)\" tab — verify treemap fills the viewport\n4. Verify packages are correctly labeled with name + counts\n5. Verify hover shows tooltip with full package path\n6. Verify zoom in/out/reset works on the new tab\n7. Verify window resize recalculates treemap layout\n8. Verify \"Copy Source\" copies text list on the HTML tab and Mermaid source on the Package Map tab\n9. Verify `/mermaid.md` endpoint still returns Mermaid source\n10. Verify Implementations and Interfaces tabs are unaffected\n11. Verify dark mode renders treemap with appropriate colors","status":"closed","priority":2,"issue_type":"feature","owner":"olesho@gmail.com","created_at":"2026-02-22T02:42:36.91479-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-22T08:31:16.076207-06:00","closed_at":"2026-02-22T08:31:16.076207-06:00","close_reason":"Implemented HTML treemap tab with squarified treemap algorithm, CSS styles, dark mode support, tooltips, resize handling. Tests added and passing. Code review issues fixed.","comments":[{"id":1,"issue_id":"test-loom-376","author":"Oleh Luchkiv","text":"FEEDBACK: Do NOT replace the existing 'Package Map' Mermaid tab. Instead, add a NEW tab called 'Package Map (html)' alongside it. The goal is to compare the Mermaid implementation vs the HTML/CSS treemap side-by-side, then decide which is better. Update the design accordingly — keep all existing Mermaid Package Map code/tab intact.","created_at":"2026-02-22T13:20:12Z"},{"id":2,"issue_id":"test-loom-376","author":"web-ui","text":"FEEDBACK: Instead of replcaing \"Package Map\" diagram completely, let's create an alternative tab \"Package Map (html)\". This way we can compare with the old implementation.","created_at":"2026-02-22T14:23:04Z"}]}
{"id":"test-loom-4uu","title":"Package Map blocks should be anchored to top-left while remaining flexible","description":"The treemap blocks in the Package Map tab are positioned somewhat arbitrarily. They should maintain their flexible sizing but be anchored/aligned to the top-left corner of the viewport, so the layout feels grounded rather than floating. Investigate the current squarify/render layout logic and adjust positioning so blocks grow from top-left outward.","status":"closed","priority":2,"issue_type":"task","owner":"olesho@gmail.com","created_at":"2026-02-27T09:20:39.957472-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-27T15:39:05.281941-06:00","closed_at":"2026-02-27T15:39:05.281941-06:00","close_reason":"Fixed: layoutTreemap computes content-appropriate height instead of full viewport. Blocks stay compact at top-left."}
{"id":"test-loom-5w0","title":"Fix sidebar height when both collapsible sections are collapsed","description":"When both Implementations and Interfaces sections are collapsed in the Structures tab sidebar, the entity-list container retains its full max-height, leaving a large empty area. The height should shrink to fit the collapsed content.","status":"closed","priority":2,"issue_type":"bug","owner":"olesho@gmail.com","created_at":"2026-02-25T08:10:30.859958-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-25T08:19:49.667271-06:00","closed_at":"2026-02-25T08:19:49.667271-06:00","close_reason":"Added align-self: flex-start to .entity-list so the sidebar shrinks to fit content when collapsible sections are collapsed."}
{"id":"test-loom-6oq","title":"Create initial git commit for goifaces","description":"Stage all project files and create the initial commit. Verify pre-commit hook runs lint + tests successfully. Do NOT commit logs/ or testdata/*/output.* files (gitignored).","status":"closed","priority":1,"issue_type":"task","owner":"olesho@gmail.com","created_at":"2026-02-19T09:05:44.018283-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T10:55:38.076036-06:00","closed_at":"2026-02-19T10:55:38.076036-06:00","close_reason":"Initial commit 9f31a3a created. Pre-commit hook verified lint + tests pass."}
{"id":"test-loom-6t1","title":"Implement input resolver package","description":"internal/resolver/resolver.go - resolves local dirs, sub-package paths, and GitHub URLs (git clone --depth=1) to analyzable directories","status":"closed","priority":2,"issue_type":"task","owner":"olesho@gmail.com","created_at":"2026-02-19T09:05:48.459913-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T09:05:52.258219-06:00","closed_at":"2026-02-19T09:05:52.258219-06:00","close_reason":"Implemented with local dir, GitHub URL clone, and go mod download"}
{"id":"test-loom-720","title":"Create Mermaid syntax verifier for CI and development","description":"Add a verification step that validates generated Mermaid code against Mermaid.js parser (not just mmdc CLI). Should catch syntax errors before serving to browser. Can use Node.js mermaid package or mmdc --parseOnly.","status":"closed","priority":1,"issue_type":"task","owner":"olesho@gmail.com","created_at":"2026-02-19T16:07:55.764085-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T16:11:04.387828-06:00","closed_at":"2026-02-19T16:11:04.387828-06:00","close_reason":"Closed"}
{"id":"test-loom-7r8","title":"Implement structured logging package","description":"internal/logging/logging.go - slog JSON handler with dual output (stderr + file), Setup function returning logger and cleanup","status":"closed","priority":2,"issue_type":"task","owner":"olesho@gmail.com","created_at":"2026-02-19T09:05:30.406814-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T09:05:35.054043-06:00","closed_at":"2026-02-19T09:05:35.054043-06:00","close_reason":"Implemented with slog JSONHandler and io.MultiWriter"}
{"id":"test-loom-85e","title":"Add expandable interface lists to Package Map (html) blocks","description":"In the 'Package Map (html)' tab, each treemap block that contains interfaces should be clickable to expand/collapse a list of its interfaces. Click a block → it 'unwinds' to show all interfaces in that package. Click again → it collapses back. This adds drill-down capability without leaving the treemap view.","design":"## Summary\n\nAdd click-to-expand functionality to the HTML treemap so that clicking a package block reveals a list of its interfaces and types. Clicking again (or clicking elsewhere) collapses the list back. This provides drill-down capability directly in the treemap view without navigating to another tab.\n\n## Technical Approach\n\n**Strategy: Client-side lookup via pkgPath cross-referencing**\n\nThe existing `data` variable (from `DataJSON`) already contains all interfaces and types with their `pkgName`. However, `pkgName` is the short package name (e.g., \"api\") which may not be unique across different packages (e.g., \"internal/api\" vs \"pkg/api\"). To reliably match treemap blocks to their interfaces/types, we add `pkgPath` (full Go import path) to `InteractiveInterface` and `InteractiveType`.\n\nOn the client side, we build lookup maps (`pkgPath → [interfaces]` and `pkgPath → [types]`) and when a treemap block is clicked, we look up its `d.pkgPath` to get the list. A floating overlay panel appears anchored near the clicked block showing the interface/type names.\n\n**Why this approach:**\n- Minimal Go-side changes (add one field to two structs)\n- No duplication of data in `PackageMapNode`\n- Overlay doesn't disrupt the treemap layout (no re-layout on click)\n- Can show rich info (method signatures) since it draws from the existing `data` object\n\n**UX design:**\n- Click a `.treemap-node` or `.treemap-group` → an overlay panel appears near the block listing interfaces and types\n- The clicked block gets a visual \"selected\" state (highlighted border)\n- Click the same block again OR click outside the overlay → collapse/dismiss\n- The overlay is scrollable if the list is long\n- Cursor changes to `pointer` to indicate clickability\n- Only blocks with `pkgPath` and at least one interface or type are clickable\n\n## Files to Modify\n\n### 1. `/goifaces/internal/diagram/filter.go`\n- Add `PkgPath string \\`json:\"pkgPath\"\\`` field to `InteractiveInterface` struct (after PkgName)\n- Add `PkgPath string \\`json:\"pkgPath\"\\`` field to `InteractiveType` struct (after PkgName)\n- In `PrepareInteractiveData()`: set `PkgPath: iface.PkgPath` when building `InteractiveInterface` (around line 88-94)\n- In `PrepareInteractiveData()`: set `PkgPath: typ.PkgPath` when building `InteractiveType` (around line 100-105)\n\n### 2. `/goifaces/internal/server/server.go`\n\n**CSS additions (after the `.treemap-tooltip` styles, around line 377):**\n- `.treemap-node[data-clickable]` — `cursor: pointer` to signal interactivity\n- `.treemap-node.tm-selected` — highlighted border style (e.g., `border: 2px solid #1976d2; box-shadow: 0 0 0 2px rgba(25,118,210,0.3)`)\n- `.treemap-overlay` — floating panel style:\n  - `position: absolute` (within the treemap-viewport)\n  - `background: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15)`\n  - `max-height: 300px; overflow-y: auto; min-width: 200px; max-width: 400px; z-index: 50`\n  - `padding: 8px 0`\n- `.treemap-overlay-header` — package name header inside the overlay\n- `.treemap-overlay-section` — \"Interfaces\" / \"Types\" section labels (small, bold, muted)\n- `.treemap-overlay-item` — individual interface/type name row, with hover highlight\n- Dark mode overrides for the overlay (background, border, text colors)\n\n**JS additions (inside the IIFE, after `layoutTreemap()` definition, around line 745):**\n\na) **Build lookup maps** (run once during init):\n```javascript\nvar pkgInterfaces = {};\nvar pkgTypes = {};\ndata.interfaces.forEach(function(iface) {\n  if (!pkgInterfaces[iface.pkgPath]) pkgInterfaces[iface.pkgPath] = [];\n  pkgInterfaces[iface.pkgPath].push(iface);\n});\ndata.types.forEach(function(t) {\n  if (!pkgTypes[t.pkgPath]) pkgTypes[t.pkgPath] = [];\n  pkgTypes[t.pkgPath].push(t);\n});\n```\n\nb) **Overlay state management:**\n- `var activeOverlay = null;` — tracks the currently open overlay element\n- `var selectedNode = null;` — tracks the currently selected treemap node\n\nc) **`showPackageOverlay(nodeEl, d)` function:**\n- Dismiss any existing overlay first\n- Look up `pkgInterfaces[d.pkgPath]` and `pkgTypes[d.pkgPath]`\n- If both are empty/undefined, return early (nothing to show)\n- Create a `.treemap-overlay` div\n- Add a header showing the package name (`d.relPath || d.name`)\n- If interfaces exist: add \"Interfaces\" section label, then list each interface name (short name without package prefix)\n- If types exist: add \"Types\" section label, then list each type name\n- Position the overlay near the clicked block (use `nodeEl.getBoundingClientRect()` relative to the viewport container)\n- Append to `#pkgmap-html-viewport` (so it scrolls with the treemap)\n- Mark `nodeEl` with `.tm-selected` class\n- Set `activeOverlay` and `selectedNode` references\n\nd) **`dismissOverlay()` function:**\n- Remove the overlay element from DOM\n- Remove `.tm-selected` from `selectedNode`\n- Reset `activeOverlay` and `selectedNode` to null\n\ne) **Modify `renderTreemap()` function:**\n- For both leaf nodes (line ~684) and self-nodes (line ~657): if `d.pkgPath` exists and `d.interfaces \u003e 0 || d.types \u003e 0`, set `data-clickable` attribute on the DOM element and add a click handler:\n  ```javascript\n  node.setAttribute('data-clickable', 'true');\n  node.addEventListener('click', function(e) {\n    e.stopPropagation();\n    if (selectedNode === node) {\n      dismissOverlay();\n    } else {\n      showPackageOverlay(node, d);\n    }\n  });\n  ```\n- For group labels: add click handler on the group-label div if the group itself is a package (has `pkgPath` and interfaces/types \u003e 0)\n\nf) **Click-outside-to-dismiss:**\n- Add a click listener on `#pkgmap-html-viewport` that calls `dismissOverlay()` if the click target is not inside the overlay or a clickable treemap node\n\ng) **Handle re-layout (resize):**\n- In the existing resize handler that calls `layoutTreemap()`, also call `dismissOverlay()` first to clean up stale overlay/selections\n\n**HTML additions (around line 402, in the pkgmap-html panel):**\n- No HTML changes needed — overlay is created dynamically via JS\n\n### 3. `/goifaces/internal/server/server_test.go`\n- Add test `TestTreemapClickableNodes`: assert the template contains `data-clickable` attribute, `cursor: pointer` CSS, and the `showPackageOverlay` function\n- Add test `TestTreemapOverlayCSS`: assert the template contains `.treemap-overlay` CSS class with key properties\n- Add test `TestTreemapPkgLookupMaps`: assert the template contains the `pkgInterfaces` and `pkgTypes` lookup map construction\n\n### 4. `/goifaces/internal/integration_test.go`\n- Update `TestPrepareInteractiveData` (if exists) or add a new test to verify that `InteractiveInterface.PkgPath` and `InteractiveType.PkgPath` are populated correctly from the analyzer result\n\n## Dependencies\n- No external packages needed\n- Depends on existing `data` (DataJSON) and `pkgMapData` (PackageMapJSON) being available in the client\n- The `pkgPath` field on `InteractiveInterface`/`InteractiveType` is a prerequisite for the client-side lookup\n\n## Edge Cases \u0026 Error Handling\n\n1. **Package with no interfaces or types** — don't add `data-clickable` or click handler; cursor stays default\n2. **Multiple clicks on same block** — toggle: first click opens, second click closes\n3. **Click a different block while one is open** — dismiss the old overlay, show the new one\n4. **Very long interface/type lists** — overlay has `max-height: 300px` with `overflow-y: auto` (scrollable)\n5. **Overlay positioning near viewport edges** — check if the overlay would go off-screen and flip it to the other side of the block if needed\n6. **Resize while overlay is open** — dismiss overlay (treemap re-renders, old positions are stale)\n7. **Group nodes that are also packages** — the self-node inside the group gets the click handler, not the group container itself (avoids interfering with tooltip behavior on the group)\n8. **`pkgPath` is empty or undefined** — skip (some intermediate directory nodes have no pkgPath)\n9. **Dark mode** — overlay should respect `prefers-color-scheme: dark` media query\n\n## Testing Strategy\n\n### Unit Tests (Go)\n- Verify `InteractiveInterface.PkgPath` and `InteractiveType.PkgPath` are correctly populated in `PrepareInteractiveData()` output\n- Template string assertions for new CSS classes and JS functions\n\n### Template Tests (server_test.go)\n- Assert `data-clickable` attribute is set in the renderTreemap function\n- Assert `.treemap-overlay` CSS exists\n- Assert `cursor: pointer` exists for clickable nodes\n- Assert `showPackageOverlay` and `dismissOverlay` functions exist\n- Assert `pkgInterfaces` and `pkgTypes` lookup maps are built\n\n### Manual Verification\n1. Run `goifaces` against a multi-package Go repo\n2. Switch to \"Package Map (html)\" tab\n3. Hover over blocks — cursor should be pointer for blocks with interfaces/types\n4. Click a block — overlay should appear showing interface and type names\n5. Click the same block — overlay should dismiss\n6. Click a different block — old overlay dismisses, new one appears\n7. Click outside the overlay — it dismisses\n8. Resize the window — overlay dismisses cleanly\n9. Test in dark mode — overlay should have appropriate colors\n10. Test with a package that has many interfaces — overlay should scroll","status":"closed","priority":2,"issue_type":"feature","assignee":"nova","owner":"olesho@gmail.com","created_at":"2026-02-24T16:12:00.44062-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-24T16:56:13.603426-06:00","closed_at":"2026-02-24T16:56:13.603426-06:00","close_reason":"Completed: added PkgPath to InteractiveInterface/InteractiveType, implemented clickable treemap overlay with CSS/JS, added tests and updated docs"}
{"id":"test-loom-86t","title":"Implement Mermaid diagram generator","description":"internal/diagram/mermaid.go - generates deterministic classDiagram syntax with sanitized IDs, method truncation, and sorted output","status":"closed","priority":1,"issue_type":"task","owner":"olesho@gmail.com","created_at":"2026-02-19T09:06:05.360739-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T09:06:09.108986-06:00","closed_at":"2026-02-19T09:06:09.108986-06:00","close_reason":"Implemented with deterministic sorting, relevant method filtering, and pointer-receiver labels"}
{"id":"test-loom-86w","title":"Treemap: child blocks overflow their parent group when min-width exceeds allocated space","description":"In Package Map (html), when child blocks have min-width larger than the allocated space (e.g. two children side-by-side in the narrow 'providers' group), they overflow outside the parent group box and overlap each other horizontally. Instead, when children don't fit side-by-side, they should stack vertically. The group height should grow to accommodate stacked children based on their content height (text + stats). This affects the renderTreemap() function in goifaces/internal/server/server.go. The squarify algorithm lays out children horizontally when the rect is wider than tall, but when the resulting widths are smaller than min-width (80px), the layout should switch to vertical stacking.","design":"## Summary\n\nChild blocks in the treemap overflow their parent group when the squarify algorithm allocates widths smaller than the CSS `min-width: 80px`. This happens when multiple children are laid out side-by-side in a narrow parent group (e.g., two children in a 120px-wide group each get ~36px rendered width after gaps, but CSS forces them to 80px, causing horizontal overlap). The fix detects this overflow condition after squarify runs and falls back to vertical stacking, where each child gets the full parent width and children are arranged top-to-bottom.\n\n## Technical Approach\n\n**Strategy: Post-squarify overflow detection with vertical-stack fallback**\n\nAfter `squarify()` returns positioned rectangles, check if any child's rendered width (`p.w - 2 * TREEMAP_GAP`) is less than the min-width constant (80px). If so, discard the squarify result and use a simple vertical stacking layout instead. This keeps squarify as the primary algorithm for normal cases and only activates the fallback when overflow would occur.\n\n**Why this approach:**\n- Minimal change to existing layout logic — squarify still handles the common case\n- Deterministic: the check is simple and predictable\n- Since `.treemap-group` already has `overflow: visible`, vertically stacked children that exceed the group height will still be visible rather than clipped\n\n**Trade-offs considered:**\n- Alternative: Modify the squarify algorithm itself to enforce min-width constraints — rejected because it would significantly complicate the algorithm and break the standard squarify contract\n- Alternative: Use CSS flexbox/grid for child layout — rejected because the treemap uses absolute positioning throughout, and mixing layout modes would be complex\n\n## Files to Modify\n\n### 1. `goifaces/internal/server/server.go` (lines ~607-706 in the JS template)\n\n**a. Add constant** near `TREEMAP_GAP` (line 607):\n```javascript\nvar MIN_NODE_WIDTH = 80;\n```\n\n**b. Add `verticalStack()` function** (after `squarify` and `worstRatio`, before `flattenTree`):\n```javascript\nfunction verticalStack(nodes, rect) {\n  var total = 0;\n  for (var i = 0; i \u003c nodes.length; i++) total += nodes[i].value;\n  if (total \u003c= 0) return [];\n\n  var minChildH = 2 * TREEMAP_GAP + 36; // gap + min content height\n  var results = [];\n  var y = rect.y;\n\n  for (var i = 0; i \u003c nodes.length; i++) {\n    var fraction = total \u003e 0 ? nodes[i].value / total : 1 / nodes.length;\n    var h = Math.max(minChildH, rect.h * fraction);\n    results.push({\n      data: nodes[i],\n      x: rect.x,\n      y: y,\n      w: rect.w,\n      h: h\n    });\n    y += h;\n  }\n  return results;\n}\n```\n\nEach child gets the full `rect.w` and at least `minChildH` (60px) or its proportional share of height (whichever is larger). If total stacked height exceeds `rect.h`, children remain visible via the parent's `overflow: visible`.\n\n**c. Add overflow detection in `renderTreemap()`** (after line 618, the `squarify` call):\n```javascript\nvar positioned = squarify(nodes, rect);\n\n// If any child would be narrower than MIN_NODE_WIDTH, fall back to vertical stacking\nvar needsVerticalStack = false;\nfor (var i = 0; i \u003c positioned.length; i++) {\n  if (positioned[i].w - 2 * TREEMAP_GAP \u003c MIN_NODE_WIDTH) {\n    needsVerticalStack = true;\n    break;\n  }\n}\nif (needsVerticalStack) {\n  positioned = verticalStack(nodes, rect);\n}\n```\n\n### 2. `goifaces/internal/server/server_test.go`\n\nAdd a test to verify the overflow-detection logic exists in the template:\n```go\nfunc TestTreemapVerticalStackFallback(t *testing.T) {\n    // The renderTreemap function must detect when squarify produces\n    // children narrower than MIN_NODE_WIDTH and fall back to vertical stacking.\n    assert.Contains(t, interactiveHTMLTemplate, \"MIN_NODE_WIDTH\",\n        \"template should define MIN_NODE_WIDTH constant\")\n    assert.Contains(t, interactiveHTMLTemplate, \"verticalStack\",\n        \"template should contain verticalStack fallback function\")\n    assert.Contains(t, interactiveHTMLTemplate, \"needsVerticalStack\",\n        \"template should check for overflow and trigger vertical stacking\")\n}\n```\n\n## Files to Create\n\nNone.\n\n## Dependencies\n\nNo external packages needed. This is a pure JS change within the existing HTML template.\n\n## Edge Cases \u0026 Error Handling\n\n1. **Single child in group**: Won't trigger overflow (gets full width from squarify). No change in behavior.\n2. **All children are leaves**: Vertical stack assigns full width + proportional/minimum height to each. Text remains readable.\n3. **Mix of leaf and group children**: Groups in the vertical stack get full width, so their own children will have adequate horizontal space for their squarify layout.\n4. **Parent itself is very narrow (\u003c MIN_NODE_WIDTH)**: Children still get full parent width. They may be narrow but that's inherent to the container size — the fallback prevents overlap, not inherent narrowness.\n5. **Zero or negative rect dimensions**: The existing `Math.max(0, ...)` guards handle this. `verticalStack` returns empty for total \u003c= 0.\n6. **Deep nesting**: Each recursive level independently checks for overflow, so narrow groups at any depth trigger the fallback.\n\n## Testing Strategy\n\n**Automated tests:**\n- Add `TestTreemapVerticalStackFallback` to verify the template contains the overflow-detection code (MIN_NODE_WIDTH constant, verticalStack function, needsVerticalStack check)\n\n**Manual verification:**\n1. Run the goifaces server against a repo with packages that produce a narrow group with multiple children (e.g., a package with 2-3 subpackages where the parent is a small slice of the treemap)\n2. Verify children stack vertically instead of overlapping horizontally\n3. Verify that wider groups still use the normal squarify layout (no regression)\n4. Test at different viewport sizes to confirm the behavior adapts","status":"closed","priority":1,"issue_type":"bug","assignee":"falcon","owner":"olesho@gmail.com","created_at":"2026-02-24T15:38:23.583322-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-24T15:53:24.918827-06:00","closed_at":"2026-02-24T15:53:24.918827-06:00","close_reason":"Completed with tests and code review. Added verticalStack fallback with height scaling."}
{"id":"test-loom-873","title":"Mermaid syntax error in browser - Unicode sanitization chars not supported by Mermaid.js v11","description":"The sanitizeSignature() function in internal/diagram/mermaid.go replaces {}\u003c\u003e with Unicode alternatives (⦃⦄ᐊ‹›) that pass mmdc CLI rendering but fail in browser Mermaid.js v11.12.3. Need to use only ASCII-safe replacements that work in both contexts.","status":"closed","priority":1,"issue_type":"bug","owner":"olesho@gmail.com","created_at":"2026-02-19T15:48:38.349512-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T16:11:04.294301-06:00","closed_at":"2026-02-19T16:11:04.294301-06:00","close_reason":"Closed"}
{"id":"test-loom-944","title":"Replace Overview slide with package map visualization","description":"Replace the first 'Overview' slide with a visualization showing the map of all packages in the repository. Each package may contain subpackages (nested). Use a different Mermaid chart type suitable for hierarchical package visualization. The existing detail slides (split into many slides showing interfaces/implementations) should remain unchanged.","design":"## Summary\n\nReplace the Overview slide (slide 0) with a Package Map visualization that shows the hierarchical structure of all Go packages in the analyzed repository. Currently, the overview slide shows a classDiagram with only interface nodes and embedding arrows. The new package map will use a Mermaid flowchart with nested subgraphs to represent the package tree, giving users an at-a-glance understanding of the project's package organization and where interfaces and types live. The existing detail slides (interface+implementation diagrams split by hub-and-spoke) remain unchanged.\n\n## Technical Approach\n\n**Mermaid chart type:** `flowchart TD` (top-down) with nested subgraphs. This is the most natural and well-supported Mermaid representation for hierarchical data. Each package becomes a `subgraph` labeled with its short name, and nested packages become nested subgraphs. Leaf/inner packages with interfaces or types get an info node showing counts (e.g., \"3 interfaces · 5 types\").\n\n**Key design decisions:**\n- Use `flowchart TD` instead of `classDiagram` — subgraphs naturally represent package containment\n- Strip the module path prefix to show only relative package paths (e.g., `internal/analyzer` instead of `github.com/foo/bar/internal/analyzer`)\n- Build an in-memory package tree from `PkgPath` strings, filling in intermediate nodes that may not directly contain types\n- Show interface/type counts per package as info nodes within subgraphs\n- Style subgraphs with the existing blue color scheme for visual consistency\n\n**Trade-offs:**\n- Flowchart subgraphs vs block-beta: Flowchart subgraphs are more mature and widely supported in Mermaid v11. Block-beta is newer but less tested.\n- Showing counts vs individual type names: Counts keep the map clean and readable. Individual names would create visual clutter — that's what the detail slides are for.\n- Mermaid subgraph nesting depth: Works well for typical Go projects (2-4 levels). Very deep nesting (5+) may render awkwardly, but this is rare in practice.\n\n## Files to Create\n\n### `goifaces/internal/diagram/pkgmap.go`\nNew file containing the package map generation logic:\n- `type pkgNode struct` — tree node: name, full path, children map, interface count, type count\n- `func buildPackageTree(result *analyzer.Result) *pkgNode` — extracts unique PkgPaths from interfaces and types, strips common module prefix, builds tree\n- `func generatePackageMapMermaid(result *analyzer.Result, opts DiagramOptions) string` — renders the package tree as a Mermaid `flowchart TD` with nested subgraphs\n- Helper: `func longestCommonPathPrefix(paths []string) string` — finds module path to strip\n- Helper: `func renderSubgraph(b *strings.Builder, node *pkgNode, depth int)` — recursive subgraph renderer\n\nThe flowchart output will look like:\n```\nflowchart TD\n    subgraph root[\"mymodule\"]\n        subgraph internal_sg[\"internal\"]\n            subgraph analyzer_sg[\"analyzer\"]\n                analyzer_info[\"3 interfaces · 5 types\"]\n            end\n            subgraph diagram_sg[\"diagram\"]\n                diagram_info[\"1 interface\"]\n                subgraph split_sg[\"split\"]\n                    split_info[\"1 interface · 1 type\"]\n                end\n            end\n        end\n    end\n```\n\nSubgraph IDs use `{sanitizedPkgName}_sg` pattern to avoid collisions with existing node ID conventions. Info nodes use `{sanitizedPkgName}_info`.\n\nFor packages with no direct types/interfaces (pure organizational packages), no info node is rendered — they appear as empty subgraphs containing only their children.\n\n### `goifaces/internal/diagram/pkgmap_test.go`\nUnit tests for the package tree building and rendering:\n- `TestBuildPackageTree` — verifies tree structure from sample PkgPaths\n- `TestLongestCommonPathPrefix` — edge cases: single package, no common prefix, identical paths\n- `TestGeneratePackageMapMermaid` — verifies Mermaid output contains expected subgraphs and info nodes\n\n## Files to Modify\n\n### `goifaces/internal/diagram/slides.go`\n**Lines 45-49:** Replace the `generateOverviewMermaid` call with `generatePackageMapMermaid`:\n```go\n// Slide 0: package map — hierarchical view of all packages\nslides = append(slides, Slide{\n    Title:   \"Package Map\",\n    Mermaid: generatePackageMapMermaid(result, diagOpts),\n})\n```\n\n**Lines 108-215:** Remove the entire `generateOverviewMermaid` function and `collectEmbeddingArrows` function. These are only used for the old overview slide and will be replaced by the new pkgmap.go code.\n\n### `goifaces/internal/integration_test.go`\n**`TestHubAndSpokeSlides` (line 328):**\n- Change `assert.Equal(t, \"Overview\", slides[0].Title)` to `assert.Equal(t, \"Package Map\", slides[0].Title)`\n- Update assertions about overview content: instead of checking for interface nodes and embedding arrows, check for flowchart subgraph markers (e.g., `subgraph`, package names)\n- Keep the assertion that impl types don't appear (they shouldn't be in the package map either)\n- Keep the detail slide assertions unchanged\n\n**`TestOverviewInterfaceEmbedding` (line 449):**\nRewrite this test as `TestPackageMapSlide`:\n- Create a synthetic Result with types in multiple packages (e.g., `example.com/app/models`, `example.com/app/handlers`, `example.com/app/handlers/middleware`)\n- Verify the package map slide contains subgraphs for each package level\n- Verify package counts are shown correctly\n- Verify the flowchart chart type is used (contains \"flowchart\")\n- Verify no classDiagram artifacts appear\n\n### `goifaces/docs/architecture.md`\n**Line 62 (internal/diagram section):** Update the description of the overview slide:\n- Change \"The overview (first) slide shows only interface nodes with interface→interface embedding/extension arrows\" to \"The overview (first) slide shows a Package Map — a hierarchical flowchart visualization of all Go packages using nested subgraphs, with interface/type counts per package\"\n\n## Dependencies\n\n- No new external packages needed\n- Internal: `analyzer.Result` (existing), `DiagramOptions` (existing)\n- The `go/types` import in slides.go can be removed since `collectEmbeddingArrows` (which uses it) is being deleted\n\n## Edge Cases \u0026 Error Handling\n\n1. **Single package (no nesting):** If all types are in one package, render a single subgraph with an info node. No nested subgraphs needed.\n2. **No types/interfaces found:** Return a minimal `flowchart TD` with just \"No packages found\" text node. (This case is already handled upstream — the pipeline exits early if result is empty.)\n3. **Very deep nesting (5+ levels):** Mermaid handles this, though rendering may be less ideal. No special handling needed — Go projects rarely exceed 4 levels.\n4. **Packages with identical short names (e.g., `foo/bar` and `baz/bar`):** Node IDs must be unique. Use the full relative path (sanitized) as the subgraph ID, not just the short name.\n5. **Module prefix stripping:** If all types share a common module prefix (e.g., `github.com/user/repo`), strip it. If only one package exists, use just its short name. If packages come from different modules (e.g., stdlib included), find the longest common prefix at `/` boundaries.\n6. **Empty intermediate packages:** Packages like `internal/` that have no direct types but contain subpackages should still appear as subgraph containers.\n7. **Special characters in package names:** Already handled by existing `sanitizeID` function (replaces `/`, `.`, `-` with `_`).\n\n## Testing Strategy\n\n### Unit Tests (pkgmap_test.go)\n1. **TestBuildPackageTree:** Verify tree building from various PkgPath inputs:\n   - Multiple packages at different depths\n   - Single package (flat)\n   - Packages with shared prefixes\n2. **TestLongestCommonPathPrefix:** Test edge cases:\n   - Empty input → empty string\n   - Single path → the path itself up to last segment\n   - Two paths with partial overlap\n   - Identical paths\n3. **TestGeneratePackageMapMermaid:**\n   - Verify output starts with \"flowchart TD\"\n   - Verify subgraph nesting matches package hierarchy\n   - Verify info nodes contain correct counts\n   - Verify sanitized IDs are used\n\n### Integration Tests (integration_test.go)\n4. **TestHubAndSpokeSlides (updated):** Verify package map is slide 0 with correct title\n5. **TestPackageMapSlide (new):** End-to-end test with multi-package synthetic data\n\n### Manual Verification\n6. Run `bash scripts/visual-verify.sh` after implementation\n7. Run the tool on a real Go project and verify the package map renders correctly in the browser","status":"closed","priority":2,"issue_type":"feature","owner":"olesho@gmail.com","created_at":"2026-02-21T08:07:36.726755-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-21T08:13:08.281729-06:00","closed_at":"2026-02-21T08:13:08.281729-06:00","close_reason":"Replaced Overview slide with Package Map flowchart showing package hierarchy with interface/type counts"}
{"id":"test-loom-9q0","title":"Show only interfaces and relations on the first (overview) slide","description":"The first Mermaid chart, titled 'Overview', currently shows interfaces, implementations, and all details. It should instead be a unified map showing ONLY interfaces and their relations (dependency arrows between interfaces). No implementation blocks, no method bodies — just the interface nodes and how they connect. Only modify the 'Overview' chart; the chunked slides that follow should keep their current detail level.","design":"## Summary\n\nThe overview (first) slide currently shows ALL nodes (interfaces and implementations) with empty class bodies plus all type→interface relation arrows. This task changes the overview to show ONLY interface nodes and interface→interface embedding/extension arrows, producing a clean architectural map. Implementation blocks and implementation arrows are omitted entirely from the overview — they remain on the detail slides that follow.\n\n## Technical Approach\n\nThe change is localized to `generateOverviewMermaid()` in `internal/diagram/slides.go`. The function already has special logic for the overview (no method bodies). We extend this by:\n\n1. **Removing type/implementation blocks** — Delete the entire section that renders type class blocks (lines 168-177 in current code).\n2. **Replacing type→interface relations with interface→interface embedding arrows** — Instead of iterating `result.Relations` (which are type→interface), detect interface embedding using each `InterfaceDef.TypeObj` (`*types.Interface`). The `NumEmbeddeds()` and `EmbeddedType(i)` methods from Go's `go/types` package reveal which interfaces embed other interfaces.\n3. **Using a different arrow style** — Implementation uses `..|\u003e` (dashed + triangle). Interface embedding/extension should use `--|\u003e` (solid + triangle), following UML convention for inheritance/extension.\n4. **Handling nil TypeObj** — Synthetic test data may have nil `TypeObj`. When nil, skip embedding detection for that interface (no arrows drawn from it).\n5. **Removing implStyle** — Since no implementation blocks are rendered, remove `classDef implStyle` and its `cssClass` assignments from the overview output.\n\nIf a codebase has no interface embedding, the overview shows just the interface nodes (a useful \"table of contents\"). The detail slides remain unchanged.\n\n## Files to Modify\n\n### 1. `internal/diagram/slides.go` — `generateOverviewMermaid()`\n\n**Remove type blocks section (current lines ~168-177):**\n- Delete the loop that writes type class blocks\n- Delete the blank-line separator between interfaces and types\n\n**Replace relation rendering (current lines ~179-186):**\n- Remove the loop that writes `type ..|\u003e interface` arrows\n- Add new logic:\n  a. Build a lookup map: `pkgPath.Name → bool` for all interfaces in the result\n  b. For each interface with non-nil `TypeObj`, iterate `TypeObj.NumEmbeddeds()`\n  c. For each `TypeObj.EmbeddedType(i)`, check if it's a `*types.Named` whose `Obj().Pkg().Path() + \".\" + Obj().Name()` exists in the lookup\n  d. If so, write an embedding arrow: `childID --|\u003e parentID`\n  e. Sort embedding arrows deterministically\n\n**Remove implStyle references (current lines ~189-198):**\n- Remove `classDef implStyle ...` line from style definitions\n- Remove the loop that assigns `cssClass` to type nodes (since no type nodes exist)\n\n**Add a new helper function `writeEmbeddingRelation()`:**\n```go\nfunc writeEmbeddingRelation(b *strings.Builder, child, parent analyzer.InterfaceDef) {\n    childID := nodeID(child.PkgName, child.Name)\n    parentID := nodeID(parent.PkgName, parent.Name)\n    b.WriteString(fmt.Sprintf(\"    %s --|\u003e %s\", childID, parentID))\n}\n```\n\n### 2. `internal/integration_test.go` — `TestHubAndSpokeSlides`\n\n**Update overview assertions (around line 421-423):**\n- Keep the existing `assert.NotContains(t, overview, \"+\", \"overview should have no method lines\")` assertion\n- Add: overview should NOT contain any implementation node IDs (e.g., `memdb_BoolFieldIndex`, `memdb_FilterIterator`)\n- Add: overview should NOT contain `..|\u003e` arrows (implementation relations)\n- Add: overview SHOULD contain interface node IDs (`memdb_Indexer`, `memdb_MultiIndexer`, etc.)\n\n**Add a new test `TestOverviewInterfaceEmbedding`:**\n- Create synthetic data with 3 interfaces where one embeds the other two (like ReadCloser embedding Reader and Closer)\n- Use real `*types.Interface` objects (via `types.NewInterfaceType`) so `TypeObj` is populated\n- Verify the overview contains `--|\u003e` arrows between the embedding interface and its parents\n- Verify no implementation blocks or `..|\u003e` arrows appear\n\n### 3. `docs/architecture.md` — Update `internal/diagram` section\n\nUpdate the paragraph describing the diagram package to mention that the overview slide shows only interface nodes with embedding/extension arrows (`--|\u003e`), while detail slides show full interface+implementation diagrams with implementation arrows (`..|\u003e`).\n\n## Dependencies\n\n- No new external packages needed\n- Uses existing `go/types` stdlib for embedding detection (`types.Interface.NumEmbeddeds()`, `types.Interface.EmbeddedType()`)\n- No dependency on in-progress task test-loom-xf7 (that task modifies detail slide rendering in `mermaid.go`, not overview in `slides.go`)\n\n## Edge Cases \u0026 Error Handling\n\n1. **Nil TypeObj** — Synthetic test data or edge cases may have nil `TypeObj`. Skip embedding detection for these interfaces; they'll render as disconnected nodes.\n2. **Self-embedding** — Go doesn't allow it, but guard: skip if child == parent by key.\n3. **Embedded type is not *types.Named** — `EmbeddedType(i)` could return a non-Named type (e.g., type constraints in generics). Only process `*types.Named` types.\n4. **Embedded interface not in result set** — If an interface embeds a stdlib interface not in our result (e.g., `io.Reader`), skip the arrow since the parent node doesn't exist in the diagram.\n5. **No interfaces at all** — The overview renders just `classDiagram` with no nodes. This matches current behavior for empty results.\n6. **No embeddings** — Overview shows interface nodes with no arrows. This is correct — it serves as a table of contents.\n7. **Embedded type's Obj().Pkg() is nil** — Universe-scope types like `error` have nil Pkg(). Handle this by checking for nil before accessing `Pkg().Path()`.\n\n## Testing Strategy\n\n1. **Existing test `TestHubAndSpokeSlides`** — Update assertions for overview slide to verify no impl nodes and no `..|\u003e` arrows\n2. **New test `TestOverviewInterfaceEmbedding`** — Verify embedding arrows appear correctly using synthetic interface types\n3. **Manual verification** — Run on testdata/05_embedded_iface to verify ReadCloser → Reader and ReadCloser → Closer arrows appear in overview\n4. **Run `go test ./...`** — All existing tests must pass\n5. **Run `golangci-lint run ./...`** — No lint errors\n6. **Run `bash scripts/visual-verify.sh`** — Visual check of rendered SVGs","status":"closed","priority":2,"issue_type":"task","assignee":"nova","owner":"olesho@gmail.com","created_at":"2026-02-20T05:08:13.910905-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-20T09:31:21.174566-06:00","closed_at":"2026-02-20T09:31:21.174566-06:00","close_reason":"Completed: overview slide now shows only interface nodes with embedding arrows (--|\u003e). Implementation blocks, impl arrows (..|\u003e), and implStyle removed. Tests updated and new TestOverviewInterfaceEmbedding added."}
{"id":"test-loom-a0i","title":"Implement HTTP server with Mermaid.js rendering","description":"internal/server/server.go - serves HTML with Mermaid.js CDN v11, zoom controls, copy button, auto-browser-open, graceful shutdown","status":"closed","priority":2,"issue_type":"task","owner":"olesho@gmail.com","created_at":"2026-02-19T09:06:16.076028-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T09:06:19.490009-06:00","closed_at":"2026-02-19T09:06:19.490009-06:00","close_reason":"Implemented with dark/light mode, zoom, copy, and graceful shutdown"}
{"id":"test-loom-a8u","title":"Implement core analyzer package","description":"internal/analyzer/ - types.go (InterfaceDef, TypeDef, MethodSig, Relation, Result), analyzer.go (package loading via go/packages, interface/type collection, types.Implements matching), filter.go (stdlib/unexported/prefix filtering, orphan pruning)","status":"closed","priority":1,"issue_type":"task","owner":"olesho@gmail.com","created_at":"2026-02-19T09:05:39.671251-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T09:05:44.098826-06:00","closed_at":"2026-02-19T09:05:44.098826-06:00","close_reason":"Implemented with stdlib interface loading, error builtin handling, and all filtering"}
{"id":"test-loom-awi","title":"Add padding/margin between treemap blocks in Package Map (html) tab","status":"closed","priority":1,"issue_type":"bug","owner":"olesho@gmail.com","created_at":"2026-02-23T21:37:20.725919-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-23T21:38:53.995429-06:00","closed_at":"2026-02-23T21:38:53.995429-06:00","close_reason":"Fixed: increased TREEMAP_GAP from 2px to 4px"}
{"id":"test-loom-awj","title":"Mermaid syntax error when rendering go-memdb diagram in browser","description":"Running './goifaces https://github.com/hashicorp/go-memdb -port 8081' produces a Mermaid diagram that fails to render in the browser with 'Syntax error in text, mermaid version 11.12.3'. Need to investigate the generated Mermaid output for invalid syntax.","status":"closed","priority":1,"issue_type":"bug","owner":"olesho@gmail.com","created_at":"2026-02-19T15:38:56.242547-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T15:42:24.034549-06:00","closed_at":"2026-02-19T15:42:24.034549-06:00","close_reason":"Closed"}
{"id":"test-loom-ayh","title":"Run visual verification on all test diagrams","description":"Run 'bash scripts/visual-verify.sh' to render all testdata Mermaid outputs to SVG via mmdc. Then visually inspect each SVG to confirm diagrams match the input Go code. Prerequisite: npm install -g @mermaid-js/mermaid-cli","status":"closed","priority":2,"issue_type":"task","owner":"olesho@gmail.com","created_at":"2026-02-19T09:05:40.313985-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T16:47:39.122746-06:00","closed_at":"2026-02-19T16:47:39.122746-06:00","close_reason":"Closed"}
{"id":"test-loom-bnt","title":"Implement LLM-backed enrichers (iteration 2)","description":"Swap no-op default enrichers with LLM-backed implementations: 1) Semantic grouper - identify architectural layers 2) Pattern detector - recognize design patterns 3) Diagram simplifier - intelligent pruning 4) Annotator - add descriptions 5) Relationship scorer - rank by importance. All interfaces already defined in internal/enricher/.","design":"## Summary\n\nReplace the five no-op/mechanical default enrichers with LLM-backed implementations that provide semantic understanding of Go interface-implementation graphs. This transforms the enricher pipeline from purely syntactic (group-by-package, equal-weight scoring) to semantically intelligent (identify architectural layers, recognize design patterns, smart pruning, human-readable annotations, importance-based scoring). The LLM enrichers degrade gracefully to the existing defaults on failure.\n\n## Technical Approach\n\n### LLM Client Abstraction\n\nCreate a lightweight LLM client in \\`internal/enricher/llm/client.go\\` that speaks the **OpenAI-compatible chat completions API** (the most universal protocol — works with OpenAI, Anthropic via proxy, Ollama, vLLM, any OpenAI-compatible endpoint). No external SDK dependency — use stdlib \\`net/http\\` + \\`encoding/json\\`.\n\nThe client:\n- Takes an endpoint URL, API key, and model name via configuration\n- Sends chat completion requests with JSON mode (\\`response_format: {type: \"json_object\"}\\`)\n- Returns raw JSON string for each enricher to parse into its own typed response\n- Includes timeout, retries (1 retry on 5xx), and structured logging via \\`slog\\`\n\n### Configuration\n\nAdd a CLI flag \\`--enrich\\` (boolean, default false) to enable LLM enrichment. When enabled, read:\n- \\`GOIFACES_LLM_ENDPOINT\\` — API base URL (default: \\`https://api.openai.com/v1\\`)\n- \\`GOIFACES_LLM_API_KEY\\` — API key (required when --enrich is set)\n- \\`GOIFACES_LLM_MODEL\\` — model identifier (default: \\`gpt-4o-mini\\`)\n\nThese are env vars rather than flags because they contain secrets (API key) and rarely change between runs.\n\n### Enricher Implementations\n\nEach LLM enricher lives in a new file \\`internal/enricher/llm_\u003cname\u003e.go\\` (e.g., \\`llm_grouper.go\\`). Each:\n1. Implements the existing \\`Enricher\\` interface plus its domain-specific interface\n2. Takes a \\`*llm.Client\\` and the default enricher as constructor args\n3. Serializes the relevant parts of \\`analyzer.Result\\` into a focused prompt\n4. Parses the JSON response into the expected return type\n5. Falls back to the default enricher on any error (logs the failure at WARN level)\n\n#### 1. LLM Semantic Grouper (\\`llm_grouper.go\\`)\n\n**Prompt strategy:** Send a list of interfaces and types with their package paths, method signatures, and implementation relationships. Ask the LLM to identify architectural layers/domains (e.g., \"Data Access\", \"Business Logic\", \"HTTP Transport\", \"Domain Models\").\n\n**JSON response schema:**\n\\`\\`\\`json\n{\n  \"groups\": [\n    {\n      \"name\": \"Data Access Layer\",\n      \"interfaces\": [\"pkg.InterfaceName\"],\n      \"types\": [\"pkg.TypeName\"]\n    }\n  ]\n}\n\\`\\`\\`\n\n**Enrich behavior:** The \\`Enrich()\\` method returns the result unchanged (grouping is consumed separately by diagram generation). The \\`Group()\\` method returns the LLM-identified semantic groups.\n\n#### 2. LLM Pattern Detector (\\`llm_patterns.go\\`)\n\n**Prompt strategy:** Send the interface graph (interfaces with methods, types, which type implements which interface). Ask the LLM to identify GoF and Go-specific patterns (Strategy, Factory, Repository, Observer, Decorator, Adapter, etc.).\n\n**JSON response schema:**\n\\`\\`\\`json\n{\n  \"patterns\": [\n    {\n      \"name\": \"Strategy\",\n      \"description\": \"Multiple interchangeable algorithms behind a common interface\",\n      \"participants\": [\"pkg.Interface\", \"pkg.ImplA\", \"pkg.ImplB\"]\n    }\n  ]\n}\n\\`\\`\\`\n\n**Enrich behavior:** \\`Enrich()\\` returns result unchanged. \\`Detect()\\` returns detected patterns.\n\n#### 3. LLM Diagram Simplifier (\\`llm_simplifier.go\\`)\n\n**Prompt strategy:** When node count exceeds \\`maxNodes\\`, send the full graph and ask the LLM to identify the \\`maxNodes\\` most architecturally significant nodes to keep, preserving the most informative relationships. The LLM should prefer keeping hub interfaces and types that bridge different domains.\n\n**JSON response schema:**\n\\`\\`\\`json\n{\n  \"keep\": [\"pkg.Name1\", \"pkg.Name2\"]\n}\n\\`\\`\\`\n\n**Enrich behavior:** \\`Enrich()\\` uses the LLM to intelligently select which nodes to keep (rather than the default edge-count heuristic). \\`Simplify()\\` performs the actual filtering based on the LLM's selection.\n\n#### 4. LLM Annotator (\\`llm_annotator.go\\`)\n\n**Prompt strategy:** Send interfaces and types with their methods and relationships. Ask the LLM to generate concise (\u003c 80 char) human-readable descriptions for each, explaining their role/purpose.\n\n**JSON response schema:**\n\\`\\`\\`json\n{\n  \"annotations\": {\n    \"pkg.Name\": \"Brief description of purpose\"\n  }\n}\n\\`\\`\\`\n\n**Enrich behavior:** \\`Enrich()\\` returns result unchanged. \\`Annotate()\\` returns the annotation map.\n\n#### 5. LLM Relationship Scorer (\\`llm_scorer.go\\`)\n\n**Prompt strategy:** Send all relationships (type → interface pairs). Ask the LLM to score each by architectural importance (0.0–1.0), where core domain relationships score high and incidental implementations (e.g., implementing \\`error\\` or \\`fmt.Stringer\\`) score low.\n\n**JSON response schema:**\n\\`\\`\\`json\n{\n  \"scores\": {\n    \"0\": 0.9,\n    \"1\": 0.3\n  }\n}\n\\`\\`\\`\n\nKeys are string-encoded relation indices matching the input order.\n\n**Enrich behavior:** \\`Enrich()\\` returns result unchanged. \\`Score()\\` returns the weighted scores.\n\n### Result Serialization\n\nCreate a helper \\`internal/enricher/llm/serialize.go\\` that converts \\`analyzer.Result\\` into a compact text representation for prompts:\n- List interfaces: name, package, method signatures (truncated if \u003e10 methods)\n- List types: name, package, key methods\n- List relationships: \"TypeName implements InterfaceName\"\n- Keep total prompt size reasonable (estimate ~4K tokens for a medium project)\n\n### Wiring in main.go\n\nWhen \\`--enrich\\` is set:\n1. Create \\`llm.Client\\` from env vars\n2. Replace the enricher pipeline with LLM-backed enrichers:\n   \\`\\`\\`go\n   enrichers := []enricher.Enricher{\n       enricher.NewLLMGrouper(llmClient, enricher.NewDefaultGrouper()),\n       enricher.NewLLMSimplifier(llmClient, enricher.NewDefaultSimplifier()),\n   }\n   \\`\\`\\`\n3. Optionally run pattern detection and annotation as separate steps (their results feed into diagram generation, not the Result pipeline)\n\n### Error Handling \u0026 Fallback\n\nEvery LLM enricher wraps a default enricher. On any error:\n1. Log at WARN level with \\`component=enricher\\`, error details, and which enricher failed\n2. Return the default enricher's result\n3. Continue the pipeline — a single enricher failure does not abort the run\n\n### Token Budget\n\nEach enricher prompt is self-contained and focused. For a medium project (20 interfaces, 50 types, 100 relations):\n- Grouper prompt: ~2K tokens input, ~500 tokens output\n- Pattern detector: ~2K tokens input, ~500 tokens output\n- Simplifier: ~1.5K tokens input, ~200 tokens output\n- Annotator: ~2K tokens input, ~1K tokens output\n- Scorer: ~1K tokens input, ~500 tokens output\n\nTotal: ~12K tokens per run. With gpt-4o-mini at $0.15/1M input + $0.60/1M output, this costs ~$0.002 per run.\n\n## Files to Create\n\n1. **\\`internal/enricher/llm/client.go\\`** — LLM HTTP client (OpenAI-compatible chat completions, JSON mode, retries, timeout)\n2. **\\`internal/enricher/llm/serialize.go\\`** — Helper to serialize \\`analyzer.Result\\` into compact prompt text\n3. **\\`internal/enricher/llm/client_test.go\\`** — Unit tests for client with httptest mock server\n4. **\\`internal/enricher/llm_grouper.go\\`** — LLM-backed semantic grouper\n5. **\\`internal/enricher/llm_patterns.go\\`** — LLM-backed pattern detector\n6. **\\`internal/enricher/llm_simplifier.go\\`** — LLM-backed intelligent simplifier\n7. **\\`internal/enricher/llm_annotator.go\\`** — LLM-backed annotator\n8. **\\`internal/enricher/llm_scorer.go\\`** — LLM-backed relationship scorer\n\n## Files to Modify\n\n1. **\\`main.go\\`** — Add \\`--enrich\\` flag, env var reading, conditional LLM enricher pipeline construction\n2. **\\`docs/architecture.md\\`** — Document the LLM enricher subsystem, client abstraction, fallback behavior\n3. **\\`docs/cli-reference.md\\`** — Document \\`--enrich\\` flag and required env vars\n4. **\\`internal/integration_test.go\\`** — Add integration test for LLM enricher pipeline (using mock HTTP server)\n\n## Dependencies\n\n- **No new external Go modules required** — uses stdlib \\`net/http\\` + \\`encoding/json\\` for the LLM client\n- Internal: depends on \\`internal/analyzer\\` (types), \\`internal/enricher\\` (interfaces)\n- External runtime: requires an OpenAI-compatible API endpoint when \\`--enrich\\` is enabled\n\n## Edge Cases \u0026 Error Handling\n\n1. **Missing API key with --enrich**: Print clear error message and exit (fail fast, don't silently fall back)\n2. **LLM returns malformed JSON**: Log warning, fall back to default enricher\n3. **LLM returns valid JSON but missing/extra fields**: Use what's available, ignore extras, fall back for missing\n4. **LLM timeout (default 30s per request)**: Log warning, fall back to default\n5. **LLM returns node keys that don't match any actual node**: Ignore unknown keys, only use valid references\n6. **Empty result (0 interfaces/types)**: Skip LLM calls entirely, return defaults immediately\n7. **Very large projects (\u003e100 types)**: Truncate the prompt by including only the most-connected nodes (pre-filter using edge count before sending to LLM)\n8. **Rate limiting (429)**: Respect Retry-After header, retry once, then fall back\n\n## Testing Strategy\n\n### Unit Tests\n- **\\`internal/enricher/llm/client_test.go\\`**: Test HTTP client against \\`httptest\\` mock server — success, timeout, 5xx retry, malformed response, JSON mode header\n- Each LLM enricher file gets table-driven tests with mock LLM responses (use a mock client interface)\n\n### Integration Tests\n- Add test in \\`internal/integration_test.go\\` that:\n  1. Starts a mock HTTP server returning canned LLM responses\n  2. Creates LLM enrichers pointed at the mock\n  3. Runs the full pipeline on testdata/01_single_iface\n  4. Asserts the enriched result has groups, patterns, annotations, scores\n  5. Tests fallback: mock returns 500, verify default enricher result is used\n\n### Manual Verification\n- Run \\`goifaces --enrich ./testdata/01_single_iface -output test.mmd\\` against a real LLM endpoint\n- Inspect logs for LLM request/response details at DEBUG level\n- Compare diagram output with and without \\`--enrich\\` flag","status":"closed","priority":4,"issue_type":"feature","assignee":"nova","owner":"olesho@gmail.com","created_at":"2026-02-19T09:05:44.690964-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-20T18:13:04.262044-06:00","closed_at":"2026-02-20T18:13:04.262044-06:00","close_reason":"Implemented all 5 LLM-backed enrichers with fallback, client abstraction, tests, and documentation"}
{"id":"test-loom-c29","title":"Package Map: remove \\n escape characters from package names","description":"Some package names in the Package Map display literal backslash-n sequences like 'schema\\n1 types', 'tools\\n2 types'. These \\n1, \\n2 characters are appearing in the rendered output. Investigate why these escape sequences are being inserted into package name labels and fix the generation so names render cleanly without any such characters.","design":"## Summary\n\nThe `formatPkgLabel` function in `goifaces/internal/diagram/slides.go` (line 256 on main) uses `fmt.Sprintf(\"%s\\\\n%s\", ...)` which produces the literal two-character sequence `\\n` in the output string. This is a Go string escaping issue: `\\\\n` in a Go double-quoted string is a backslash followed by the letter n, not a newline character. Mermaid does not interpret literal `\\n` as a line break, so labels like `schema\\n1 types` render with the backslash-n visible.\n\nThe fix is to replace `\\\\n` with `\u003cbr/\u003e` — the standard Mermaid mechanism for line breaks inside node labels that use the `[\"...\"]` (double-quote) syntax.\n\n## Technical Approach\n\n**Root cause:** In Go, `\"\\\\n\"` produces the literal string `\\n` (two chars). The Mermaid renderer treats this as plain text, not a line break. Mermaid flowchart nodes using `[\"...\"]` syntax support `\u003cbr/\u003e` for line breaks.\n\n**Fix:** Change the format string from `\"%s\\\\n%s\"` to `\"%s\u003cbr/\u003e%s\"`.\n\n**Why `\u003cbr/\u003e` over alternatives:**\n- Mermaid markdown strings (backtick syntax `[\"\\` ... \\`\"]`) support actual newlines, but switching the entire node syntax is a larger change and the current `[\"...\"]` syntax is used throughout `renderTree`.\n- `\u003cbr\u003e` also works but `\u003cbr/\u003e` is the self-closing XHTML form, which is more correct for SVG output (the rendering pipeline uses `mmdc` to produce SVG).\n- Actual `\\n` (newline character, i.e. `\"%s\\n%s\"` in Go) would break the Mermaid syntax since the node definition must be on a single line in the `[\"...\"]` form.\n\n## Files to Modify\n\n### 1. `goifaces/internal/diagram/slides.go` (line 256)\n\n**Change:** In `formatPkgLabel`, replace:\n```go\nreturn fmt.Sprintf(\"%s\\\\n%s\", name, strings.Join(parts, \", \"))\n```\nwith:\n```go\nreturn fmt.Sprintf(\"%s\u003cbr/\u003e%s\", name, strings.Join(parts, \", \"))\n```\n\nThis is the only code change needed. The function is called from `renderTree` which embeds the label in `[\"...\"]` Mermaid syntax. The `\u003cbr/\u003e` will be correctly interpreted by Mermaid as a line break.\n\n## Files to Create\n\nNone.\n\n## Dependencies\n\nNo new external dependencies. The fix uses standard Mermaid HTML syntax that is already supported.\n\n## Edge Cases \u0026 Error Handling\n\n1. **Packages with only a name (no stats):** Already handled — `formatPkgLabel` returns early with just the name when `s == nil` or when both counts are zero. No `\u003cbr/\u003e` is inserted.\n2. **Packages with only interfaces or only types:** Works correctly — only non-zero counts are appended, and `\u003cbr/\u003e` separates name from the stats line.\n3. **SVG rendering:** `\u003cbr/\u003e` is valid XHTML and renders correctly in SVG via `mmdc` (Mermaid CLI).\n4. **Mermaid quoting:** The `\u003cbr/\u003e` appears inside `[\"...\"]` which is standard Mermaid double-quote string syntax. HTML tags are supported within these strings.\n\n## Testing Strategy\n\n### 1. Update existing tests in `goifaces/internal/integration_test.go`\n\nThe existing `TestPackageMapMultiPackage` test asserts `Contains(pkgMap, \"2 ifaces\")` and `Contains(pkgMap, \"1 ifaces\")`. These assertions will still pass because the stats text itself is unchanged — only the separator between name and stats changes from `\\n` to `\u003cbr/\u003e`.\n\n### 2. Add a unit test for `formatPkgLabel` specifically\n\nAdd a new test `TestFormatPkgLabel` that verifies:\n- A label with stats produces `\"name\u003cbr/\u003eN ifaces, M types\"` (not `\"name\\nN ifaces, M types\"`)\n- A label with nil stats returns just the name\n- A label with only interfaces returns `\"name\u003cbr/\u003eN ifaces\"`\n- A label with only types returns `\"name\u003cbr/\u003eN types\"`\n\n### 3. Add a negative assertion\n\nIn the existing `TestPackageMapMultiPackage`, add:\n```go\nassert.NotContains(t, pkgMap, `\\n`, \"package map labels should not contain literal backslash-n\")\n```\n\n### 4. Visual verification\n\nRun `bash scripts/visual-verify.sh` after the fix and inspect the SVG output to confirm labels render on two lines without literal `\\n` characters.","status":"closed","priority":2,"issue_type":"bug","assignee":"nova","owner":"olesho@gmail.com","created_at":"2026-02-21T08:32:43.616112-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-21T09:10:27.468456-06:00","closed_at":"2026-02-21T09:10:27.468456-06:00","close_reason":"Fixed formatPkgLabel to use \u003cbr/\u003e instead of literal \\n for Mermaid line breaks. Added tests for all label formatting cases.","dependencies":[{"issue_id":"test-loom-c29","depends_on_id":"test-loom-944","type":"blocks","created_at":"2026-02-21T08:32:46.933414-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-c2a","title":"Unify Implementations \u0026 Interfaces into single Structures tab","description":"Merge the 'Implementations' and 'Interfaces' tabs into a single 'Structures' tab. The left sidebar should contain two foldable/collapsible lists (one for implementations, one for interfaces) instead of separate tab panels. Each foldable list gets its own All/Clear buttons. The diagram area shows a single Mermaid flowchart responding to selections from both lists (which is already the underlying behavior). All changes are in goifaces/internal/server/server.go (the embedded HTML template).","status":"closed","priority":2,"issue_type":"epic","owner":"olesho@gmail.com","created_at":"2026-02-25T07:35:57.430877-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-25T07:48:32.565149-06:00","closed_at":"2026-02-25T07:48:32.565149-06:00","close_reason":"All 6 child tasks completed. Implementations and Interfaces tabs unified into single Structures tab with collapsible sidebar sections."}
{"id":"test-loom-c2a.1","title":"Replace Implementations \u0026 Interfaces tab buttons with single Structures tab","description":"In server.go tab-bar HTML (line ~472): Replace the two buttons (data-tab='impls' and data-tab='ifaces') with a single button data-tab='structures' labeled 'Structures'. Update switchTab() to handle the new tab ID. The Package Map tab stays unchanged.","status":"closed","priority":2,"issue_type":"task","owner":"olesho@gmail.com","created_at":"2026-02-25T07:36:06.237791-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-25T07:42:16.522321-06:00","closed_at":"2026-02-25T07:42:16.522321-06:00","close_reason":"Replaced Implementations \u0026 Interfaces tab buttons with single Structures tab. Consolidated HTML panels, updated showPlaceholder/renderSelectionDiagram to single structures-mermaid element, updated getActiveContainer, added CSS for collapsible sidebar sections with dark mode support.","dependencies":[{"issue_id":"test-loom-c2a.1","depends_on_id":"test-loom-c2a","type":"parent-child","created_at":"2026-02-25T07:36:06.238723-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-c2a.2","title":"Build collapsible sidebar lists for Structures tab","description":"Create a new panel-structures tab panel with a single entity-list sidebar. Inside the sidebar, add two collapsible/foldable sections: 'Implementations' and 'Interfaces'. Each section has a clickable header that toggles visibility of its checkbox list. Use a CSS details/summary or a simple JS toggle with a chevron indicator. Both sections should be expanded by default. Checkboxes keep classes impl-cb and iface-cb so onSelectionChange() works unchanged.","status":"closed","priority":2,"issue_type":"task","owner":"olesho@gmail.com","created_at":"2026-02-25T07:36:07.112076-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-25T07:42:28.498837-06:00","closed_at":"2026-02-25T07:42:28.498837-06:00","close_reason":"All addressed in the same changeset as .1 — HTML panels, collapsible sections, per-section buttons, and diagram consolidation were implemented together.","dependencies":[{"issue_id":"test-loom-c2a.2","depends_on_id":"test-loom-c2a","type":"parent-child","created_at":"2026-02-25T07:36:07.112768-06:00","created_by":"Oleh Luchkiv"},{"issue_id":"test-loom-c2a.2","depends_on_id":"test-loom-c2a.1","type":"blocks","created_at":"2026-02-25T07:36:36.9498-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-c2a.3","title":"Add per-list All/Clear buttons to each collapsible section","description":"Each collapsible section (Implementations and Interfaces) needs its own All and Clear buttons placed in the section header area. The Implementations All/Clear only affects .impl-cb checkboxes; Interfaces All/Clear only affects .iface-cb checkboxes. Wire both to call onSelectionChange() after toggling. Remove or repurpose the old impls-all/impls-clear/ifaces-all/ifaces-clear buttons.","status":"closed","priority":2,"issue_type":"task","owner":"olesho@gmail.com","created_at":"2026-02-25T07:36:08.170349-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-25T07:42:28.500955-06:00","closed_at":"2026-02-25T07:42:28.500955-06:00","close_reason":"All addressed in the same changeset as .1 — HTML panels, collapsible sections, per-section buttons, and diagram consolidation were implemented together.","dependencies":[{"issue_id":"test-loom-c2a.3","depends_on_id":"test-loom-c2a","type":"parent-child","created_at":"2026-02-25T07:36:08.170975-06:00","created_by":"Oleh Luchkiv"},{"issue_id":"test-loom-c2a.3","depends_on_id":"test-loom-c2a.2","type":"blocks","created_at":"2026-02-25T07:36:37.029681-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-c2a.4","title":"Consolidate diagram rendering to single Structures panel","description":"The new panel-structures needs a single diagram-viewport with one Mermaid pre element (id='structures-mermaid') and one placeholder. Update renderSelectionDiagram() to render into this single element instead of duplicating across impls-mermaid and ifaces-mermaid. Update currentTab references and the active pre ID logic. The buildMermaid() and onSelectionChange() functions should work as-is since they already collect from both checkbox classes.","status":"closed","priority":2,"issue_type":"task","owner":"olesho@gmail.com","created_at":"2026-02-25T07:36:09.028258-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-25T07:42:28.502417-06:00","closed_at":"2026-02-25T07:42:28.502417-06:00","close_reason":"All addressed in the same changeset as .1 — HTML panels, collapsible sections, per-section buttons, and diagram consolidation were implemented together.","dependencies":[{"issue_id":"test-loom-c2a.4","depends_on_id":"test-loom-c2a","type":"parent-child","created_at":"2026-02-25T07:36:09.029243-06:00","created_by":"Oleh Luchkiv"},{"issue_id":"test-loom-c2a.4","depends_on_id":"test-loom-c2a.2","type":"blocks","created_at":"2026-02-25T07:36:37.109045-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-c2a.5","title":"Remove dead Implementations/Interfaces panel HTML, CSS, and JS","description":"Remove the old panel-impls and panel-ifaces HTML divs, their associated CSS rules, and any JS that references impls-diagram-container, ifaces-diagram-container, impls-mermaid, ifaces-mermaid, impls-placeholder, ifaces-placeholder, impls-list, ifaces-list. Clean up the entity-list-actions divs that were replaced by per-section buttons. Ensure no dead code remains.","status":"closed","priority":2,"issue_type":"task","owner":"olesho@gmail.com","created_at":"2026-02-25T07:36:10.201119-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-25T07:42:28.503911-06:00","closed_at":"2026-02-25T07:42:28.503911-06:00","close_reason":"All addressed in the same changeset as .1 — HTML panels, collapsible sections, per-section buttons, and diagram consolidation were implemented together.","dependencies":[{"issue_id":"test-loom-c2a.5","depends_on_id":"test-loom-c2a","type":"parent-child","created_at":"2026-02-25T07:36:10.201799-06:00","created_by":"Oleh Luchkiv"},{"issue_id":"test-loom-c2a.5","depends_on_id":"test-loom-c2a.3","type":"blocks","created_at":"2026-02-25T07:36:37.187252-06:00","created_by":"Oleh Luchkiv"},{"issue_id":"test-loom-c2a.5","depends_on_id":"test-loom-c2a.4","type":"blocks","created_at":"2026-02-25T07:36:37.268787-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-c2a.6","title":"Verify Structures tab with agentic browser","description":"Use agentic browser to verify: (1) Structures tab appears and is clickable, (2) Both foldable sections render with correct items, (3) Folding/unfolding works for each section independently, (4) All/Clear buttons work independently per section, (5) Selecting items from either or both lists updates the Mermaid diagram correctly, (6) Package Map tab still works, (7) No console errors.","status":"closed","priority":2,"issue_type":"task","owner":"olesho@gmail.com","created_at":"2026-02-25T07:36:10.955893-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-25T07:48:27.632466-06:00","closed_at":"2026-02-25T07:48:27.632466-06:00","close_reason":"All 12 browser verification checks passed: tab bar correct, collapsible sections work, per-section All/Clear buttons work independently, mixed selection renders diagram correctly, Package Map tab unaffected, no JS errors.","dependencies":[{"issue_id":"test-loom-c2a.6","depends_on_id":"test-loom-c2a","type":"parent-child","created_at":"2026-02-25T07:36:10.956462-06:00","created_by":"Oleh Luchkiv"},{"issue_id":"test-loom-c2a.6","depends_on_id":"test-loom-c2a.5","type":"blocks","created_at":"2026-02-25T07:36:37.350042-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-cmz","title":"Package Map: exclude external packages, use only local repo packages","description":"The Package Map visualization currently includes packages from github.com and other external dependencies. It should only show local packages from the repository being analyzed. Filter out any external/third-party packages and only display packages that belong to the analyzed codebase.","design":"## Summary\n\nThe Package Map visualization includes interfaces from external/third-party packages (e.g., github.com/stretchr/testify, golang.org/x/tools) because the analyzer collects interfaces from all imported packages without checking whether they belong to the analyzed module. This fix parses the module path from go.mod and uses it to filter out external packages at both collection time (in Analyze) and filtering time (in Filter), so only interfaces and types belonging to the local module appear in diagrams.\n\n## Technical Approach\n\n**Root cause:** In `analyzer.go:124-129`, the imports loop calls `collectFromScope` on every imported package's type scope, including external dependencies. The `Filter` function only excludes stdlib packages (via `isStdlib`), not third-party packages like `github.com/...`.\n\n**Solution:** Parse the module path from `go.mod` and filter at two levels:\n\n1. **Collection-time filtering (Analyze):** In the imports loop, skip any imported package whose PkgPath does NOT start with the module path. Stdlib packages are already handled separately via the IncludeStdlib flag. Since \\`packages.Load(\"./...\")\\` already loads ALL local packages, the imports loop only adds external interfaces — so gating it with a module-path prefix check is precise.\n\n2. **Filter-time filtering (Filter):** As defense-in-depth, add a module-path check in Filter that drops relations where the interface's PkgPath is neither local (module prefix) nor stdlib (when IncludeStdlib is set). This catches any edge cases where external interfaces leak through.\n\n3. **Module path propagation:** Read the module path once in Analyze and store it in Result. Filter reads it from Result. No changes needed to AnalyzeOptions or main.go.\n\n**Fallback:** If go.mod cannot be parsed (empty module path), skip module filtering and fall back to current behavior to avoid breaking anything.\n\n## Files to Modify\n\n### 1. `internal/analyzer/analyzer.go`\n- Add `readModulePath(dir string) string` helper function that reads `\u003cdir\u003e/go.mod` and extracts the `module` declaration using simple string parsing (no new dependencies needed — `golang.org/x/mod/modfile` is available as indirect dep but string parsing is simpler and sufficient)\n- At the start of `Analyze`, call `readModulePath(dir)` and log the result\n- Store the module path in the returned `Result.ModulePath`\n- In the imports loop (lines 124-129), add a guard: only call `collectFromScope` if `strings.HasPrefix(imp.PkgPath, modulePath)`. This filters out all external packages. Stdlib interfaces are already collected separately when IncludeStdlib is true (lines 31-38)\n- Add `\"os\"` to imports for `os.ReadFile`\n\n### 2. `internal/analyzer/types.go`\n- Add `ModulePath string` field to the `Result` struct\n\n### 3. `internal/analyzer/filter.go`\n- Add `isLocalPackage(pkgPath, modulePath string) bool` helper: returns true if modulePath is non-empty and pkgPath starts with modulePath\n- In Filter, after the stdlib check, add: if `result.ModulePath != \"\"` and the interface's PkgPath is not local and not stdlib → skip the relation\n- Propagate `result.ModulePath` to the filtered Result\n\n### 4. `internal/integration_test.go`\n- Add a new test case `12_external_deps` that verifies external package interfaces are excluded from the diagram\n- The test should:\n  1. Analyze a testdata dir containing Go code that imports an external package and implements its interfaces\n  2. Assert the diagram does NOT contain the external interface\n  3. Assert local interfaces still appear correctly\n\n### 5. `testdata/12_external_deps/` (new directory)\n- `go.mod`: `module example.com/testmod` with a require for a small external package (e.g., `github.com/stretchr/testify` or a simpler dep)\n- `main.go`: Define a local interface + type, and also a local type that satisfies an external interface (e.g., `fmt.Stringer` via stdlib, or define a struct with methods matching an external interface)\n- NOTE: For test simplicity, we can test with stdlib-as-proxy for external. The real fix is the module path check. Alternatively, create a mock scenario using synthetic Result data (similar to TestHubAndSpokeSlides) where external PkgPaths are manually set\n\n**Recommended test approach:** Use a synthetic/unit test (no testdata dir needed) that constructs a Result with mixed local and external interfaces, calls Filter, and asserts only local interfaces survive. This avoids needing real external deps in testdata. Add to `integration_test.go` alongside existing synthetic tests.\n\n### 6. `docs/architecture.md`\n- Update the `internal/analyzer (filter)` section to mention module-path filtering (external package exclusion)\n- Add a note about go.mod module path parsing in the `internal/analyzer` section\n\n## Dependencies\n\n- No new external packages needed. `go.mod` parsing uses simple string operations (`os.ReadFile` + `strings.Split` + `strings.HasPrefix`)\n- `golang.org/x/mod/modfile` is available as indirect dep but NOT needed for this simple parse\n\n## Edge Cases \u0026 Error Handling\n\n1. **go.mod not found or unparseable:** `readModulePath` returns empty string → all module-path filtering is skipped → current behavior preserved (no regression)\n2. **Module path with trailing slash:** `strings.HasPrefix` handles this correctly since Go module paths never end with `/`\n3. **Replace directives:** Replaced modules have their own module paths. If they're loaded by `./...`, their interfaces are collected in the main loop (not the imports loop). The imports loop guard only affects interfaces from imported packages, which are already separate from the local module\n4. **Multi-module repos:** `packages.Load(\"./...\")` respects the single module boundary defined by the go.mod in `dir`. Other modules in the repo are treated as external, which is correct\n5. **Vendor directory:** `go.mod` module path is still accurate regardless of vendoring mode\n6. **`builtin.error` interface:** Added at lines 132-150 with PkgPath \"builtin\". `isStdlib(\"builtin\")` returns true, so the stdlib filter already handles it. The new module-path filter won't affect it because `isStdlib` check runs first\n\n## Testing Strategy\n\n### Unit/Synthetic Tests (in integration_test.go)\n1. **TestExternalPackageFiltering:** Build a synthetic Result with:\n   - ModulePath: \"example.com/myapp\"\n   - Local interface: PkgPath \"example.com/myapp/store\", Name \"Repository\"\n   - External interface: PkgPath \"github.com/external/pkg\", Name \"Handler\"\n   - Local type: PkgPath \"example.com/myapp/impl\", Name \"SQLStore\"\n   - Relations: SQLStore→Repository (local), SQLStore→Handler (external)\n   - Call Filter → assert only the Repository relation survives\n   - Assert Handler interface is NOT in filtered result\n\n2. **TestReadModulePath:** Unit test for the go.mod parser:\n   - Valid go.mod → returns correct module path\n   - Missing go.mod → returns empty string\n   - Malformed go.mod → returns empty string\n\n3. **TestExternalImportsNotCollected:** Run Analyze on testdata/01_single_iface (which has no external deps) and verify Result.ModulePath is set correctly. This validates the plumbing without needing external deps.\n\n### Existing Tests\n- All existing tests should continue to pass unchanged since testdata modules have no external deps, so the new filter has no effect on them\n- The `07_stdlib_ifaces` tests verify stdlib filtering still works correctly alongside the new module filtering\n\n### Manual Verification\n- Run goifaces against a real repo with external deps (e.g., goifaces itself) and verify external interfaces don't appear\n- Run `bash scripts/visual-verify.sh` to check diagram rendering","status":"closed","priority":2,"issue_type":"bug","assignee":"falcon","owner":"olesho@gmail.com","created_at":"2026-02-21T08:22:32.289501-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-21T15:12:40.362441-06:00","closed_at":"2026-02-21T15:12:40.362441-06:00","close_reason":"Filter excludes external packages using module path from go.mod. Also handles dot-less module names (e.g. pentagi) correctly.","dependencies":[{"issue_id":"test-loom-cmz","depends_on_id":"test-loom-944","type":"blocks","created_at":"2026-02-21T08:23:35.103-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-co9","title":"Break large diagrams into paginated slides for readability","description":"Large diagrams like go-memdb produce a single very wide Mermaid chart that's too small to read. Need to split large diagrams into multiple slides/pages. Approach options: (1) Group by interface — each slide shows one interface and its implementors, (2) Group by package — each slide shows one package's types and interfaces, (3) Auto-partition by node count — split when diagram exceeds N nodes. The HTML server should add slide navigation (prev/next/overview). Each slide is a separate Mermaid diagram. An overview slide could show just the relationship graph without method details. Consider also adding a sidebar navigation listing all interfaces/types for quick jumping.","status":"closed","priority":2,"issue_type":"feature","owner":"olesho@gmail.com","created_at":"2026-02-19T16:27:53.624251-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T16:47:39.028799-06:00","closed_at":"2026-02-19T16:47:39.028799-06:00","close_reason":"Closed"}
{"id":"test-loom-dhv","title":"Add Clear and All buttons to Interfaces and Implementations tabs","description":"Add 'Clear' (deselect all) and 'All' (select all) buttons to both the Interfaces and Implementations tabs in the goifaces web UI. These buttons give users quick bulk selection controls alongside the existing individual checkboxes.","design":"## Summary\n\nAdd 'Clear' (deselect all) and 'All' (select all) buttons to the sidebar of both the Interfaces and Implementations tabs. Currently users can only toggle checkboxes one at a time — these buttons provide quick bulk selection controls. The buttons should appear at the top of each entity-list sidebar, above the checkbox items.\n\n## Technical Approach\n\nAll changes are in a single file: `goifaces/internal/server/server.go`, which contains the entire UI (HTML template, CSS, and JavaScript) as a Go string constant.\n\nThe approach is straightforward DOM manipulation following existing patterns:\n- Add a small button bar (`\u003cdiv\u003e`) at the top of each `entity-list` sidebar\n- Wire up click handlers that programmatically check/uncheck all checkboxes for that tab\n- Call the existing `onSelectionChange()` after toggling to trigger diagram re-render\n- No Go backend changes needed — this is purely client-side UI\n\n### Why this approach\n- Minimal change surface (one file)\n- Follows existing patterns: the codebase already uses vanilla JS DOM manipulation (no framework)\n- Reuses existing `onSelectionChange()` for state management — no new state tracking needed\n- The checkbox state lives in the DOM (via `.impl-cb:checked` / `.iface-cb:checked` queries), so programmatically setting `.checked` and calling `onSelectionChange()` is the natural approach\n\n## Files to Create\n\nNone.\n\n## Files to Modify\n\n### `goifaces/internal/server/server.go`\n\nThree areas of changes within the `interactiveHTMLTemplate` string constant:\n\n#### 1. CSS — Add button bar styles (~line 160, after `.entity-list` styles)\n\nAdd styles for the bulk action button bar inside the sidebar:\n\n```css\n.entity-list-actions {\n  display: flex;\n  gap: 0.25rem;\n  margin-bottom: 0.5rem;\n  padding-bottom: 0.5rem;\n  border-bottom: 1px solid #e0e0e0;\n}\n\n.entity-list-actions button {\n  flex: 1;\n  padding: 0.3rem 0.5rem;\n  font-size: 0.75rem;\n  border: 1px solid #ccc;\n  border-radius: 4px;\n  background-color: #f8f9fa;\n  color: #212529;\n  cursor: pointer;\n  transition: background-color 0.15s;\n}\n\n.entity-list-actions button:hover {\n  background-color: #e9ecef;\n}\n```\n\nAlso add dark-mode overrides inside the existing `@media (prefers-color-scheme: dark)` block:\n\n```css\n.entity-list-actions {\n  border-bottom-color: #444;\n}\n\n.entity-list-actions button {\n  background-color: #333;\n  color: #e0e0e0;\n  border-color: #555;\n}\n\n.entity-list-actions button:hover {\n  background-color: #444;\n}\n```\n\n#### 2. HTML — Add button bar containers (~lines 267-285)\n\nAdd a `\u003cdiv class=\"entity-list-actions\"\u003e` with \"All\" and \"Clear\" buttons inside each `.entity-list` div, BEFORE the dynamically-generated checkbox labels:\n\nFor Implementations tab (inside `#impls-list`):\n```html\n\u003cdiv class=\"entity-list\" id=\"impls-list\"\u003e\n  \u003cdiv class=\"entity-list-actions\"\u003e\n    \u003cbutton id=\"impls-all\" title=\"Select all implementations\"\u003eAll\u003c/button\u003e\n    \u003cbutton id=\"impls-clear\" title=\"Deselect all implementations\"\u003eClear\u003c/button\u003e\n  \u003c/div\u003e\n\u003c/div\u003e\n```\n\nFor Interfaces tab (inside `#ifaces-list`):\n```html\n\u003cdiv class=\"entity-list\" id=\"ifaces-list\"\u003e\n  \u003cdiv class=\"entity-list-actions\"\u003e\n    \u003cbutton id=\"ifaces-all\" title=\"Select all interfaces\"\u003eAll\u003c/button\u003e\n    \u003cbutton id=\"ifaces-clear\" title=\"Deselect all interfaces\"\u003eClear\u003c/button\u003e\n  \u003c/div\u003e\n\u003c/div\u003e\n```\n\nNOTE: The dynamically-created checkbox labels (from the JS forEach loops) will be appended AFTER these button divs since `appendChild` adds to the end of the container.\n\n#### 3. JavaScript — Add click handlers (~line 339, after the checkbox-building forEach loops)\n\nAdd event listeners for the four buttons:\n\n```javascript\n// Bulk selection: Implementations\ndocument.getElementById('impls-all').addEventListener('click', function() {\n  document.querySelectorAll('.impl-cb').forEach(function(cb) { cb.checked = true; });\n  onSelectionChange();\n});\ndocument.getElementById('impls-clear').addEventListener('click', function() {\n  document.querySelectorAll('.impl-cb').forEach(function(cb) { cb.checked = false; });\n  onSelectionChange();\n});\n\n// Bulk selection: Interfaces\ndocument.getElementById('ifaces-all').addEventListener('click', function() {\n  document.querySelectorAll('.iface-cb').forEach(function(cb) { cb.checked = true; });\n  onSelectionChange();\n});\ndocument.getElementById('ifaces-clear').addEventListener('click', function() {\n  document.querySelectorAll('.iface-cb').forEach(function(cb) { cb.checked = false; });\n  onSelectionChange();\n});\n```\n\n## Dependencies\n\nNo new external packages or libraries needed. All changes use existing vanilla JS and CSS.\n\n## Edge Cases \u0026 Error Handling\n\n1. **Empty lists**: If there are no implementations or no interfaces (e.g., a package with no relations), the All/Clear buttons will be present but harmless — iterating an empty NodeList is a no-op and `onSelectionChange()` will correctly show the placeholder.\n\n2. **Cross-tab state**: Both tabs' checkboxes contribute to the same diagram. Clicking \"All\" on the Implementations tab while some interfaces are also checked will correctly show the union of both selections — `onSelectionChange()` already reads from both `.impl-cb:checked` and `.iface-cb:checked`.\n\n3. **Clear when already cleared**: Clicking \"Clear\" when nothing is checked simply calls `onSelectionChange()` which shows the placeholder — idempotent behavior.\n\n4. **All when all already checked**: Clicking \"All\" when everything is checked is a no-op since all checkboxes are already `true` — `onSelectionChange()` re-renders with the same selection (harmless).\n\n5. **Dark mode**: The CSS includes dark-mode overrides so buttons match the existing dark theme.\n\n## Testing Strategy\n\n### Manual Verification\n1. Run `go build -o goifaces ./goifaces \u0026\u0026 ./goifaces serve --dir ./goifaces/testdata` (or any Go project directory)\n2. Open the browser and verify:\n   - Implementations tab: \"All\" and \"Clear\" buttons appear at top of sidebar\n   - Interfaces tab: \"All\" and \"Clear\" buttons appear at top of sidebar\n   - Clicking \"All\" on Implementations tab checks all impl checkboxes and renders diagram\n   - Clicking \"Clear\" on Implementations tab unchecks all impl checkboxes and shows placeholder (if no iface checkboxes are checked)\n   - Same for Interfaces tab\n   - Cross-tab: Check some impls, switch to Interfaces tab, click \"All\" → diagram shows both\n   - Dark mode: buttons render correctly in dark mode\n\n### Automated Tests\nNo new automated tests needed. The buttons are pure client-side UI with no new server logic. The existing `TestFilterBySelection` tests in `internal/integration_test.go` already validate the selection filtering logic that `onSelectionChange()` relies on. The UI buttons simply toggle DOM checkbox state and call the same existing code path.\n\n### Linting\nRun `golangci-lint run ./...` to ensure the modified Go string doesn't introduce any issues.","status":"closed","priority":2,"issue_type":"task","assignee":"spark","owner":"olesho@gmail.com","created_at":"2026-02-21T21:05:39.248771-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-21T21:14:22.688128-06:00","closed_at":"2026-02-21T21:14:22.688128-06:00","close_reason":"Completed: Added All/Clear buttons with sticky positioning, dark mode support, and code review fixes"}
{"id":"test-loom-dih","title":"Create project documentation","description":"CLAUDE.md (agent rules), AGENTS.md (agent workflow), docs/architecture.md, docs/cli-reference.md, docs/logging.md, docs/development.md, scripts/visual-verify.sh","status":"closed","priority":2,"issue_type":"task","owner":"olesho@gmail.com","created_at":"2026-02-19T09:06:39.4316-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T09:06:43.273698-06:00","closed_at":"2026-02-19T09:06:43.273698-06:00","close_reason":"All docs and scripts created"}
{"id":"test-loom-dl6","title":"Create integration test suite with 10 testdata scenarios","description":"internal/integration_test.go with 12 subtests across 10 testdata dirs. Each testdata dir is a self-contained Go module. Tests cover: single iface, multi impl, multi iface, pointer receiver, embedded iface, cross-package, stdlib ifaces (with/without), empty iface, unexported (with/without), diamond pattern.","status":"closed","priority":1,"issue_type":"task","owner":"olesho@gmail.com","created_at":"2026-02-19T09:06:32.183689-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T09:06:35.529773-06:00","closed_at":"2026-02-19T09:06:35.529773-06:00","close_reason":"All 12 tests passing. Fixed stdlib module paths, added stdlib package loading, and error builtin handling."}
{"id":"test-loom-drz","title":"Treemap: increase gap/padding to 3x current values (TREEMAP_GAP 4-\u003e12, innerPad 3-\u003e9)","description":"The treemap blocks in Package Map (html) are still too tight. Increase TREEMAP_GAP from 4 to 12 and innerPad from 3 to 9 in goifaces/internal/server/server.go renderTreemap(). These are the two spacing constants in the JS treemap renderer. File: goifaces/internal/server/server.go, TREEMAP_GAP at ~line 607, innerPad at ~line 643.","design":"## Summary\n\nIncrease the spacing between treemap blocks in the Package Map HTML view to improve visual readability. The current gap (4px) and inner padding (3px) make nested blocks feel cramped. Tripling both values (4→12, 3→9) adds breathing room without changing any layout logic.\n\n## Technical Approach\n\nPure constant-value change — update two JS variable declarations in the embedded treemap renderer. No logic, layout algorithm, or CSS changes needed. The existing `Math.max(0, ...)` guards already protect against negative dimensions if blocks become too small at the new spacing.\n\n## Files to Modify\n\n**goifaces/internal/server/server.go**\n- Line 607: Change `var TREEMAP_GAP = 4;` → `var TREEMAP_GAP = 12;`\n- Line 644: Change `var innerPad = 3;` → `var innerPad = 9;`\n\nNo other files need changes. Both constants are local JS variables inside the HTML template string with no external references.\n\n## Files to Create\n\nNone.\n\n## Dependencies\n\nNone — no new packages, no blocking tasks.\n\n## Edge Cases \u0026 Error Handling\n\n- **Small blocks**: With 3× larger gaps, very small treemap nodes could collapse to 0px width/height. The existing `Math.max(0, ...)` calls on lines 631-632, 642-643, 645, 688-689 already clamp dimensions to zero, so no negative values can occur. Visually, tiny packages may become invisible — this is acceptable and already possible at the current gap size.\n- **innerRect overflow**: On line 645, `gh - headerH - innerPad` could go negative if a group block is very short. The existing `Math.max(0, ...)` handles this.\n\n## Testing Strategy\n\n1. Run `go build ./...` to confirm the Go file compiles (the JS is inside a template string).\n2. Launch the server and open the Package Map page in a browser.\n3. Visually verify: treemap blocks should have noticeably more spacing between them (roughly 3× the previous gap).\n4. Check nested groups: inner children should also have more padding from the group border.\n5. Resize the browser window to verify the layout still responds correctly at various sizes.","status":"closed","priority":1,"issue_type":"task","assignee":"spark","owner":"olesho@gmail.com","created_at":"2026-02-24T13:28:20.357961-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-24T15:17:38.608537-06:00","closed_at":"2026-02-24T15:17:38.608537-06:00","close_reason":"Completed: changed TREEMAP_GAP 4→12 and innerPad 3→9 in server.go. Build passes, all tests pass."}
{"id":"test-loom-e4g","title":"Collapsed sidebar section should float above the expanded one","description":"When the Implementations list is expanded with many items, the Interfaces header gets pushed to the bottom and becomes hard to reach. Fix: swap visual order so the collapsed section always appears above the expanded one. Also separate the two sections into distinct UI elements rather than sharing one container, so each has its own border/card appearance.","status":"closed","priority":2,"issue_type":"bug","owner":"olesho@gmail.com","created_at":"2026-02-25T15:24:34.278005-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-25T15:27:28.911542-06:00","closed_at":"2026-02-25T15:27:28.911542-06:00","close_reason":"Split sidebar into separate card elements per section. Collapsed section always floats above the expanded one via CSS flex order swap on toggle."}
{"id":"test-loom-f0x","title":"Color-code interfaces vs implementations in Mermaid diagrams","description":"Use Mermaid classDiagram styling (classDef + cssClass) to visually distinguish interfaces from concrete types. For example, interfaces in blue/teal and implementations in green/gray. This makes it immediately obvious which boxes are contracts vs implementations when viewing the diagram. Implementation is in internal/diagram/mermaid.go — add classDef statements after the classDiagram header and apply them to interface vs type nodes.","status":"closed","priority":2,"issue_type":"feature","owner":"olesho@gmail.com","created_at":"2026-02-19T11:43:00.117332-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T12:59:07.123668-06:00","closed_at":"2026-02-19T12:59:07.123668-06:00","close_reason":"Implemented in a20df86. Interfaces blue (#2374ab), implementations green (#4a9c6d) via Mermaid classDef + cssClass."}
{"id":"test-loom-f13","title":"Implement hub-and-spoke slide splitting strategy","description":"Implement the first concrete Splitter strategy: hub-and-spoke.\n\nAlgorithm:\n1. Classify nodes by connection count:\n   - 'Hub' nodes (reusable): interfaces/types with connections \u003e= threshold (e.g., 3+). These appear on EVERY slide as context.\n   - 'Spoke' nodes (non-reusable): implementations with fewer connections. These are chunked into groups.\n\n2. Group spoke nodes into chunks of N (configurable, default 3-4 per slide).\n\n3. For each chunk, build a slide containing:\n   - All hub nodes (the shared interfaces)\n   - The chunk's spoke nodes (implementations)\n   - Only the relations connecting these specific nodes\n\n4. Slide 0 remains the overview (all nodes, no methods).\n\nExample with go-memdb:\n- Hubs: memdb_Indexer, memdb_MultiIndexer, memdb_SingleIndexer, memdb_PrefixIndexer (4+ connections each)\n- Spokes: BoolFieldIndex, CompoundMultiIndex, ConditionalIndex, etc. (3 connections each)\n- Slides: chunks of 3 spokes + all hubs\n\nEdge cases:\n- A node that's both high-connectivity AND an implementation stays as a hub\n- ResultIterator + FilterIterator form their own small cluster — they should be grouped together\n- If total nodes \u003c= threshold, return single slide (no splitting)\n\nDepends on: splitter abstraction task.","status":"closed","priority":1,"issue_type":"feature","owner":"olesho@gmail.com","created_at":"2026-02-19T17:07:23.512936-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T19:19:24.213173-06:00","closed_at":"2026-02-19T19:19:24.213173-06:00","close_reason":"Implemented in hub-and-spoke slide splitting session: split package with Splitter interface, HubAndSpoke strategy, CLI flags, integration tests. All tests + linter pass.","dependencies":[{"issue_id":"test-loom-f13","depends_on_id":"test-loom-wa8","type":"blocks","created_at":"2026-02-19T17:07:38.275703-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-ije","title":"Replace dash-dotted arrow lines with solid ones in Mermaid diagrams","design":"## Summary\n\nReplace the Mermaid `..|\u003e` (dashed/dash-dotted realization arrow) with `--|\u003e` (solid inheritance arrow) in all generated class diagrams. Currently, `writeRelation` in `mermaid.go` uses `..|\u003e` which renders as a dashed line in Mermaid. The task asks for solid lines instead, which is `--|\u003e` in Mermaid syntax. This is a cosmetic change affecting diagram output only — no logic or architecture changes.\n\n## Technical Approach\n\nThis is a simple string replacement. In Mermaid classDiagram syntax:\n- `..|\u003e` = dashed line with open arrowhead (UML \"realization\")\n- `--|\u003e` = solid line with open arrowhead (UML \"inheritance\")\n\nThe single source of truth is the `writeRelation` function in `mermaid.go`. All tests that assert on the arrow syntax also need updating.\n\nNo new dependencies, no new patterns, no architectural decisions.\n\n## Files to Modify\n\n### 1. `goifaces/internal/diagram/mermaid.go` (line 188)\nChange the format string in `writeRelation` from `..|\u003e` to `--|\u003e`:\n```go\n// Before:\nline := fmt.Sprintf(\"    %s ..|\u003e %s\", typeID, ifaceID)\n// After:\nline := fmt.Sprintf(\"    %s --|\u003e %s\", typeID, ifaceID)\n```\nThis is the ONLY production code change.\n\n### 2. `goifaces/internal/integration_test.go` (multiple lines)\nUpdate all test assertions and the `normalizeOutput` helper to use `--|\u003e` instead of `..|\u003e`:\n\n**`normalizeOutput` function (line 82):** Change the relation-detection string:\n```go\n// Before:\n} else if strings.Contains(trimmed, \"..|\u003e\") {\n// After:\n} else if strings.Contains(trimmed, \"--|\u003e\") {\n```\n\n**All `assert.Contains` / `assert.NotContains` calls** that check for `..|\u003e` relations (lines 141, 153, 154, 170-176, 186, 199-201, 211, 236, 249, 260, 276-278, 291-293). Each `..|\u003e` becomes `--|\u003e`. Full list:\n- Line 141: `shapes_Circle ..|\u003e shapes_Shape` → `shapes_Circle --|\u003e shapes_Shape`\n- Line 153: `animals_Dog ..|\u003e animals_Speaker` → `animals_Dog --|\u003e animals_Speaker`\n- Line 154: `animals_Cat ..|\u003e animals_Speaker` → `animals_Cat --|\u003e animals_Speaker`\n- Line 170: `store_MemStore ..|\u003e store_Reader` → `store_MemStore --|\u003e store_Reader`\n- Line 171: `store_MemStore ..|\u003e store_Writer` → `store_MemStore --|\u003e store_Writer`\n- Line 172: `store_MemStore ..|\u003e store_ReadWriter` → `store_MemStore --|\u003e store_ReadWriter`\n- Line 174: `store_ReadOnlyCache ..|\u003e store_Reader` → `store_ReadOnlyCache --|\u003e store_Reader`\n- Line 175: `store_ReadOnlyCache ..|\u003e store_Writer` → `store_ReadOnlyCache --|\u003e store_Writer`\n- Line 176: `store_ReadOnlyCache ..|\u003e store_ReadWriter` → `store_ReadOnlyCache --|\u003e store_ReadWriter`\n- Line 186: `db_Connection ..|\u003e db_Closer` → `db_Connection --|\u003e db_Closer`\n- Line 199: `io2_MyFile ..|\u003e io2_Reader` → `io2_MyFile --|\u003e io2_Reader`\n- Line 200: `io2_MyFile ..|\u003e io2_Closer` → `io2_MyFile --|\u003e io2_Closer`\n- Line 201: `io2_MyFile ..|\u003e io2_ReadCloser` → `io2_MyFile --|\u003e io2_ReadCloser`\n- Line 211: `impl_ConsoleLogger ..|\u003e ifaces_Logger` → `impl_ConsoleLogger --|\u003e ifaces_Logger`\n- Line 236: `assert.NotContains(t, normalized, \"..|\u003e\")` → `assert.NotContains(t, normalized, \"--|\u003e\")`\n- Line 249: `assert.NotContains(t, normalized, \"..|\u003e\")` → `assert.NotContains(t, normalized, \"--|\u003e\")`\n- Line 260: `internal_Cat ..|\u003e internal_Runner` → `internal_Cat --|\u003e internal_Runner`\n- Line 276: `internal_dog ..|\u003e internal_walker` → `internal_dog --|\u003e internal_walker`\n- Line 277: `internal_dog ..|\u003e internal_Runner` → `internal_dog --|\u003e internal_Runner`\n- Line 278: `internal_Cat ..|\u003e internal_Runner` → `internal_Cat --|\u003e internal_Runner`\n- Line 291: `diamond_DB ..|\u003e diamond_Saver` → `diamond_DB --|\u003e diamond_Saver`\n- Line 292: `diamond_DB ..|\u003e diamond_Loader` → `diamond_DB --|\u003e diamond_Loader`\n- Line 293: `diamond_DB ..|\u003e diamond_Persister` → `diamond_DB --|\u003e diamond_Persister`\n\n## Files to Create\nNone.\n\n## Dependencies\nNone. No external packages needed. This is a pure string replacement.\n\n## Edge Cases \u0026 Error Handling\n- No edge cases — this is a deterministic string replacement with no conditional logic.\n- The `normalizeOutput` test helper in `integration_test.go` uses `..|\u003e` to detect relation lines during parsing. This MUST be updated to `--|\u003e` or the test normalizer will silently skip relation lines, causing false test passes.\n\n## Testing Strategy\n1. Run the full test suite: `cd goifaces \u0026\u0026 go test ./...`\n2. All 11 end-to-end test cases plus the hub-and-spoke slide test should pass.\n3. Manually verify by running the tool on any testdata directory and inspecting the output contains `--|\u003e` (solid arrows) instead of `..|\u003e` (dashed arrows).","notes":"BLOCKED: Source code files do not exist in the repository. The design references goifaces/internal/diagram/mermaid.go and goifaces/internal/integration_test.go, but the repo only contains the initial commit with .beads/issues.jsonl and AGENTS.md. All branches (main, nova, falcon, spark) point to the same initial commit. The goifaces project code was never committed to this repository. Cannot modify files that don't exist.","status":"closed","priority":2,"issue_type":"task","assignee":"nova","owner":"olesho@gmail.com","created_at":"2026-02-20T05:02:17.855914-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-20T13:17:06.228321-06:00","closed_at":"2026-02-20T13:17:06.228321-06:00","close_reason":"Replaced ..|\u003e with --|\u003e in mermaid.go and all test assertions"}
{"id":"test-loom-izp","title":"Wire splitter into main pipeline and test with go-memdb","description":"Wire the hub-and-spoke splitter into main.go and ServeSlides. Verify with go-memdb that:\n1. Overview slide shows all 17 nodes with no methods\n2. Each detail slide shows 3-4 implementations + the shared interfaces they connect to\n3. All relations are preserved (no missing arrows)\n4. Slides are navigable via prev/next/picker\n5. Each slide's Mermaid validates via scripts/verify-mermaid.sh\n\nAdd integration test: build slides for go-memdb-like synthetic data, assert slide count and hub presence on each slide.\n\nDepends on: hub-and-spoke implementation task.","status":"closed","priority":1,"issue_type":"task","owner":"olesho@gmail.com","created_at":"2026-02-19T17:07:28.151922-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T19:19:24.215067-06:00","closed_at":"2026-02-19T19:19:24.215067-06:00","close_reason":"Implemented in hub-and-spoke slide splitting session: split package with Splitter interface, HubAndSpoke strategy, CLI flags, integration tests. All tests + linter pass.","dependencies":[{"issue_id":"test-loom-izp","depends_on_id":"test-loom-f13","type":"blocks","created_at":"2026-02-19T17:07:38.349872-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-j2a","title":"Start server without args: add local folder picker to load Go repos","description":"## Feature\n\nAllow the server to start without passing any path/URL argument. When no argument is given, serve a landing page with an input + button at the top that lets the user load a local Go repository folder.\n\n## Current Behavior\n\nThe CLI requires a positional argument (local path or GitHub URL). Without it, the server doesn't start or shows an error.\n\n## Desired Behavior\n\n1. `goifaces` (no args) starts the server and opens a landing page\n2. The page shows an input field + button at the top for loading a local folder path\n3. User enters/selects a local folder path containing a Go repository\n4. On submit, the server analyzes that folder (same pipeline as the current CLI path argument)\n5. The page updates with the Package Map / Structures UI as usual\n\n## UI\n\n- Input field + 'Load' button at the top of the page (above the tabs)\n- The input should persist after loading so the user can switch to a different repo\n- Show a loading indicator while analyzing\n\n## Technical Notes\n\n- The server needs a new API endpoint (e.g. POST /api/load) that accepts a local path and triggers analysis\n- The frontend sends the path, server resolves and analyzes it, returns the data\n- After loading, the page should behave identically to the current flow (Package Map, Structures, selection, Mermaid, etc.)\n- Security: only allow local filesystem paths, validate they exist and contain Go files","status":"closed","priority":1,"issue_type":"feature","owner":"olesho@gmail.com","created_at":"2026-02-26T15:21:35.303726-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-26T16:13:48.891097-06:00","closed_at":"2026-02-26T16:13:48.891097-06:00","close_reason":"All 5 subtasks complete. Feature shipped."}
{"id":"test-loom-j2a.1","title":"Extract analysis pipeline into server.RunAnalysis","description":"Create new file internal/server/analyze.go containing AnalysisConfig struct and RunAnalysis function that encapsulates resolve → analyze → filter → enrich → prepare pipeline with default enrichers. This is the building block for the POST /api/load handler.","design":"## File to Create\n`goifaces/internal/server/analyze.go`\n\n## Implementation\n- `AnalysisConfig` struct: Input, Filter, IncludeStdlib, IncludeUnexported fields\n- `RunAnalysis(ctx, cfg, logger)` function:\n  1. `resolver.Resolve(ctx, cfg.Input, logger)` → dir, cleanup\n  2. `analyzer.Analyze(ctx, dir, opts, logger)` → result\n  3. `analyzer.Filter(result, opts)`\n  4. Apply default enrichers: `NewDefaultGrouper()`, `NewDefaultSimplifier()`\n  5. `diagram.PrepareInteractiveData(result, diagramOpts)`\n  6. `data.PackageMapNodes = diagram.PreparePackageMapData(result)`\n  7. `data.RepoAddress = cfg.Input`\n  8. Return data, cleanup, nil\n\n## Test\nAdd `TestRunAnalysisWithTestdata` using `testdata/01_single_iface` — verify non-empty Interfaces.\n\n## Acceptance Criteria\n- `go build ./internal/server/...` passes\n- `go test ./internal/server/...` passes\n- `golangci-lint run ./...` passes","status":"closed","priority":1,"issue_type":"task","assignee":"falcon","owner":"olesho@gmail.com","created_at":"2026-02-26T15:27:33.586116-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-26T15:45:42.561803-06:00","closed_at":"2026-02-26T15:45:42.561803-06:00","close_reason":"Completed with tests and code review","dependencies":[{"issue_id":"test-loom-j2a.1","depends_on_id":"test-loom-j2a","type":"parent-child","created_at":"2026-02-26T15:27:33.593784-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-j2a.2","title":"Add landingHTMLTemplate const and landing page tests","description":"Add landing page HTML as const landingHTMLTemplate in server.go. Includes path input, analyze button, status div, inline JS calling POST /api/load, dark/light mode CSS. No server wiring — just the template and tests.","design":"## Location\nAdd `const landingHTMLTemplate` in `goifaces/internal/server/server.go`\n\n## HTML Must Contain\n- `\u003ctitle\u003egoifaces\u003c/title\u003e`\n- `\u003cinput type=\"text\" id=\"repo-path\"\u003e` with placeholder\n- `\u003cbutton id=\"analyze-btn\"\u003eAnalyze\u003c/button\u003e`\n- `\u003cdiv id=\"status\"\u003e\u003c/div\u003e`\n- JS `function loadRepo()` that:\n  - Reads #repo-path value\n  - Disables button, shows 'Analyzing...'\n  - `fetch('/api/load', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({path: val})})`\n  - On success: `window.location.reload()`\n  - On error: show error in #status, re-enable button\n- Same `@media (prefers-color-scheme: dark)` body styling as interactive template\n- `#status.error` CSS rule\n\n## Test\n`TestLandingPageTemplateExists`: assert.Contains for id=\"repo-path\", id=\"analyze-btn\", id=\"status\", fetch('/api/load'), window.location.reload(), function loadRepo()\n\n## Acceptance Criteria\n- `go test ./internal/server/...` passes\n- `golangci-lint run ./...` passes","status":"closed","priority":1,"issue_type":"task","assignee":"spark","owner":"olesho@gmail.com","created_at":"2026-02-26T15:27:34.20584-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-26T15:44:17.915274-06:00","closed_at":"2026-02-26T15:44:17.915274-06:00","close_reason":"Added landingHTMLTemplate const and TestLandingPageTemplateExists test. All tests pass, linter clean.","dependencies":[{"issue_id":"test-loom-j2a.2","depends_on_id":"test-loom-j2a","type":"parent-child","created_at":"2026-02-26T15:27:34.209859-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-j2a.3","title":"Wire up ServeInteractiveNoData and POST /api/load handler","description":"Add serverState struct with sync.RWMutex, ServeInteractiveNoData exported function, and handleLoad handler to server.go. GET / switches between landing/interactive based on state. POST /api/load calls RunAnalysis and swaps state.","design":"## Components\n\n### serverState struct\n```go\ntype serverState struct {\n    mu   sync.RWMutex\n    data *diagram.InteractiveData\n    tmpl *template.Template\n}\n```\nWith get() and set() methods.\n\n### ServeInteractiveNoData(ctx, port, openBrowser, logger)\n- Parses both templates (landing + interactive)\n- Creates serverState (nil data)\n- GET / → landing if no data, interactive if data loaded\n- POST /api/load → handleLoad\n- Starts http.Server, blocks until ctx cancel\n\n### handleLoad\n- Reject non-POST: 405\n- Decode {\"path\": \"...\"} — reject malformed JSON: 400\n- Reject empty path: 400 {\"error\":\"path is required\"}\n- Reject http URLs: 400 {\"error\":\"use -path flag for GitHub URLs\"}\n- Call RunAnalysis; on error: 400\n- state.set(data, tmpl); return 200 {\"ok\": true}\n- Log all errors/successes with component field\n\n### Tests\n- TestLoadEndpointRejectsEmptyPath\n- TestLoadEndpointRejectsGitHubURLs\n- TestLoadEndpointRejectsNonPOST\n- TestLoadEndpointRejectsMalformedJSON\n- TestLandingPageRenderedWhenNoData\nUse httptest.NewServer with constructed mux.\n\n## Acceptance Criteria\n- All existing + new tests pass\n- golangci-lint passes\n- No data races under go test -race","status":"closed","priority":1,"issue_type":"task","assignee":"spark","owner":"olesho@gmail.com","created_at":"2026-02-26T15:27:38.089138-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-26T15:58:22.85899-06:00","closed_at":"2026-02-26T15:58:22.85899-06:00","close_reason":"Completed with tests and code review. Implemented serverState, ServeInteractiveNoData, handleLoad, prepareTemplateData. Fixed cleanup lifecycle, error handling, and log levels from review.","dependencies":[{"issue_id":"test-loom-j2a.3","depends_on_id":"test-loom-j2a","type":"parent-child","created_at":"2026-02-26T15:27:38.090928-06:00","created_by":"Oleh Luchkiv"},{"issue_id":"test-loom-j2a.3","depends_on_id":"test-loom-j2a.1","type":"blocks","created_at":"2026-02-26T15:28:14.740737-06:00","created_by":"Oleh Luchkiv"},{"issue_id":"test-loom-j2a.3","depends_on_id":"test-loom-j2a.2","type":"blocks","created_at":"2026-02-26T15:28:15.095613-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-j2a.4","title":"Allow goifaces to start without path argument","description":"Modify main.go: move logging setup before the input check, replace os.Exit(1) block with server.ServeInteractiveNoData call when no input is given.","design":"## Changes in main.go\n\n1. Move lines 63-76 (logging setup) to before the input==\"\" check (flag values available after fs.Parse)\n2. Replace:\n```go\nif input == \"\" {\n    fmt.Fprintln(os.Stderr, \"Usage: goifaces [flags] \u003cpath-or-url\u003e\")\n    fs.PrintDefaults()\n    os.Exit(1)\n}\n```\nWith:\n```go\nif input == \"\" {\n    openBrowser := !*noBrowser\n    fmt.Printf(\"Starting server on http://localhost:%d\\n\", *port)\n    if err := server.ServeInteractiveNoData(ctx, *port, openBrowser, logger); err != nil {\n        logger.Error(\"server error\", \"error\", err)\n        fmt.Fprintf(os.Stderr, \"Server error: %v\\n\", err)\n        os.Exit(1)\n    }\n    return\n}\n```\n\n## Acceptance Criteria\n- `goifaces` (no args) starts server and opens browser to landing page\n- `goifaces ./testdata/01_single_iface` still works as before\n- `goifaces --help` still prints help\n- `go test ./...` passes","status":"closed","priority":1,"issue_type":"task","assignee":"spark","owner":"olesho@gmail.com","created_at":"2026-02-26T15:27:38.729685-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-26T16:07:26.50272-06:00","closed_at":"2026-02-26T16:07:26.50272-06:00","close_reason":"Completed: moved logging before input check, replaced usage exit with ServeInteractiveNoData call, added -output guard, 27 new tests","dependencies":[{"issue_id":"test-loom-j2a.4","depends_on_id":"test-loom-j2a","type":"parent-child","created_at":"2026-02-26T15:27:38.730459-06:00","created_by":"Oleh Luchkiv"},{"issue_id":"test-loom-j2a.4","depends_on_id":"test-loom-j2a.3","type":"blocks","created_at":"2026-02-26T15:28:15.436315-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-j2a.5","title":"Update docs for landing page mode","description":"Update docs/cli-reference.md and docs/architecture.md per CLAUDE.md requirements. Document no-arg mode, landing page, POST /api/load, analyze.go, ServeInteractiveNoData, serverState.","design":"## Changes\n\n### docs/cli-reference.md\n- Document that no positional argument is now valid\n- Describe landing page mode: server starts, opens browser to path input form\n- Document the in-browser workflow: enter local path → click Analyze → view results\n- Note that -output flag still requires a path argument\n\n### docs/architecture.md\n- Document new file: internal/server/analyze.go (AnalysisConfig, RunAnalysis)\n- Document ServeInteractiveNoData function and its role\n- Document POST /api/load endpoint (request/response format, validation rules)\n- Document serverState struct (RWMutex-protected mutable state)\n- Update data flow diagram to include the no-arg → landing page → load → interactive flow","status":"closed","priority":2,"issue_type":"task","assignee":"falcon","owner":"olesho@gmail.com","created_at":"2026-02-26T15:27:39.37796-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-26T16:13:48.745878-06:00","closed_at":"2026-02-26T16:13:48.745878-06:00","close_reason":"Docs updated for landing page mode.","dependencies":[{"issue_id":"test-loom-j2a.5","depends_on_id":"test-loom-j2a","type":"parent-child","created_at":"2026-02-26T15:27:39.381075-06:00","created_by":"Oleh Luchkiv"},{"issue_id":"test-loom-j2a.5","depends_on_id":"test-loom-j2a.4","type":"blocks","created_at":"2026-02-26T15:28:15.759991-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-jzu","title":"Show file paths in Mermaid diagram blocks for interfaces and implementations","description":"Add source file path information to each class block in the generated Mermaid diagram. Both interface and implementation blocks should display the file path where they are defined. This requires: (1) capturing file position during analysis in analyzer.go (using go/packages token position info), (2) storing file path in InterfaceDef and TypeDef structs in types.go, (3) rendering the file path in the Mermaid class block in mermaid.go (e.g. as a note or first line in the block). The file path should be relative to the analyzed module root for readability.","status":"closed","priority":2,"issue_type":"feature","owner":"olesho@gmail.com","created_at":"2026-02-19T16:24:30.267171-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T16:43:48.378403-06:00","closed_at":"2026-02-19T16:43:48.378403-06:00","close_reason":"Closed"}
{"id":"test-loom-kax","title":"Treemap: cap max block height to reduce empty space","description":"Some treemap blocks in Package Map (html) are too tall relative to their content. Apply max-height constraints so blocks don't have excessive vertical empty space. The sqrt scaling helped with area ratios but tall narrow blocks still waste space.","design":"## Summary\n\nSome treemap blocks in Package Map (html) grow excessively tall when the squarify algorithm allocates them a large vertical span. The content of each leaf block is only ~40-50px (package name + stats line), so blocks taller than ~120px have mostly empty space. This fix adds a MAX_BLOCK_HEIGHT constant and applies it during rendering to cap leaf node and self-node heights.\n\n## Technical Approach\n\n**Approach: JavaScript height capping in renderTreemap()**\n\nCap the rendered height of leaf nodes and self-nodes at a fixed maximum (120px) during DOM element creation. This is applied after the squarify algorithm runs, so it doesn't affect layout calculations — it only constrains the visual rendering of individual blocks.\n\n**Why not CSS max-height?** CSS max-height alone would clip the content but leave the allocated space empty — the absolutely-positioned blocks wouldn't shift to fill gaps. The visual result would be the same as JS capping (blocks capped with space below), but mixing layout constraints between CSS and JS makes the code harder to reason about.\n\n**Why not modify the squarify algorithm?** Modifying the algorithm to enforce max heights would break the area-proportional property that makes treemaps useful. Post-render capping is the right layer for visual polish.\n\n**Why not an aspect-ratio-based cap?** A proportional cap (e.g., max-height = width * 2.5) adds complexity without clear benefit. A fixed 120px cap is simple, predictable, and sufficient since all blocks contain the same ~40-50px of content.\n\n**Trade-off:** After capping, the treemap container may have empty space at the bottom of some layout rows. This is acceptable — the alternative (redistributing freed space) would require a fundamentally different algorithm and the empty space is far less noticeable than the current excessively tall blocks.\n\n## Files to Modify\n\n### 1. goifaces/internal/server/server.go\n\n**Change 1: Add MAX_BLOCK_HEIGHT constant (near line 607)**\nAfter the existing `TREEMAP_GAP = 4` declaration, add:\n```javascript\nvar MAX_BLOCK_HEIGHT = 120;\n```\n\n**Change 2: Cap leaf node height (line 687)**\nChange:\n```javascript\nnode.style.height = Math.max(0, p.h - 2 * TREEMAP_GAP) + 'px';\n```\nTo:\n```javascript\nnode.style.height = Math.min(MAX_BLOCK_HEIGHT, Math.max(0, p.h - 2 * TREEMAP_GAP)) + 'px';\n```\n\n**Change 3: Cap self-node height (line 660)**\nChange:\n```javascript\nselfNode.style.height = Math.max(0, selfH) + 'px';\n```\nTo:\n```javascript\nselfNode.style.height = Math.min(MAX_BLOCK_HEIGHT, Math.max(0, selfH)) + 'px';\n```\n\n**Do NOT change:** Group node heights (line 631) — groups contain child layouts and must not be capped.\n\n## Files to Create\n\nNone.\n\n## Dependencies\n\nNone — this is a self-contained visual fix with no external dependencies.\n\n## Edge Cases \u0026 Error Handling\n\n1. **Blocks already shorter than 120px** — Math.min is a no-op, no behavioral change.\n2. **Very small viewports** — min-height (36px) CSS still applies; min-height \u003c MAX_BLOCK_HEIGHT so no conflict.\n3. **Blocks with zero or negative computed height** — The existing Math.max(0, ...) guard handles this before the Math.min cap.\n4. **Self-nodes inside groups** — Same capping logic applies; the inner layout rect recalculation on line 675 uses the original selfH, not the capped value. This is correct — the inner rect should still account for the full allocated space, even though the self-node renders shorter.\n\n## Testing Strategy\n\n### Manual Verification\n1. Run the app and open the Package Map (html) tab\n2. Before: verify some blocks are excessively tall (\u003e150px) with mostly empty space\n3. After: verify no leaf block exceeds ~120px height\n4. Check that group blocks (with children inside) are NOT capped\n5. Check various repository sizes (small, medium, large) to verify the cap works across different data densities\n6. Verify dark mode still renders correctly (no CSS interaction)\n7. Resize the browser window and verify the layout recalculates properly via the existing ResizeObserver\n\n### Automated Testing\nNo existing test infrastructure for the HTML treemap visualization. Manual verification is sufficient for this visual-only change.","status":"closed","priority":1,"issue_type":"bug","assignee":"nova","owner":"olesho@gmail.com","created_at":"2026-02-24T10:29:06.609825-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-24T11:16:34.984402-06:00","closed_at":"2026-02-24T11:16:34.984402-06:00","close_reason":"Completed: added MAX_BLOCK_HEIGHT=120 cap to leaf and self-node heights, fixed innerRect layout sync"}
{"id":"test-loom-khd","title":"Package Map too wide, doesn't fit browser screen","description":"The Package Map visualization is too wide and overflows the browser viewport. Fix the layout/sizing so it fits within the screen and test in-browser to confirm.","design":"## Summary\n\nThe Package Map visualization (flowchart LR) generates an SVG whose natural width exceeds the browser viewport. The current JS fixup code explicitly sets each SVG's width to its viewBox pixel width and removes max-width constraints, causing horizontal overflow. The fix should auto-scale the Package Map SVG to fit the viewport while preserving the existing behavior for class-diagram slides (which benefit from 1:1 pixel rendering). This is a CSS/JS-only fix in server.go's HTML template.\n\n## Technical Approach\n\n**Strategy: Scale-to-fit for overflowing SVGs.**\n\nAfter Mermaid renders, compare each SVG's viewBox width to the available viewport width. If the SVG is wider than the viewport, instead of setting a fixed pixel width, set the SVG width to 100% and let the viewBox handle proportional scaling. For SVGs that fit within the viewport, keep the current behavior (exact pixel width for crisp text).\n\nThis approach:\n- Fixes the Package Map overflow without affecting detail slides that already fit\n- Requires no changes to the Go diagram generation code\n- Uses the browser's native SVG scaling (viewBox + width: 100%) for proportional fit\n- Preserves zoom in/out functionality (CSS transform scale still works on the container)\n\n**Alternative considered: CSS-only `max-width: 100%` on SVG.** Rejected because the current code explicitly sets `maxWidth = 'none'`, so a CSS rule would be overridden. The fix needs to be in the JS fixup logic.\n\n**Alternative considered: Change flowchart direction from LR to TB.** Rejected because TB makes the hierarchy harder to read and doesn't solve the root cause for repos with many packages.\n\n## Files to Create\n\nNone.\n\n## Files to Modify\n\n### `goifaces/internal/server/server.go` (lines ~521-533 in the JS section of slidesHTMLTemplate)\n\n**Change the SVG width fixup logic** in the `mermaid.run().then()` callback:\n\nCurrent code (problematic):\n```javascript\ndocument.querySelectorAll('pre.mermaid svg').forEach(function(svg) {\n  var vb = svg.getAttribute('viewBox');\n  if (vb) {\n    var w = parseFloat(vb.split(/\\s+/)[2]);\n    if (w \u003e 0) {\n      svg.style.width = w + 'px';\n      svg.style.maxWidth = 'none';\n    }\n  }\n});\n```\n\nNew code (scale-to-fit):\n```javascript\ndocument.querySelectorAll('pre.mermaid svg').forEach(function(svg) {\n  var vb = svg.getAttribute('viewBox');\n  if (vb) {\n    var w = parseFloat(vb.split(/\\s+/)[2]);\n    if (w \u003e 0) {\n      var available = svg.closest('.diagram-viewport').clientWidth - 32; // subtract padding\n      if (w \u003e available) {\n        // SVG is wider than viewport — let it scale down proportionally\n        svg.style.width = '100%';\n        svg.style.maxWidth = '100%';\n      } else {\n        // SVG fits — render at natural pixel width for crisp text\n        svg.style.width = w + 'px';\n        svg.style.maxWidth = 'none';\n      }\n    }\n  }\n});\n```\n\nThis compares the SVG's natural width (from viewBox) to the available container width. If the SVG overflows, it sets `width: 100%` so the browser scales it down using the viewBox. If it fits, it keeps the original crisp pixel-width behavior.\n\n### `goifaces/internal/server/server.go` (CSS section, `.diagram-viewport`)\n\nNo CSS changes needed. The existing `overflow: auto` on `.diagram-viewport` serves as a fallback for extreme zoom levels.\n\n## Dependencies\n\n- This branch needs the Package Map feature from main (commit 0428e86 and caa3ef0) merged in before implementation\n- No external packages needed\n\n## Edge Cases \u0026 Error Handling\n\n1. **Window resize**: The fix is applied once after Mermaid renders. If the user resizes the browser window, the SVG won't re-adapt. This is acceptable for v1 — the user can refresh. If desired later, add a `resize` event listener that re-runs the width check.\n\n2. **Zoom interaction**: When the user zooms in (CSS transform scale), the SVG container grows. Since we set `width: 100%` on the SVG, it stays within the container boundaries and the zoom transform scales it up correctly. The `.diagram-viewport`'s `overflow: auto` provides scrollbars if the zoomed content exceeds the viewport.\n\n3. **Very small viewports**: On extremely narrow screens, the scaled-down flowchart text may become unreadable. The existing zoom-in button handles this — user can zoom in and scroll.\n\n4. **SVGs without viewBox**: The `if (vb)` guard already handles this — SVGs without a viewBox are left untouched.\n\n5. **Detail slides (class diagrams)**: These are typically narrower than the Package Map and will likely pass the `w \u003e available` check as false, preserving their current crisp rendering.\n\n## Testing Strategy\n\n### Manual Testing (Primary)\n1. Merge the Package Map feature from main into the working branch\n2. Run `goifaces` against a repo with many packages (e.g., the goifaces repo itself or a larger repo)\n3. Open in browser and verify:\n   - Package Map (slide 0) fits within the viewport without horizontal scrollbar\n   - Detail slides still render at full resolution (no unnecessary scaling)\n   - Zoom in/out works correctly on both Package Map and detail slides\n   - Keyboard navigation (arrow keys) still works\n4. Test at different browser widths (resize window) to confirm the fix works at various sizes\n\n### Automated Testing\n- Existing integration tests in `internal/integration_test.go` verify Mermaid generation — these should still pass since we're only changing client-side JS, not the Go diagram generation\n- Run `go test ./...` to confirm no regressions","status":"closed","priority":2,"issue_type":"bug","assignee":"nova","owner":"olesho@gmail.com","created_at":"2026-02-21T08:25:11.589696-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-21T09:00:08.642221-06:00","closed_at":"2026-02-21T09:00:08.642221-06:00","close_reason":"Fixed SVG width scaling: wide diagrams now scale to fit viewport while narrow ones keep crisp pixel-width rendering","dependencies":[{"issue_id":"test-loom-khd","depends_on_id":"test-loom-944","type":"blocks","created_at":"2026-02-21T08:25:15.178489-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-klm","title":"Cache cloned repos and use git pull instead of re-cloning","description":"When analyzing a remote GitHub repo, cache the clone in a stable location instead of a temp dir. On subsequent runs for the same repo, just git pull to update instead of a full clone. This avoids re-downloading large repos every time.","status":"closed","priority":2,"issue_type":"feature","owner":"olesho@gmail.com","created_at":"2026-02-21T09:03:12.927259-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-21T09:04:44.817288-06:00","closed_at":"2026-02-21T09:04:44.817288-06:00","close_reason":"Repos cached in ~/.cache/goifaces/repos/\u003chash\u003e. Second run uses git fetch + reset instead of full clone."}
{"id":"test-loom-lle","title":"Orphaned types not removed from slides","description":"The orphan post-filter in subResultForSplitGroup (slides.go:104-119) only removes interfaces with no relations on a slide, but does NOT remove types with no relations. This causes concrete types to appear as floating green boxes with no connections. Reproduced with pentagi repo: slides 18, 25, 29 each have an orphaned RawClient type. Fix: add symmetric post-filter for types after the existing interface filter.","status":"closed","priority":1,"issue_type":"bug","owner":"olesho@gmail.com","created_at":"2026-02-21T15:58:08.24133-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-21T16:02:01.048387-06:00","closed_at":"2026-02-21T16:02:01.048387-06:00","close_reason":"Fixed: added symmetric orphan post-filter for types in subResultForSplitGroup. Previously only interfaces were pruned; types with no surviving relations remained as floating boxes."}
{"id":"test-loom-mce","title":"Smoke test goifaces against real Go repositories","description":"Test the binary against real repos: 1) ./goifaces https://github.com/hashicorp/go-memdb 2) ./goifaces on the goifaces project itself 3) A large repo to stress-test. Verify diagrams render correctly, logs are valid JSONL, and edge cases (compile errors, missing deps) produce warnings not crashes.","status":"closed","priority":2,"issue_type":"task","owner":"olesho@gmail.com","created_at":"2026-02-19T09:05:41.428593-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T16:48:48.592292-06:00","closed_at":"2026-02-19T16:48:48.592292-06:00","close_reason":"Closed"}
{"id":"test-loom-nmi","title":"Fix missing checkbox label styles in sidebar sections","description":"After moving checkboxes from .entity-list to .sidebar-section-body, the CSS selectors for label display, gap, padding, hover, checkbox flex-shrink, and pkg-name styling no longer matched. Added .sidebar-section-body equivalents for all affected selectors.","status":"closed","priority":2,"issue_type":"bug","owner":"olesho@gmail.com","created_at":"2026-02-25T15:54:36.665884-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-25T15:55:44.540772-06:00","closed_at":"2026-02-25T15:55:44.540772-06:00","close_reason":"Added .sidebar-section-body selectors alongside .entity-list for label, label:hover, input[type=checkbox], and .pkg-name CSS rules. Also added dark mode hover rule."}
{"id":"test-loom-php","title":"Remove orphaned interfaces from chart slides","description":"Each generated slide might contain orphaned interfaces - those which don't have any implementation (struct/type) related to them on that slide. Remove such interfaces from the chart. This logic should be applied per-slide: if an interface has no implementing type on a given slide, it should be excluded from that slide's Mermaid diagram.","design":"## Summary\n\nWhen slides are split using the HubAndSpoke strategy, hub interfaces are replicated onto EVERY detail slide. However, on any given slide, some of these hub interfaces may have no implementing type (spoke) present. For example, if PrefixIndexer is a hub interface connected to 4 types, but a slide only contains 3 types that don't implement PrefixIndexer, then PrefixIndexer appears as an orphaned node with no arrows. This task removes such per-slide orphaned interfaces so each detail slide only shows interfaces that have at least one implementing type on that slide.\n\n## Technical Approach\n\n**Where to apply the fix:** In `subResultForSplitGroup()` in `internal/diagram/slides.go`.\n\nThis function already correctly filters relations to only those where both the interface AND type are present in the group. The problem is that `sub.Interfaces` includes ALL interfaces from the group's `HubKeys`, even if none of their relations survived the relation filter. The fix is a post-filter step: after collecting relations, build a set of interface keys that participate in at least one relation, then trim `sub.Interfaces` to only those.\n\n**Why this location:** The splitter's job is node classification (hub vs spoke). The `subResultForSplitGroup` function is responsible for producing the final per-slide Result. Filtering orphans at this stage is clean, doesn't change the splitter contract, and naturally applies only to detail slides (the overview slide and full diagram slide don't go through this function).\n\n**Why NOT touch the splitter:** Hub interfaces should remain in every group's HubKeys for the splitter's correctness — they may have relations on some slides but not others. Removing them from HubKeys would break the splitter abstraction. The filtering belongs at the Result-assembly level.\n\n**Trade-off:** An interface might appear on zero detail slides if it's a hub but all its implementing types happen to share slides with other types. This is acceptable — the interface still appears on the overview slide, and showing it on a detail slide with no connections would be confusing.\n\n## Files to Modify\n\n### 1. `goifaces/internal/diagram/slides.go`\n**Function: `subResultForSplitGroup()`** (lines 66-106)\n\nAfter the existing relation-filtering loop (lines 97-103), add a post-filter step:\n1. Build a set of interface keys that appear in at least one relation in `sub.Relations`\n2. Filter `sub.Interfaces` to only those whose key is in that set\n\nPseudocode:\n```go\n// After the existing relation loop...\n\n// Post-filter: remove interfaces with no relations on this slide\nusedIfaces := make(map[string]bool)\nfor _, rel := range sub.Relations {\n    ik := typeKey(rel.Interface.PkgPath, rel.Interface.Name)\n    usedIfaces[ik] = true\n}\nvar filteredIfaces []analyzer.InterfaceDef\nfor _, iface := range sub.Interfaces {\n    ik := typeKey(iface.PkgPath, iface.Name)\n    if usedIfaces[ik] {\n        filteredIfaces = append(filteredIfaces, iface)\n    }\n}\nsub.Interfaces = filteredIfaces\n```\n\nThis is ~10 lines of straightforward Go. No new functions needed.\n\n## Files to Create\n\nNone.\n\n## Dependencies\n\nNo external packages needed. This uses only existing data structures and patterns.\n\n## Edge Cases \u0026 Error Handling\n\n1. **Interface on zero detail slides:** If a hub interface's implementing types all cluster onto slides where they share other hubs, the interface may not appear on any detail slide. This is correct — it still shows on the overview slide.\n\n2. **Non-hub interfaces:** These are attached to chunks based on their connected types, so they should always have at least one relation on their slide. The post-filter handles the edge case where this invariant breaks (e.g., if the attachment logic has a bug).\n\n3. **Empty sub.Relations:** If a group has no surviving relations (unusual but possible), all interfaces get filtered out, leaving an empty diagram. This is correct behavior — an empty slide would be pruned or show only type blocks.\n\n4. **Overview slide:** Not affected — `generateOverviewMermaid()` is called directly on the full result, not through `subResultForSplitGroup()`.\n\n5. **Full diagram (single-slide mode):** Not affected — uses `GenerateMermaid()` directly on the full filtered result.\n\n## Testing Strategy\n\n### Update existing test\n**`TestHubAndSpokeSlides` in `internal/integration_test.go`** (lines 322-439):\nThe current test asserts all 4 hub interfaces appear on EVERY detail slide. After the fix, only hubs with implementing types on that slide should appear. Update the test to:\n- Instead of asserting all hubs on all slides, verify that each hub appears only on slides where it has at least one connected type\n- PrefixIndexer connects to: StringFieldIndex, StringMapFieldIndex, StringSliceFieldIndex, CompoundIndex — should only appear on slides containing these types\n- ResultIterator connects to: FilterIterator — should only appear on the slide containing FilterIterator\n- Indexer, MultiIndexer, SingleIndexer connect to all 11 field index types — should appear on all slides except the one with only FilterIterator (if such a slide exists)\n\n### Add new targeted test\nAdd a test `TestOrphanedInterfacesRemovedFromSlides` in `internal/integration_test.go` that:\n1. Creates a synthetic result with 2 hub interfaces (A connects to X,Y,Z; B connects to only Z)\n2. Splits into groups where X,Y are on slide 1 and Z is on slide 2\n3. Asserts: slide 1 contains hub A but NOT hub B (B is orphaned on slide 1)\n4. Asserts: slide 2 contains both hub A and hub B\n\n### Visual verification\nRun `bash scripts/visual-verify.sh` after implementation to confirm SVG output looks clean.\n\n### Manual verification\nRun the tool against a real Go repo (e.g., go-memdb) and visually inspect that detail slides no longer show disconnected interface nodes.","status":"closed","priority":2,"issue_type":"task","assignee":"nova","owner":"olesho@gmail.com","created_at":"2026-02-21T08:09:56.652447-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-21T08:22:22.404388-06:00","closed_at":"2026-02-21T08:22:22.404388-06:00","close_reason":"Completed with tests and code review"}
{"id":"test-loom-pww","title":"Add padding/margin to treemap blocks in Package Map (html) tab","description":"The treemap blocks in the Package Map (html) tab are too tight against the borders of their outer container boxes. Add outer padding or margin so there's breathing room between the blocks and the container edges. This is a CSS-only follow-up to test-loom-376.","design":"## Summary\n\nAdd visual spacing (padding/margin) between treemap blocks in the Package Map (html) tab. Currently, blocks are nearly flush against each other and their container edges, making the visualization look cramped. This is a CSS-only follow-up to test-loom-376, but requires a small JS change since the blocks use absolute pixel positioning from the squarify algorithm.\n\n## Technical Approach\n\nSince treemap blocks are absolutely positioned with exact pixel coordinates computed by the squarify algorithm, CSS margin/padding alone cannot create gaps between sibling blocks. The standard treemap technique is to apply an **inset** to each rendered rectangle's coordinates — shrinking each block by a few pixels on all sides.\n\n**Approach**: Add a constant gap (2px per side) applied as an inset during rendering. Each block's position is adjusted: x += gap, y += gap, w -= 2*gap, h -= 2*gap. Also increase the inner padding of group containers so child blocks don't touch the group border.\n\n**Trade-off**: A 2px gap provides clear breathing room without significantly affecting readability of small blocks. The gap is applied uniformly at all nesting levels.\n\n## Files to Create\n\nNone.\n\n## Files to Modify\n\n### 1. `goifaces/internal/server/server.go`\n\nAll changes are within the JavaScript portion of the HTML template.\n\n#### 1a. Add a gap constant (near line 585, before `renderTreemap`)\n```js\nvar TREEMAP_GAP = 2;\n```\n\n#### 1b. Apply inset to group node positions (line 606-609)\nChange from:\n```js\ngroup.style.left = p.x + 'px';\ngroup.style.top = p.y + 'px';\ngroup.style.width = Math.max(0, p.w) + 'px';\ngroup.style.height = Math.max(0, p.h) + 'px';\n```\nTo:\n```js\ngroup.style.left = (p.x + TREEMAP_GAP) + 'px';\ngroup.style.top = (p.y + TREEMAP_GAP) + 'px';\ngroup.style.width = Math.max(0, p.w - 2 * TREEMAP_GAP) + 'px';\ngroup.style.height = Math.max(0, p.h - 2 * TREEMAP_GAP) + 'px';\n```\n\n#### 1c. Increase group inner rect padding (line 619)\nChange from:\n```js\nvar innerRect = {x: 1, y: headerH, w: Math.max(0, p.w - 2), h: Math.max(0, p.h - headerH - 1)};\n```\nTo:\n```js\nvar gw = p.w - 2 * TREEMAP_GAP;\nvar gh = p.h - 2 * TREEMAP_GAP;\nvar innerPad = 3;\nvar innerRect = {x: innerPad, y: headerH, w: Math.max(0, gw - 2 * innerPad), h: Math.max(0, gh - headerH - innerPad)};\n```\nThis increases inner padding from 1px to 3px on each side and adds bottom padding.\n\n#### 1d. Apply inset to leaf node positions (line 662-666)\nChange from:\n```js\nnode.style.left = p.x + 'px';\nnode.style.top = p.y + 'px';\nnode.style.width = Math.max(0, p.w) + 'px';\nnode.style.height = Math.max(0, p.h) + 'px';\n```\nTo:\n```js\nnode.style.left = (p.x + TREEMAP_GAP) + 'px';\nnode.style.top = (p.y + TREEMAP_GAP) + 'px';\nnode.style.width = Math.max(0, p.w - 2 * TREEMAP_GAP) + 'px';\nnode.style.height = Math.max(0, p.h - 2 * TREEMAP_GAP) + 'px';\n```\n\n#### 1e. Adjust height thresholds for label visibility (lines 639, 645, 670, 676)\nSince blocks are now slightly smaller (by 4px total), adjust the visibility thresholds down by 4px to maintain the same effective behavior:\n- Change `selfH \u003e= 20` to `selfH \u003e= 16` (line 639)\n- Change `selfH \u003e= 35` to `selfH \u003e= 31` (line 645)\n- Change `p.h \u003e= 20` to `(p.h - 2 * TREEMAP_GAP) \u003e= 20` (line 670) — use effective height\n- Change `p.h \u003e= 35` to `(p.h - 2 * TREEMAP_GAP) \u003e= 35` (line 676)\n\n## Dependencies\n\nNone. This is a purely visual tweak with no external dependencies.\n\n## Edge Cases \u0026 Error Handling\n\n1. **Very small blocks**: When a block's size minus the gap would be negative, `Math.max(0, ...)` ensures it clamps to 0. No visual artifacts.\n2. **Single block filling entire container**: Gap still applies, creating a subtle border effect around the single block.\n3. **Deeply nested groups**: Gap applies uniformly at each level. The compound effect is acceptable since nesting is capped at 3 levels.\n4. **Self-node inside a group**: The self-node uses innerRect positioning (within the group), so it benefits from the increased innerPad without needing its own TREEMAP_GAP offset.\n\n## Testing Strategy\n\n### Automated\n- All existing tests must still pass (`go test ./...`). No data structures change — only rendering pixel offsets.\n- No new tests needed since this is a visual-only change with no behavioral impact.\n\n### Manual verification\n1. Run `go run . \u003crepo-path\u003e` and open the browser\n2. Click 'Package Map (html)' tab\n3. Verify visible gaps between all treemap blocks (leaf nodes and groups)\n4. Verify blocks don't touch the edges of their parent group containers\n5. Verify labels still appear on adequately-sized blocks\n6. Verify dark mode renders correctly with the same gaps\n7. Verify window resize recalculates layout with correct gaps\n8. Verify the existing 'Package Map' (Mermaid) tab is unaffected","status":"closed","priority":2,"issue_type":"task","assignee":"falcon","owner":"olesho@gmail.com","created_at":"2026-02-22T08:44:11.591267-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-22T09:15:29.409136-06:00","closed_at":"2026-02-22T09:15:29.409136-06:00","close_reason":"Completed: added TREEMAP_GAP=2 inset to group and leaf nodes, increased innerPad to 3, adjusted label visibility thresholds. Code review passed.","labels":["auto-merge"]}
{"id":"test-loom-raw","title":"Left-align interface methods in definitions block","description":"In the Mermaid/HTML interface definitions block, interface methods are currently centered or have inconsistent alignment. They should be left-aligned for better readability. Implementation should include tests. Auto-merge when complete (no review needed).","design":"## Summary\n\nInterface methods in Mermaid class diagram nodes are rendered with `text-align: center` by Mermaid v11's default inline styling. This CSS override ensures methods are consistently left-aligned within their interface boxes for better readability, matching standard UML class diagram conventions.\n\n## Technical Approach\n\nMermaid v11 renders class diagram content using `\u003cforeignObject\u003e` elements containing HTML `\u003cdiv\u003e` elements, not SVG `\u003ctext\u003e` elements. Each method gets its own foreignObject with an inline style including `text-align: center`. The fix is a single CSS rule with `!important` to override this inline style for the methods-group specifically.\n\n**Key finding from live inspection:**\n- SVG structure: `g.node \u003e g.methods-group.text \u003e g.label \u003e foreignObject \u003e div[style=\"...text-align: center...\"]`\n- The `methods-group` class uniquely identifies method containers (vs `label-group` for titles, `annotation-group` for stereotypes, `members-group` for attributes)\n- CSS `!important` successfully overrides the inline `text-align: center`\n\n**Why CSS-only (no JS post-processing needed):**\n- The foreignObject widths are already sized to fit content, so position adjustments are unnecessary\n- CSS `text-align: left !important` cleanly overrides the inline style\n- This approach is minimal, maintainable, and doesn't interfere with Mermaid's layout calculations\n\n## Files to Modify\n\n### 1. `goifaces/internal/server/server.go` (lines ~248-278, CSS section)\n\nAdd one CSS rule after the existing Mermaid font-size overrides (after line 254):\n\n```css\n/* Left-align interface methods in class diagram nodes */\n.mermaid svg .methods-group foreignObject div {\n  text-align: left !important;\n}\n```\n\nThis targets only the methods compartment (`methods-group`) of class diagram nodes, leaving titles, annotations, and member attributes unaffected.\n\n### 2. `goifaces/internal/integration_test.go` (add new test)\n\nAdd a test that verifies the HTML template contains the left-alignment CSS rule. This follows the pattern of existing tests that check for specific content in the generated output. The test should:\n\n1. Execute the template with mock data (similar to `TestPrepareInteractiveData`)\n2. Assert the rendered HTML contains the CSS rule `text-align: left` targeting `.methods-group`\n\nAlternatively, a simpler approach: add a test function `TestMethodsLeftAlignCSS` that:\n- Reads the raw template string from the `serveInteractive` function or the embedded template\n- Asserts it contains `methods-group` and `text-align: left`\n\n**Note:** The template is defined as a raw string literal in `server.go`. To test it without starting a server, the test could:\n- Import the server package and check an exported template constant, OR\n- Use `httptest` to serve and check the HTML response, OR\n- Simply add an assertion in the existing integration test that checks the HTML output contains the expected CSS\n\nThe simplest approach: since `server.go` uses `template.Must(template.New(\"\").Parse(...))` with the template as a string literal, expose the template content via a package-level variable or function for testing, OR use `net/http/httptest` to render the page and check it contains the CSS rule.\n\n## Dependencies\n\nNone. This is a pure CSS change to the existing HTML template.\n\n## Edge Cases \u0026 Error Handling\n\n- **Single method interfaces**: Left-alignment has minimal visual difference since the foreignObject fits tightly, but the rule still ensures correct alignment\n- **Multi-method interfaces with varying lengths**: This is where the fix matters most - shorter methods won't be centered within the wider container\n- **Method truncation** (`...` when MaxMethodsPerBox exceeded): The truncation indicator is also in methods-group and will also be left-aligned, which is correct\n- **Members-group**: Not affected by this rule (separate CSS class). If members (attributes) need left-alignment too, the same pattern can be applied\n\n## Testing Strategy\n\n1. **Unit test**: Add `TestMethodsLeftAlignCSS` in `integration_test.go` that verifies the HTML template contains the `.methods-group` left-alignment CSS rule\n2. **Manual verification**: Run `go run . ./testdata/03_multi_iface`, select interfaces in the Interfaces tab, and confirm methods appear left-aligned in the blue interface boxes\n3. **Existing tests**: Run `go test ./...` to ensure no regressions - the CSS change doesn't affect any existing Mermaid syntax output tests","status":"closed","priority":2,"issue_type":"task","assignee":"falcon","owner":"olesho@gmail.com","created_at":"2026-02-22T07:13:36.151022-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-22T08:24:29.285984-06:00","closed_at":"2026-02-22T08:24:29.285984-06:00","close_reason":"Completed: added CSS left-alignment rule and test","labels":["auto-merge"]}
{"id":"test-loom-rtc","title":"Treemap blocks too small: set min dimensions so text is never hidden","status":"closed","priority":1,"issue_type":"bug","owner":"olesho@gmail.com","created_at":"2026-02-24T07:39:06.846599-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-24T07:48:02.27567-06:00","closed_at":"2026-02-24T07:48:02.27567-06:00","close_reason":"Fixed: CSS min dimensions + sqrt value scaling"}
{"id":"test-loom-snp","title":"Scaffold goifaces project structure","description":"go mod init, directory structure, .golangci.yml, .githooks/pre-commit, .gitignore, git init with custom hooks path","status":"closed","priority":1,"issue_type":"task","owner":"olesho@gmail.com","created_at":"2026-02-19T09:05:22.110035-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T09:05:26.501622-06:00","closed_at":"2026-02-19T09:05:26.501622-06:00","close_reason":"Project scaffolded with all dirs, configs, and git hooks"}
{"id":"test-loom-uir","title":"Include package paths in Package Map Mermaid drawing","description":"The Package Map Mermaid diagram currently shows only package names (e.g. 'analyzer', 'server'). It should also display the full package path (e.g. 'github.com/user/repo/internal/analyzer') so users can distinguish packages with the same short name and understand the module structure at a glance.\n\n## Current Behavior\n- Package Map (slide 0 / Package Map tab) shows package names with stats like 'analyzer\\n3 ifaces, 5 types'\n- Generated by GeneratePackageMapMermaid() in goifaces/internal/diagram/slides.go\n- No package path information is visible in the rendered diagram\n\n## Desired Behavior\n- Each package node in the Package Map should display its full package path\n- Example label: 'internal/analyzer\\n3 ifaces, 5 types' or similar format showing the path relative to the module root\n\n## Key Files\n- goifaces/internal/diagram/slides.go — GeneratePackageMapMermaid() builds the package map flowchart\n- goifaces/internal/analyzer/types.go — InterfaceDef.PkgPath, TypeDef.PkgPath hold the full paths","design":"## Summary\n\nThe Package Map currently labels each package node with just the short package name (e.g. \\\"analyzer\\\") plus stats. This task adds the module-relative package path (e.g. \\\"internal/analyzer\\\") to each node label so users can distinguish packages with the same short name and understand the module structure at a glance.\n\n## Technical Approach\n\nThe current `formatPkgLabel(name, stats)` function receives only the short package name. The fix is straightforward: pass the relative package path instead of the short name, so the label reads e.g. \\\"internal/analyzer\\n3 ifaces, 5 types\\\". The relative path is already computed during tree construction (the \\`rel\\` variable in `GeneratePackageMapMermaid`) but is discarded — only individual segments are passed down. We need to store the relative path on the `pkgNode` struct and use it as the display label.\n\n### Why relative path, not full path?\nThe full module path (e.g. \\\"github.com/user/repo/internal/analyzer\\\") is too long and clutters the diagram. The existing code already strips the common prefix / module root — we should use the same relative path that's already computed for tree construction.\n\n### Key design decision\nFor leaf nodes (packages with no subpackages), the label should show the full relative path. For packages inside subgraphs, the subgraph title already provides parent context, so showing just the segment name would create redundancy with the subgraph label. However, showing the full relative path is more informative and consistent. We'll show the full relative path for all nodes.\n\nActually, on closer inspection: subgraph titles already show segment names (line 295: the subgraph title is just `name`). For leaf nodes inside subgraphs, the segment name is sufficient since the subgraph provides context. For top-level leaf nodes, the relative path should be shown. But this creates inconsistency. The simplest approach that matches the issue description is:\n\n**Show the relative path as the first line of every package node label.** For subgraph titles, keep the short segment name (they serve as grouping headers). For the inner stat nodes and leaf nodes, use the relative path.\n\n## Files to Modify\n\n### 1. `goifaces/internal/diagram/slides.go`\n\n**Change `pkgNode` struct** (line 248-254):\n- Add a `relPath` field to store the module-relative package path\n\n**Change `insertNode`** (line 256-272):\n- Accept the relative path and store it on the node\n\n**Change `GeneratePackageMapMermaid`** (line 171-246):\n- Pass the relative path (`rel`) to `insertNode` so it gets stored on `pkgNode`\n\n**Change `renderTree`** (line 274-319):\n- For leaf nodes: pass `child.relPath` (or fall back to `child.name`) to `formatPkgLabel` instead of `name`\n- For inner self-nodes in subgraphs: pass `child.relPath` to `formatPkgLabel`\n\n**Change `formatPkgLabel`** (line 322-337):\n- No signature change needed — the `name` parameter will now receive the relative path instead of the short name\n\n### 2. `goifaces/internal/integration_test.go`\n\n**Update `TestPackageMapMultiPackage`** (line 469):\n- Update assertions: instead of checking for just \\\"io\\\", \\\"http\\\", \\\"router\\\" in labels, check for the relative paths like \\\"io\\\", \\\"http\\\", \\\"http/router\\\"\n- The relative paths from \\\"example.com/mylib/\\\" prefix stripping will be \\\"io\\\", \\\"http\\\", \\\"http/router\\\"\n\n**Update `TestFormatPkgLabel`** (line 527):\n- The \\\"both_ifaces_and_types\\\" subtest asserts `\\\"mypkg\\\\n2 ifaces, 3 types\\\"` — this will change to the relative path. Since the test uses only one package \\\"example.com/proj/mypkg\\\", the relative path after prefix stripping will be \\\"mypkg\\\" — so this assertion may actually remain the same\n- The \\\"only_interfaces\\\" subtest asserts `\\\"ifonly\\\\n2 ifaces\\\"` — similarly, the relative paths will be \\\"mypkg\\\" and \\\"ifonly\\\" after stripping \\\"example.com/proj/\\\" prefix, so these assertions also remain valid\n- **If any assertions need updating due to multi-segment relative paths, update them to match the new relative path format**\n\n## Implementation Details\n\n### Step 1: Add `relPath` to `pkgNode`\n```go\ntype pkgNode struct {\n    name     string\n    relPath  string    // module-relative path (e.g. \"internal/analyzer\")\n    pkgPath  string\n    stats    *pkgStats\n    children map[string]*pkgNode\n}\n```\n\n### Step 2: Store relPath in `insertNode`\n```go\nfunc insertNode(parent *pkgNode, parts []string, fullPath string, relPath string, s *pkgStats) {\n    // ... existing logic ...\n    if len(parts) == 1 {\n        child.pkgPath = fullPath\n        child.relPath = relPath\n        child.stats = s\n    } else {\n        insertNode(child, parts[1:], fullPath, relPath, s)\n    }\n}\n```\n\n### Step 3: Pass relPath from `GeneratePackageMapMermaid`\nIn the tree-building loop:\n```go\nfor _, p := range paths {\n    rel := strings.TrimPrefix(p, prefix)\n    if rel == \"\" {\n        rel = lastSegment(p)\n    }\n    parts := strings.Split(rel, \"/\")\n    insertNode(root, parts, p, rel, stats[p])\n}\n```\n\n### Step 4: Use relPath in `renderTree`\nFor leaf nodes and inner self-nodes, use `child.relPath` if non-empty, otherwise fall back to `child.name`:\n```go\ndisplayName := child.relPath\nif displayName == \"\" {\n    displayName = child.name\n}\nlabel := formatPkgLabel(displayName, child.stats)\n```\n\n## Edge Cases \u0026 Error Handling\n\n1. **Single package**: When there's only one package, `longestCommonPrefix` strips everything up to the last `/`, leaving just the package name. The relative path will be the short name — no change in behavior.\n\n2. **Deeply nested packages**: e.g. \\\"internal/http/middleware/auth\\\" — the full relative path will be shown, which is the desired behavior.\n\n3. **Root module package**: If a package path equals the module path, `rel` becomes empty and falls back to `lastSegment`. The `relPath` will be set to this fallback value.\n\n4. **Subgraph titles remain short**: Subgraph titles (`subgraph id[\\\"name\\\"]`) continue to use the short segment name for clean grouping. Only the stat-bearing node labels show the full relative path.\n\n5. **Mermaid label escaping**: The relative path contains `/` characters inside a quoted label `[\\\"...\\\"]`. Mermaid handles `/` in quoted labels correctly — no escaping needed.\n\n## Testing Strategy\n\n1. **Update existing tests** in `TestPackageMapMultiPackage` and `TestFormatPkgLabel` to assert relative paths appear in labels\n2. **Add a test case** for deeply nested packages to verify multi-segment paths display correctly (e.g. \\\"http/router\\\" should appear, not just \\\"router\\\")\n3. **Run `go test ./...`** to verify all tests pass\n4. **Run `bash scripts/visual-verify.sh`** and visually inspect SVG output to confirm package paths render correctly in the diagram\n5. **Run `golangci-lint run ./...`** to ensure no lint violations\n\n## Dependencies\n- No external packages needed\n- No other tasks need to be completed first","status":"closed","priority":2,"issue_type":"task","assignee":"spark","owner":"olesho@gmail.com","created_at":"2026-02-21T17:17:37.923974-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-21T17:57:27.931069-06:00","closed_at":"2026-02-21T17:57:27.931069-06:00","close_reason":"Completed: added relPath to pkgNode, updated insertNode/renderTree to display module-relative paths in Package Map labels, added tests for deeply nested paths and subgraph title invariant, updated docs"}
{"id":"test-loom-ume","title":"Add subtle color variability to Package Map blocks","description":"The blocks in the Package Map visualization are hard to differentiate from each other. Add color variability so each block has a distinct but subtle color when generating the chart. Keep colors muted/pastel — don't make them too bright.","design":"## Summary\n\nAdd subtle color variability to Package Map blocks so each package node has a distinct but muted/pastel background color. Currently all blocks use Mermaid's default white/grey styling, making packages hard to differentiate visually. After this change, each leaf and subgraph node in the Package Map flowchart will get a unique pastel color from a predefined palette, applied via Mermaid's `style` directive for leaf nodes and `classDef`/`class` for subgraphs.\n\n## Technical Approach\n\n**Approach:** Use Mermaid's inline `style` statements for leaf nodes and `classDef`/`class` for subgraphs to assign per-node colors from a fixed palette of muted/pastel colors. The colors cycle deterministically based on sorted package order, ensuring consistent output across runs.\n\n**Palette:** Define a Go slice of ~10 pastel color structs (`{fill, stroke, textColor}`), e.g.:\n- `#e8f4fd` / `#b8d4e8` (light blue)\n- `#e8f5e9` / `#b8d8ba` (light green)\n- `#fff3e0` / `#e8c9a0` (light orange)\n- `#f3e5f5` / `#d1b3d8` (light purple)\n- `#fce4ec` / `#e8b0bf` (light pink)\n- `#e0f2f1` / `#b0d4d1` (light teal)\n- `#fff9c4` / `#e8dea0` (light yellow)\n- `#e8eaf6` / `#b8bce8` (light indigo)\n- `#efebe9` / `#c8b8ad` (light brown)\n- `#f1f8e9` / `#c4dba0` (light lime)\n\nAll text stays `#333333` (dark) for readability on pastel backgrounds. These are intentionally muted — not bright or saturated.\n\n**Color assignment:** Each node (leaf node or subgraph) gets assigned a color index based on its position in the sorted package list, cycling through the palette with modulo. Subgraphs that are purely organizational (no stats, only children) still get a color so they're visually distinct containers.\n\n**Implementation strategy:**\n- For **leaf nodes** (no children): append a `style \u003cnodeID\u003e fill:\u003cfill\u003e,stroke:\u003cstroke\u003e,color:\u003ctextColor\u003e` line after all nodes are rendered\n- For **subgraphs**: use `classDef` at the top of the flowchart to define color classes (`pkgColor0`, `pkgColor1`, etc.), then apply them to subgraphs via Mermaid's `class` statement. Mermaid v11 supports `class subgraphId className` to style subgraph backgrounds.\n\n**Trade-offs:**\n- Fixed palette vs hash-based: A fixed palette guarantees visually pleasing, tested colors. Hash-based could produce clashing colors. Fixed palette with modulo cycling is simpler and more predictable.\n- Inline `style` vs `classDef`: For leaf nodes, inline `style` is simplest since each node needs a unique color. For subgraphs, `classDef` + `class` is the supported Mermaid mechanism.\n- Color count (10): Enough variety for typical Go projects (5-15 packages). Beyond 10 packages, colors cycle — but adjacent packages in the tree are unlikely to share colors due to sorted ordering.\n\n## Files to Create\n\nNone. All changes fit within the existing `slides.go` file in the package map rendering functions.\n\n## Files to Modify\n\n### `goifaces/internal/diagram/slides.go` (on main branch)\n\n**1. Add a `pastelPalette` variable** (package-level):\nDefine a slice of structs `{Fill string, Stroke string, Text string}` with ~10 pastel color entries. Place near the existing `pkgStats` type.\n\n**2. Modify `generatePackageMapMermaid`**:\n- After building the tree and writing the `flowchart LR` header, emit `classDef` lines for each palette entry: `classDef pkgColor0 fill:#e8f4fd,stroke:#b8d4e8,color:#333333` etc.\n- Pass a color index counter (starting at 0) into `renderTree` so it can assign colors.\n- After the tree rendering, append `style` lines for leaf nodes and `class` lines for subgraphs collected during rendering.\n\n**3. Modify `renderTree`** signature and behavior:\n- Add a `*int` parameter for the color counter (pointer so it increments globally across recursion).\n- For each child node processed (both subgraphs and leaf nodes), record the node ID and its assigned color index in a collector slice (passed by pointer or returned).\n- The actual `style`/`class` lines should be collected and emitted after all subgraph declarations are complete (Mermaid requires style statements outside subgraph blocks).\n\nSpecifically, change `renderTree` to:\n```go\ntype nodeStyle struct {\n    id          string\n    colorIdx    int\n    isSubgraph  bool\n}\n\nfunc renderTree(b *strings.Builder, node *pkgNode, depth int, colorIdx *int, styles *[]nodeStyle)\n```\n\nIn each iteration:\n- Assign the current `*colorIdx` to this node\n- Append a `nodeStyle{id, *colorIdx, isSubgraph}` to the styles slice\n- Increment `*colorIdx`\n- After `renderTree` returns in `generatePackageMapMermaid`, iterate over collected styles and emit:\n  - For subgraphs: `\\n    class \u003cid\u003e pkgColor\u003cN\u003e`\n  - For leaf nodes: `\\n    style \u003cid\u003e fill:\u003cfill\u003e,stroke:\u003cstroke\u003e,color:\u003ctext\u003e`\n\n### `goifaces/internal/integration_test.go` (on main branch)\n\n**Update `TestHubAndSpokeSlides`:**\n- Add assertion that the package map contains `classDef pkgColor0` to verify color definitions are present.\n\n**Update `TestPackageMapMultiPackage`:**\n- Add assertions checking that:\n  - The output contains `classDef pkgColor0` (at least one color class defined)\n  - The output contains `style` or `class` lines (colors are applied)\n  - Multiple color classes are defined (at least 2 for multi-package repos)\n\n### `goifaces/docs/architecture.md`\n- Update the Package Map description to mention pastel color variability for visual differentiation.\n\n## Dependencies\n\n- No new external packages needed\n- Depends on Mermaid v11's support for `classDef`/`class` on subgraphs (already confirmed working in the project's existing browser rendering)\n- This change is compatible with the related bugs (test-loom-cmz for external package filtering, test-loom-khd for width) — colors are orthogonal to those fixes\n\n## Edge Cases \u0026 Error Handling\n\n1. **Single package:** Gets one color. No issue — still visually distinct from default grey.\n2. **More packages than palette colors (\u003e10):** Colors cycle via modulo. Adjacent packages in the tree may rarely share colors, but the tree nesting provides sufficient visual separation.\n3. **Empty package map (no types):** The early return for `len(stats) == 0` already handles this — returns bare `flowchart LR` with no nodes, no style statements needed.\n4. **Nested subgraph + leaf at same level:** Both get colors from the same counter, so they'll be different colors even when siblings.\n5. **IncludeInit mode (standalone .mmd files):** The `%%{init:}%%` directive uses base theme. The inline `style`/`classDef` statements override the theme defaults, which is the desired behavior.\n\n## Testing Strategy\n\n### Unit Tests (update existing in integration_test.go)\n1. **TestHubAndSpokeSlides:** Assert package map contains at least one `classDef pkgColor` definition\n2. **TestPackageMapMultiPackage:** Assert:\n   - Output contains `classDef pkgColor0` and `classDef pkgColor1` (multiple colors for multiple packages)\n   - Output contains `class` or `style` statements applying colors to nodes\n   - Color fill values are from the pastel palette (`#e8f4fd`, `#e8f5e9`, etc.)\n\n### Manual Verification\n3. Run `bash scripts/visual-verify.sh` after implementation to render SVGs\n4. Use Read tool on output SVGs to visually verify pastel colors appear\n5. Run the tool on a real Go project and verify in browser that:\n   - Each package block has a distinct pastel background\n   - Colors are muted/not too bright\n   - Text remains readable on all backgrounds\n   - Subgraph containers have colored backgrounds\n   - The visual effect is subtle and professional","status":"closed","priority":2,"issue_type":"task","assignee":"spark","owner":"olesho@gmail.com","created_at":"2026-02-21T08:29:49.201524-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-21T09:05:50.405836-06:00","closed_at":"2026-02-21T09:05:50.405836-06:00","close_reason":"Completed with tests and code review","dependencies":[{"issue_id":"test-loom-ume","depends_on_id":"test-loom-944","type":"blocks","created_at":"2026-02-21T08:29:52.215668-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-v2e","title":"Sidebar sections should work as accordion — only one expanded at a time","description":"When the Implementations list is expanded, it pushes the Interfaces section down and can hide it off-screen. The two collapsible sections should behave as an accordion: expanding one auto-collapses the other. Both section headers must always remain visible and accessible. Currently both can be open simultaneously which causes overflow issues on the sidebar.","status":"closed","priority":2,"issue_type":"bug","owner":"olesho@gmail.com","created_at":"2026-02-25T14:28:56.586297-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-25T15:09:12.454681-06:00","closed_at":"2026-02-25T15:09:12.454681-06:00","close_reason":"Added accordion behavior: expanding one sidebar section auto-collapses the other. Only Implementations starts open. Both headers always visible."}
{"id":"test-loom-vnu","title":"Implement main.go CLI entry point","description":"main.go - flag parsing (path, port, filter, include-stdlib, include-unexported, output, no-browser, log-file, log-level), pipeline orchestration, signal handling","status":"closed","priority":1,"issue_type":"task","owner":"olesho@gmail.com","created_at":"2026-02-19T09:06:24.159055-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T09:06:27.84161-06:00","closed_at":"2026-02-19T09:06:27.84161-06:00","close_reason":"Full pipeline wired: resolve → analyze → filter → enrich → diagram → serve/write"}
{"id":"test-loom-wa8","title":"Design splitter abstraction as a decoupled module","description":"Create a Splitter interface in internal/diagram/split/ (new subpackage) that takes an *analyzer.Result and returns []Slide. The interface should be strategy-based so we can swap different splitting algorithms without touching the rest of the codebase.\n\nKey design:\n- type Splitter interface { Split(result *analyzer.Result, opts SplitOptions) []Slide }\n- SplitOptions carries config: max implementations per slide, min connections to be 'reusable', etc.\n- The existing BuildSlides() in slides.go becomes a thin wrapper that delegates to a Splitter\n- Splitters are composed in main.go, not hardcoded\n\nThis is the abstraction layer only — no concrete strategy implementation.","status":"closed","priority":1,"issue_type":"task","owner":"olesho@gmail.com","created_at":"2026-02-19T17:07:15.357225-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T19:19:24.209267-06:00","closed_at":"2026-02-19T19:19:24.209267-06:00","close_reason":"Implemented in hub-and-spoke slide splitting session: split package with Splitter interface, HubAndSpoke strategy, CLI flags, integration tests. All tests + linter pass."}
{"id":"test-loom-xf7","title":"Remove method names from implementation blocks in Mermaid diagrams","description":"Remove method names from implementation (green) blocks in Mermaid class diagrams. Methods are already shown in interface blocks, so impl blocks should only display the struct name. This reduces visual clutter especially for large repos like go-memdb.\n\nChanges needed:\n1. internal/diagram/mermaid.go - writeTypeBlock: stop writing method lines, just emit class name + source file comment. Remove now-unused buildRelevantMethodsMap function. Remove relevantSet passing from GenerateMermaid.\n2. internal/diagram/slides.go - generateOverviewMermaid: add 'direction LR' after classDiagram (was missed in previous LR change).\n3. internal/integration_test.go - TestHubAndSpokeSlides overview assertion (line 422) checks no '+' lines — still valid. Detail slide assertions are fine since methods come from interface blocks.\n4. Run go test ./..., golangci-lint run ./..., bash scripts/visual-verify.sh (rebuild binary first with go build -o goifaces .)\n5. Update docs/architecture.md to note impl blocks show only type names.\n\nNOTE: mermaid.go already has partial edits applied (buildRelevantMethodsMap removed, writeTypeBlock simplified, relevantSet removed from GenerateMermaid call). Verify the current state and complete any remaining work.","design":"## Summary\n\nThis task removes method names from implementation (green) blocks in Mermaid class diagrams. Methods are already shown in interface (blue) blocks, so repeating them in impl blocks is redundant visual clutter — especially for large repos like go-memdb with many implementations. The task also ensures slides.go has 'direction LR' in the overview diagram, and updates architecture documentation.\n\n**NOTE: The code changes described in the task description have already been applied to the codebase.** The implementing agent's primary job is to VERIFY the current state is correct and run the full validation pipeline (tests, lint, visual-verify).\n\n## Technical Approach\n\nThe approach is straightforward: `writeTypeBlock` in mermaid.go was simplified to only emit the struct name and source file comment — no method lines. The `buildRelevantMethodsMap` function (which built a lookup of methods to display on type blocks) was removed as it's no longer needed. The `relevantSet` parameter was removed from `GenerateMermaid`'s call chain.\n\nThis is safe because:\n- Interface blocks already display all method signatures with `+MethodName()` syntax\n- Relation arrows (`Type ..|\u003e Interface`) clearly show which types implement which interfaces\n- Removing duplicate method listings significantly declutters diagrams for repos with many implementations\n\n## Files to Create\n\nNone.\n\n## Files to Modify\n\nAll changes below appear to be ALREADY APPLIED. The implementing agent should verify each one:\n\n### 1. `internal/diagram/mermaid.go`\n**Verify current state:**\n- `writeTypeBlock` (lines 158-165): Should only write `class ID { }` with an optional `%% file:` comment. Should NOT call `writeMethodLines` or emit any `+MethodName()` lines.\n- `buildRelevantMethodsMap`: Should NOT exist anywhere in the file.\n- `GenerateMermaid` (line 23): Should NOT accept or pass a `relevantSet` parameter. The call to `writeTypeBlock` on line 84 should take only `(\u0026b, typ)`.\n- `writeMethodLines` should only be called from `writeInterfaceBlock` (line 151).\n\n**If any of the above are NOT already applied:** Apply the missing changes per the task description.\n\n### 2. `internal/diagram/slides.go`\n**Verify current state:**\n- `generateOverviewMermaid` should have `direction LR` after `classDiagram` (currently line 154).\n- Type blocks in the overview should be empty (no methods), which they already are by design of this function.\n\n### 3. `internal/integration_test.go`\n**Verify current state:**\n- Line 422: `assert.NotContains(t, overview, \"+\", \"overview should have no method lines\")` — this assertion validates overview has no method `+` lines. Should remain as-is.\n- All other test assertions check for method names like `Area()` in the full diagram output. These will still pass because methods appear in interface blocks (via `writeInterfaceBlock` → `writeMethodLines`).\n- No test changes needed.\n\n### 4. `docs/architecture.md`\n**Verify current state:**\n- Line 51 should contain text explaining that implementation blocks show only the type name and methods are omitted. Currently reads: \"implementation blocks (green) show only the type name -- methods are omitted from impl blocks because they are already listed in the interface blocks, reducing visual clutter.\"\n\n## Dependencies\n\n- No external packages needed\n- No internal module changes needed\n- No blocking tasks\n\n## Edge Cases \u0026 Error Handling\n\n1. **Types with no SourceFile:** `writeTypeBlock` handles this — the `%% file:` comment is conditional on `typ.SourceFile != \"\"`. Verify this still works.\n2. **Overview vs detail slides:** Overview diagrams (slides.go) already omit methods from both interface AND type blocks. Detail slides show methods only in interface blocks. Verify both render correctly.\n3. **Empty diagrams:** Tests 07 (no stdlib) and 08 (empty iface) produce empty diagrams — verify they still pass.\n\n## Testing Strategy\n\n### Automated Tests\nRun: `cd /Users/olehluchkiv/Work/test-loom/goifaces \u0026\u0026 go test ./...`\n\nKey tests to verify pass:\n- `TestEndToEnd` — all 11 subtests, especially:\n  - `01_single_iface`: confirms `Area()` still appears (in interface block)\n  - `11_source_file_path`: confirms `%% file:` comments still appear\n- `TestHubAndSpokeSlides` — especially line 422 assertion that overview has no `+` method lines\n\n### Lint\nRun: `cd /Users/olehluchkiv/Work/test-loom/goifaces \u0026\u0026 golangci-lint run ./...`\n\n### Visual Verification\nRun:\n```bash\ncd /Users/olehluchkiv/Work/test-loom/goifaces\ngo build -o goifaces .\nbash scripts/visual-verify.sh\n```\nThen read a few output SVGs (e.g., `testdata/01_single_iface/output.svg`, `testdata/03_multi_iface/output.svg`) to visually confirm:\n- Interface blocks (blue) show method signatures\n- Implementation blocks (green) show ONLY the type name (no methods)\n- Relation arrows are intact\n\n### Manual Spot-Check\nAfter visual-verify, read the raw `.mmd` output for `testdata/01_single_iface/output.mmd` and verify:\n- The Shape interface block contains `+Area()` \n- The Circle impl block does NOT contain `+Area()` — only the class name and `%% file:` comment","status":"closed","priority":2,"issue_type":"task","assignee":"spark","owner":"olesho@gmail.com","created_at":"2026-02-20T04:56:36.227111-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-20T13:16:25.010019-06:00","closed_at":"2026-02-20T13:16:25.010019-06:00","close_reason":"Verified all code changes already applied. Tests pass, lint clean, visual-verify correct. Code review: no issues."}
{"id":"test-loom-xp4","title":"Support flags after positional arguments in CLI","description":"Go's flag package stops parsing at the first non-flag argument, so 'goifaces ./path -output file.md' doesn't work — flags must come before the positional arg. Consider switching to pflag or manually parsing args to support both orderings.","status":"closed","priority":3,"issue_type":"bug","owner":"olesho@gmail.com","created_at":"2026-02-19T09:05:42.944588-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T11:04:29.439666-06:00","closed_at":"2026-02-19T11:04:29.439666-06:00","close_reason":"Fixed in 045b6fb. Added reorderArgs() to support flags in any position."}
{"id":"test-loom-xsi","title":"Package Map \u0026 Structures shared selection state","description":"Unify selection state between Package Map and Structures tabs. Package Map overlays should appear below boxes, items should be toggleable checkboxes synced with Structures sidebar. Selected items should visually highlight their package boxes (fat border + count badge). All state in vanilla JS closure in server.go interactiveHTMLTemplate.","status":"closed","priority":1,"issue_type":"epic","owner":"olesho@gmail.com","created_at":"2026-02-25T16:38:07.370826-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-26T15:10:14.471883-06:00","closed_at":"2026-02-26T15:10:14.471883-06:00","close_reason":"All 9 children complete."}
{"id":"test-loom-xsi.1","title":"Reposition Package Map overlay below the clicked box","description":"In server.go interactiveHTMLTemplate, change showPackageOverlay() positioning logic (lines ~831-848). Currently the overlay appears to the RIGHT of the clicked box. Change it to appear BELOW the box instead. Update CSS for .treemap-overlay positioning accordingly. The overlay should: (1) appear directly below the clicked .treemap-node element, (2) be left-aligned with the box, (3) have width matching the box width (min 200px), (4) if it would overflow the bottom of the viewport, clamp or scroll. Key code: showPackageOverlay() around line 790, overlay CSS around line 462.","design":"## Summary\n\nReposition the Package Map overlay from appearing to the right of a clicked treemap box to appearing below it instead. Currently, `showPackageOverlay()` in `server.go` calculates `left` based on `nodeRect.right` (right edge of node), placing the overlay to the right. This change will anchor the overlay below the clicked node, left-aligned with the box, with width matching the box width (min 200px), and clamped to the viewport bottom if it would overflow.\n\n## Technical Approach\n\nThe overlay uses `position: absolute` and is appended to the `#pkgmap-html-viewport` container (which has `position: relative`). We need to change the positioning calculation from right-of-node to below-node:\n\n- **Left**: `nodeRect.left - vpRect.left + viewport.scrollLeft` (left-aligned with box)\n- **Top**: `nodeRect.bottom - vpRect.top + viewport.scrollTop + 4` (4px gap below node)\n- **Width**: match the clicked node's width via `nodeRect.width`, with `min-width: 200px`\n\nFor overflow handling: if the overlay would extend below the viewport bottom, clamp its `max-height` so it stays visible (with scrolling inside the overlay via existing `overflow-y: auto`).\n\nNo new design patterns needed — this is a positional change within existing vanilla JS and CSS.\n\n## Files to Create\n\nNone.\n\n## Files to Modify\n\n### `goifaces/internal/server/server.go`\n\n**1. CSS change in `.treemap-overlay` (line ~461-473):**\n- Remove `max-width: 400px` (width will be set dynamically to match the box)\n- Keep `min-width: 200px` as a floor\n\n**2. JS change in `showPackageOverlay()` positioning logic (lines ~830-846):**\n\nReplace the current positioning block:\n```js\n// Calculate position relative to viewport\nvar left = nodeRect.right - vpRect.left + viewport.scrollLeft + 4;\nvar top = nodeRect.top - vpRect.top + viewport.scrollTop;\n\n// Check if overlay would go off the right edge\nif (left + 200 \u003e viewport.scrollWidth) {\n  left = nodeRect.left - vpRect.left + viewport.scrollLeft - 204;\n  if (left \u003c 0) left = 0;\n}\n\noverlay.style.left = left + 'px';\noverlay.style.top = top + 'px';\n```\n\nWith:\n```js\n// Position overlay below the clicked block, left-aligned\nvar left = nodeRect.left - vpRect.left + viewport.scrollLeft;\nvar top = nodeRect.bottom - vpRect.top + viewport.scrollTop + 4;\n\n// Set width to match the clicked box (min 200px)\nvar overlayWidth = Math.max(200, nodeRect.width);\noverlay.style.width = overlayWidth + 'px';\n\n// Clamp if overlay would overflow the bottom of the viewport\nvar availableHeight = vpRect.height - (nodeRect.bottom - vpRect.top) - 4;\nif (availableHeight \u003c 100) {\n  // Not enough space below; show above the box instead\n  top = nodeRect.top - vpRect.top + viewport.scrollTop;\n  overlay.style.bottom = 'auto';\n  overlay.style.maxHeight = Math.max(100, nodeRect.top - vpRect.top - 8) + 'px';\n  // Reposition above: overlay grows upward\n  // We'll use a temporary approach: append, measure, then adjust\n} else {\n  overlay.style.maxHeight = Math.min(300, availableHeight) + 'px';\n}\n\noverlay.style.left = left + 'px';\noverlay.style.top = top + 'px';\n```\n\n**Simplified approach** (preferred — avoid complexity of \"show above\"):\n```js\n// Position overlay below the clicked block, left-aligned\nvar left = nodeRect.left - vpRect.left + viewport.scrollLeft;\nvar top = nodeRect.bottom - vpRect.top + viewport.scrollTop + 4;\n\n// Set width to match the clicked box (min 200px)\noverlay.style.width = Math.max(200, nodeRect.width) + 'px';\n\n// Clamp max-height so overlay doesn't overflow viewport bottom\nvar spaceBelow = vpRect.height - (nodeRect.bottom - vpRect.top) - 8;\nif (spaceBelow \u003e 0 \u0026\u0026 spaceBelow \u003c 300) {\n  overlay.style.maxHeight = Math.max(80, spaceBelow) + 'px';\n}\n\noverlay.style.left = left + 'px';\noverlay.style.top = top + 'px';\n```\n\nUse the **simplified approach**. The overlay already has `overflow-y: auto`, so clamped height just means a scrollbar appears. No need for \"show above\" logic — keeping it simple.\n\n**3. Dark-mode CSS change (line ~521):** No changes needed — dark mode styles only affect colors, not positioning.\n\n## Dependencies\n\nNone. This is a self-contained positioning change in the HTML template.\n\n## Edge Cases \u0026 Error Handling\n\n1. **Small boxes (\u003c 200px wide)**: Overlay will be 200px wide (min-width), extending to the right of the box — acceptable behavior.\n2. **Boxes near the bottom of viewport**: `spaceBelow` clamp ensures the overlay gets a shorter max-height with a scrollbar, rather than overflowing off-screen.\n3. **Very tall overlays (many interfaces/types)**: The existing `max-height: 300px` with `overflow-y: auto` handles this. The clamp only reduces this further if viewport space is tight.\n4. **Boxes near the right edge**: No longer relevant since overlay is below (not to the right). The overlay width matches the box, which is already positioned within the viewport.\n5. **Viewport scrolling**: Using `viewport.scrollLeft` and `viewport.scrollTop` offsets, same as current code.\n\n## Testing Strategy\n\n- The child task `test-loom-xsi.5` covers testing for this feature\n- Existing tests in `server_test.go` (TestTreemapOverlayCSS, TestClickableTreemapNodes) use `assert.Contains` on the template string — these will continue to pass since we're not changing class names or function names\n- Manual verification: click a package box, confirm overlay appears below it, left-aligned, with matching width\n- Check that scrolling within the overlay works when content is taller than `max-height`","status":"closed","priority":1,"issue_type":"task","assignee":"falcon","owner":"olesho@gmail.com","created_at":"2026-02-25T16:38:28.253903-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-25T18:28:06.105533-06:00","closed_at":"2026-02-25T18:28:06.105533-06:00","close_reason":"Completed: overlay repositioned below clicked box with dynamic width, viewport overflow clamping, and flip-above fallback. 4 new tests added.","dependencies":[{"issue_id":"test-loom-xsi.1","depends_on_id":"test-loom-xsi","type":"parent-child","created_at":"2026-02-25T16:38:28.254692-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-xsi.2","title":"Shared selection state between Package Map and Structures tabs","description":"Create a unified selection state in the vanilla JS closure (server.go interactiveHTMLTemplate). Currently Package Map overlay and Structures sidebar checkboxes are completely independent. Changes needed: (1) Promote selectedTypeIDs/selectedIfaceIDs to top-level closure variables shared by both tabs. (2) In Package Map overlay (showPackageOverlay), render items as checkboxes reflecting current selection state. Toggling an item updates the shared state. (3) In Structures tab, checkbox change events update the same shared state. (4) Add an updateSelectionUI() function that syncs both UIs: checks/unchecks Structures sidebar checkboxes AND updates Package Map visual indicators. (5) When switching tabs, re-apply visual state from the shared selection. Key files: server.go lines 787-863 (overlay), 1046-1195 (structures checkboxes), 1176-1195 (onSelectionChange). Data sources: pkgInterfaces/pkgTypes maps (lines 773-784) for mapping items to packages.","design":"## Summary\n\nThis task creates a unified selection state between the Package Map overlay and the Structures tab checkboxes. Currently, the Package Map overlay displays plain text items (interfaces/types per package) and the Structures tab has independent checkboxes that drive Mermaid diagram generation. These two features share no state. After this change, toggling an item in the Package Map overlay will check/uncheck the corresponding sidebar checkbox and vice versa. A single source of truth (`selectedTypeIDs` / `selectedIfaceIDs` as module-level Sets) drives both UIs through a shared `updateSelectionUI()` function.\n\n## Technical Approach\n\n**Architecture:** Promote selection state from DOM-query-based (reconstructed each time in `onSelectionChange()`) to module-level closure variables. Both the overlay and the sidebar checkboxes read from and write to this shared state.\n\n**Key design pattern:** Single source of truth with observer-style sync. The shared state (two Sets) is authoritative. Any mutation triggers `updateSelectionUI()` which reconciles both UIs.\n\n**Why Sets?** Fast O(1) add/delete/has. The current approach reconstructs arrays by querying the DOM on each change — a Set at module scope avoids DOM reads for state lookups.\n\n**Trade-off:** This approach adds ~60 lines of JS. An alternative would be to keep the DOM as source of truth and simply query `.impl-cb:checked` globally, but that fails when the overlay creates temporary checkboxes that are destroyed on dismiss. Module-level state survives overlay lifecycle.\n\n## Files to Modify\n\n### 1. `goifaces/internal/server/server.go` (interactiveHTMLTemplate JS section)\n\nAll changes are within the IIFE (lines 612-1391). No Go code changes needed.\n\n#### A. Add module-level selection state (after line 617, near other module vars)\n\n```javascript\nvar selectedTypeIDs = {};   // Set-like object: { [id]: true }\nvar selectedIfaceIDs = {};  // Set-like object: { [id]: true }\n```\n\nUse plain objects as Sets for ES5 compatibility (the template uses `var`, `forEach`, no arrow functions — must stay ES5).\n\n#### B. Modify `showPackageOverlay()` (lines 790-852) — render checkboxes instead of plain text\n\nReplace the item rendering in both the interfaces and types sections. Instead of:\n```javascript\nvar item = document.createElement('div');\nitem.className = 'treemap-overlay-item';\nitem.textContent = ...;\n```\n\nChange to:\n```javascript\nvar itemLabel = document.createElement('label');\nitemLabel.className = 'treemap-overlay-item';\nvar cb = document.createElement('input');\ncb.type = 'checkbox';\ncb.checked = !!selectedIfaceIDs[iface.id];  // reflect current shared state\ncb.addEventListener('change', function() {\n  if (cb.checked) {\n    selectedIfaceIDs[iface.id] = true;\n  } else {\n    delete selectedIfaceIDs[iface.id];\n  }\n  updateSelectionUI();\n});\nvar nameSpan = document.createElement('span');\nnameSpan.textContent = iface.name.indexOf('.') \u003e= 0 ? iface.name.split('.').pop() : iface.name;\nitemLabel.appendChild(cb);\nitemLabel.appendChild(nameSpan);\noverlay.appendChild(itemLabel);\n```\n\nSame pattern for types, using `selectedTypeIDs[t.id]`.\n\n#### C. Add `updateSelectionUI()` function (place near `onSelectionChange`, around line 1175)\n\nThis function syncs both UIs from the shared state:\n\n```javascript\nfunction updateSelectionUI() {\n  // 1. Sync Structures sidebar checkboxes\n  document.querySelectorAll('.impl-cb').forEach(function(cb) {\n    cb.checked = !!selectedTypeIDs[cb.value];\n  });\n  document.querySelectorAll('.iface-cb').forEach(function(cb) {\n    cb.checked = !!selectedIfaceIDs[cb.value];\n  });\n\n  // 2. Sync overlay checkboxes (if overlay is open)\n  if (activeOverlay) {\n    activeOverlay.querySelectorAll('input[type=\"checkbox\"]').forEach(function(cb) {\n      var id = cb.getAttribute('data-id');\n      var kind = cb.getAttribute('data-kind');\n      if (kind === 'iface') {\n        cb.checked = !!selectedIfaceIDs[id];\n      } else {\n        cb.checked = !!selectedTypeIDs[id];\n      }\n    });\n  }\n\n  // 3. Trigger diagram update\n  triggerDiagramUpdate();\n}\n```\n\nNote: Overlay checkboxes need `data-id` and `data-kind` attributes set during creation in `showPackageOverlay()`.\n\n#### D. Add `triggerDiagramUpdate()` helper (extracted from current `onSelectionChange` logic)\n\n```javascript\nfunction triggerDiagramUpdate() {\n  var typeIDs = Object.keys(selectedTypeIDs);\n  var ifaceIDs = Object.keys(selectedIfaceIDs);\n\n  if (typeIDs.length === 0 \u0026\u0026 ifaceIDs.length === 0) {\n    showPlaceholder();\n    currentMermaidSource = '';\n    return;\n  }\n\n  var mermaidSrc = buildMermaid(typeIDs, ifaceIDs);\n  currentMermaidSource = mermaidSrc;\n  renderSelectionDiagram(mermaidSrc);\n}\n```\n\n#### E. Modify `onSelectionChange()` (lines 1176-1195) — write to shared state instead of local vars\n\n```javascript\nfunction onSelectionChange() {\n  // Rebuild shared state from sidebar checkboxes\n  selectedTypeIDs = {};\n  document.querySelectorAll('.impl-cb:checked').forEach(function(cb) {\n    selectedTypeIDs[cb.value] = true;\n  });\n  selectedIfaceIDs = {};\n  document.querySelectorAll('.iface-cb:checked').forEach(function(cb) {\n    selectedIfaceIDs[cb.value] = true;\n  });\n  updateSelectionUI();\n}\n```\n\nThis is called when sidebar checkboxes change. It reads from sidebar DOM (since the user just toggled a sidebar checkbox), writes to shared state, then calls `updateSelectionUI()` which syncs overlay and triggers diagram.\n\n#### F. Modify bulk selection handlers (lines 1092-1110) — no change needed\n\nThe existing bulk handlers (`impls-all`, `impls-clear`, `ifaces-all`, `ifaces-clear`) already call `onSelectionChange()` after toggling checkboxes, so they'll automatically flow through the new shared state path.\n\n#### G. Overlay checkbox CSS\n\nAdd CSS for checkboxes inside the overlay. The `.treemap-overlay-item` currently has `cursor: default` — change it to accommodate `\u003clabel\u003e` with a checkbox:\n\n```css\n.treemap-overlay-item {\n  padding: 3px 12px;\n  font-size: 0.8rem;\n  cursor: pointer;        /* was cursor: default */\n  display: flex;\n  align-items: center;\n  gap: 6px;\n}\n\n.treemap-overlay-item input[type=\"checkbox\"] {\n  margin: 0;\n  flex-shrink: 0;\n}\n```\n\nAlso add the same styles in the dark mode media query section if needed (the existing dark overlay styles around line 514+).\n\n## Files to Create\n\nNone. All changes are within the existing `server.go` template.\n\n## Dependencies\n\n- **Internal:** Depends on the existing `pkgInterfaces` / `pkgTypes` maps (lines 773-784) which map package paths to interface/type objects. These already exist.\n- **Internal:** The `activeOverlay` variable (line 787) is already module-scoped, so `updateSelectionUI()` can check if an overlay is open.\n- **No external packages needed.**\n- **Task dependency:** The parent epic `test-loom-xsi` is a dependency per the bead graph, but this task's implementation is self-contained.\n\n## Edge Cases \u0026 Error Handling\n\n1. **Overlay dismissed while items selected:** Selection state persists in module vars. Sidebar checkboxes remain checked. Re-opening the overlay for the same package will show correct checked state.\n\n2. **Overlay for package with no items in sidebar:** Some packages may have items in `pkgInterfaces`/`pkgTypes` but all their items also appear in the sidebar. Since both use `data.interfaces` and `data.types`, the IDs will always match. No edge case here.\n\n3. **Switching tabs with active selections:** The `switchTab()` function doesn't reset state (line 1135-1148). This is correct — selections should persist across tab switches. When returning to Structures tab, checkboxes will already be in sync because `onSelectionChange()` wrote to shared state.\n\n4. **Rapid checkbox toggling:** No debounce needed. Each toggle immediately writes to the shared state object. Mermaid rendering is the expensive part, but it's already handled with `mermaid.run()` which is async.\n\n5. **Empty selection after unchecking last item:** `triggerDiagramUpdate()` handles this — calls `showPlaceholder()` when both Sets are empty.\n\n6. **Overlay checkbox and sidebar checkbox for same item:** If user checks an item in the overlay, the sidebar checkbox syncs immediately via `updateSelectionUI()`. If the sidebar is not visible (Structures tab not active), the DOM checkbox update still works — it's just not visible until tab switch.\n\n## Testing Strategy\n\nThis task is blocked-by the test task `test-loom-xsi.6` which will cover automated testing. For implementation verification:\n\n1. **Manual test: Overlay → Sidebar sync**\n   - Open Package Map tab\n   - Click a package box to open overlay\n   - Check an interface checkbox in the overlay\n   - Switch to Structures tab\n   - Verify the same interface is checked in the sidebar\n   - Verify the Mermaid diagram includes that interface\n\n2. **Manual test: Sidebar → Overlay sync**\n   - Switch to Structures tab\n   - Check a type checkbox\n   - Switch to Package Map tab\n   - Click the package containing that type\n   - Verify the checkbox is checked in the overlay\n\n3. **Manual test: Bulk select/clear**\n   - In Structures tab, click \"All\" for Implementations\n   - Switch to Package Map, open a package overlay\n   - Verify all types in that package are checked\n   - Click \"Clear\" in Structures tab\n   - Re-open overlay — verify all unchecked\n\n4. **Manual test: Selection persistence across tab switches**\n   - Select items in Structures tab\n   - Switch to Package Map and back\n   - Verify selections still present\n\n5. **Manual test: Overlay dismiss doesn't lose state**\n   - Check items in overlay\n   - Click outside to dismiss\n   - Re-open same overlay\n   - Verify items still checked","status":"closed","priority":1,"issue_type":"task","assignee":"falcon","owner":"olesho@gmail.com","created_at":"2026-02-25T16:38:28.984226-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-26T07:44:09.532778-06:00","closed_at":"2026-02-26T07:44:09.532778-06:00","close_reason":"Implemented shared selection state with re-entrancy guard and code review fixes","dependencies":[{"issue_id":"test-loom-xsi.2","depends_on_id":"test-loom-xsi","type":"parent-child","created_at":"2026-02-25T16:38:28.984876-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-xsi.3","title":"Highlight Package Map boxes containing selected items with fat border","description":"After shared selection state (test-loom-xsi.2) is in place, add visual highlighting to Package Map boxes that contain at least one selected item. In updateSelectionUI() (or a new updatePackageMapHighlights() called from it): (1) Iterate over all .treemap-node elements. (2) For each, check if any of its interfaces/types (via pkgInterfaces/pkgTypes maps) are in the shared selected sets. (3) If yes, add a CSS class like .tm-has-selection that applies a noticeably thicker border (e.g. 3px solid with accent color). (4) If no, remove the class. CSS for .tm-has-selection should be visually distinct - suggest border: 3px solid var(--accent) or similar. Must update on every selection change.","design":"## Summary\n\nAdd visual highlighting (thick accent border) to Package Map treemap boxes that contain at least one selected interface or type. When a user selects items via the overlay checkboxes or the Structures sidebar, the corresponding package boxes should immediately show a fat border to indicate they contain active selections. This provides at-a-glance visual feedback about which packages are involved in the current selection.\n\n## Technical Approach\n\n**Strategy**: Hook into the existing `updateSelectionUI()` function to add a new pass that computes which packages contain selected items, then toggles a CSS class on matching `.treemap-node` elements.\n\n**Key insight**: The `pkgInterfaces` and `pkgTypes` maps (lines 785-796) already index items by `pkgPath`, but we need the reverse: given selected item IDs, find which packages contain them. Rather than building a reverse index, we can iterate `pkgInterfaces` and `pkgTypes` and check if any of their items appear in `selectedIfaceIDs` / `selectedTypeIDs`. This is efficient because package count is bounded and small.\n\n**To enable DOM targeting**: Store `data-pkgpath` on each `.treemap-node` element during rendering so we can query them later.\n\n## Files to Modify\n\n### 1. `goifaces/internal/server/server.go`\n\nAll changes are within the embedded HTML/JS/CSS template:\n\n#### CSS additions (after line 459, after `.treemap-node.tm-selected`):\n\nAdd new CSS class `.tm-has-selection`:\n\n```css\n.treemap-node.tm-has-selection {\n  border: 3px solid #1976d2;\n  box-shadow: 0 0 0 2px rgba(25,118,210,0.25);\n}\n```\n\nUses the same accent blue (`#1976d2`) as the existing `.tm-selected` class for visual consistency, but with a 3px border (thicker than `.tm-selected`'s 2px) to make it more prominent.\n\nAdd corresponding dark mode rule inside the existing `@media (prefers-color-scheme: dark)` block (after line 520):\n\n```css\n.treemap-node.tm-has-selection {\n  border-color: #7c8dff;\n  box-shadow: 0 0 0 2px rgba(124,141,255,0.25);\n}\n```\n\nAlso update the `transition` property on `.treemap-node` (line 385) from `transition: border-color 0.15s` to `transition: border-color 0.15s, border-width 0.15s, box-shadow 0.15s` so the highlight animates smoothly.\n\n#### JS: Add `data-pkgpath` attribute during rendering\n\nIn the leaf node rendering block (~line 1024, after `node.className = 'treemap-node'`):\n\n```javascript\nif (d.pkgPath) node.setAttribute('data-pkgpath', d.pkgPath);\n```\n\nIn the self-node rendering block (~line 996, after `selfNode.className = 'treemap-node'`):\n\n```javascript\nif (d.pkgPath) selfNode.setAttribute('data-pkgpath', d.pkgPath);\n```\n\n#### JS: Add `updatePackageMapHighlights()` function\n\nDefine a new function (place it right before `updateSelectionUI`, around line 1248):\n\n```javascript\nfunction updatePackageMapHighlights() {\n  // Build set of pkgPaths that contain at least one selected item\n  var activePkgs = {};\n  for (var pkg in pkgInterfaces) {\n    for (var i = 0; i \u003c pkgInterfaces[pkg].length; i++) {\n      if (selectedIfaceIDs[pkgInterfaces[pkg][i].id]) {\n        activePkgs[pkg] = true;\n        break;\n      }\n    }\n  }\n  for (var pkg in pkgTypes) {\n    if (activePkgs[pkg]) continue; // already marked\n    for (var i = 0; i \u003c pkgTypes[pkg].length; i++) {\n      if (selectedTypeIDs[pkgTypes[pkg][i].id]) {\n        activePkgs[pkg] = true;\n        break;\n      }\n    }\n  }\n  // Toggle class on all treemap nodes\n  document.querySelectorAll('.treemap-node[data-pkgpath]').forEach(function(el) {\n    var pkg = el.getAttribute('data-pkgpath');\n    if (activePkgs[pkg]) {\n      el.classList.add('tm-has-selection');\n    } else {\n      el.classList.remove('tm-has-selection');\n    }\n  });\n}\n```\n\n#### JS: Call `updatePackageMapHighlights()` from `updateSelectionUI()`\n\nAt the end of `updateSelectionUI()` (line 1274, just before `updatingUI = false`), add:\n\n```javascript\nupdatePackageMapHighlights();\n```\n\nThis ensures highlights update on every selection change — whether triggered by overlay checkboxes, sidebar checkboxes, or any future selection source.\n\n## Files to Create\n\nNone.\n\n## Dependencies\n\n- **test-loom-xsi.2** (completed): Shared selection state between Package Map and Structures tabs — provides `selectedTypeIDs`, `selectedIfaceIDs`, and `updateSelectionUI()`.\n- **No external packages needed** — pure CSS class toggling + DOM queries.\n\n## Edge Cases \u0026 Error Handling\n\n1. **No selections**: All `.tm-has-selection` classes are removed — boxes return to default thin border. No special handling needed since the loop naturally removes the class.\n2. **All items in a package selected**: Same visual as partial selection (fat border). The count badge (test-loom-xsi.4) will distinguish partial vs. full.\n3. **Package Map not yet rendered**: `updatePackageMapHighlights()` queries `.treemap-node[data-pkgpath]` — if none exist (tab not rendered yet), the querySelectorAll returns empty and the function is a no-op.\n4. **Overlay open on highlighted box**: Both `.tm-selected` (overlay target) and `.tm-has-selection` may apply. Since `.tm-has-selection` uses 3px border and `.tm-selected` uses 2px, the 3px wins naturally via CSS specificity (both have equal specificity, but `.tm-has-selection` comes after in source order). This is fine — the box that has the overlay open also contains selections.\n5. **Performance**: The function iterates `pkgInterfaces` + `pkgTypes` (bounded by package count, typically \u003c50) and queries `.treemap-node[data-pkgpath]` (also bounded by package count). This is negligible overhead per selection change.\n\n## Testing Strategy\n\n### Manual Testing\n1. Open the Package Map tab.\n2. Click a package box to open the overlay.\n3. Check one or more interface/type checkboxes — verify the box gets a thick blue border immediately.\n4. Uncheck all items — verify the thick border disappears.\n5. Switch to the Structures tab, select items there — switch back to Package Map and verify corresponding boxes are highlighted.\n6. Select items from multiple packages — verify all corresponding boxes are highlighted simultaneously.\n7. Test in dark mode — verify the highlight uses the purple/blue accent color (#7c8dff).\n8. Verify hover still works on highlighted boxes (hover border-color change should still be visible or superseded gracefully).\n\n### Automated Testing\nCovered by test-loom-xsi.7 (dependent task: 'Test: visual indicators (fat border and count badge) on Package Map boxes').","status":"closed","priority":1,"issue_type":"task","assignee":"spark","owner":"olesho@gmail.com","created_at":"2026-02-25T16:38:29.74719-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-26T08:34:01.277958-06:00","closed_at":"2026-02-26T08:34:01.277958-06:00","close_reason":"Completed: CSS .tm-has-selection class, data-pkgpath attributes, updatePackageMapHighlights() function, integration with updateSelectionUI() and layoutTreemap()","dependencies":[{"issue_id":"test-loom-xsi.3","depends_on_id":"test-loom-xsi","type":"parent-child","created_at":"2026-02-25T16:38:29.747832-06:00","created_by":"Oleh Luchkiv"},{"issue_id":"test-loom-xsi.3","depends_on_id":"test-loom-xsi.2","type":"blocks","created_at":"2026-02-25T16:39:12.126501-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-xsi.4","title":"Show selected item count badge in Package Map blocks","description":"After shared selection state (test-loom-xsi.2) is in place, show a count badge on Package Map boxes indicating how many items are selected within that package. In updateSelectionUI() (or updatePackageMapHighlights()): (1) For each .treemap-node, count how many of its interfaces+types are in the shared selected sets. (2) If count \u003e 0, show/update a small badge element (e.g. span.tm-selection-count) displaying the number. Position it in the top-right corner of the box. (3) If count == 0, hide/remove the badge. Style: small rounded pill badge, accent background, white text, something like 'min-width:20px; height:20px; border-radius:10px; font-size:11px'. Must update on every selection change.","design":"## Summary\n\nAdd a count badge to Package Map treemap nodes showing how many interfaces/types within that package are currently selected. When a user selects items (via overlay checkboxes or Structures sidebar checkboxes), each treemap node that contains selected items displays a small rounded pill badge in its top-right corner with the count. This provides at-a-glance visibility of selection distribution across packages without opening each overlay.\n\n## Technical Approach\n\nThe implementation requires three changes, all within `server.go`'s embedded HTML/JS/CSS:\n\n1. **Store `pkgPath` on DOM nodes** — During treemap rendering, set a `data-pkg-path` attribute on each `.treemap-node` so we can correlate DOM nodes with package data during selection updates.\n2. **Add badge update logic to `updateSelectionUI()`** — After syncing checkboxes, iterate all `[data-pkg-path]` treemap nodes, count selected items per package using `pkgInterfaces`/`pkgTypes` lookup maps + `selectedIfaceIDs`/`selectedTypeIDs`, and create/update/hide a `.tm-selection-count` badge element.\n3. **Add CSS for the badge** — Small rounded pill, accent background, white text, positioned absolute top-right.\n\n**Key design decisions:**\n- Use `data-pkg-path` attribute (not closure-based approach) because `updateSelectionUI()` needs to find and iterate all treemap nodes without access to the render-time closures.\n- Create badge elements lazily on first need rather than during render, to avoid empty badge elements on nodes that never have selections.\n- Use the existing `pkgInterfaces`/`pkgTypes` maps (lines 785-796) for the count — these already map `pkgPath → [items]`, so counting selected items is a filter+count on each array.\n\n## Files to Modify\n\n### `goifaces/internal/server/server.go` (single file, all changes)\n\n**Change 1: Add `data-pkg-path` to treemap nodes during render**\n- In the self-node branch (around line 996), after creating `selfNode`, add:\n  `selfNode.setAttribute('data-pkg-path', d.pkgPath);`\n- In the leaf-node branch (around line 1024), after creating `node`, add:\n  `node.setAttribute('data-pkg-path', d.pkgPath);`\n- Only add this attribute when `d.pkgPath` is truthy (same guard as `attachClickHandler`).\n\n**Change 2: Add `updatePackageMapBadges()` function**\n- Define a new function `updatePackageMapBadges()` after `updateSelectionUI()` (around line 1275).\n- Logic:\n  ```\n  function updatePackageMapBadges() {\n    document.querySelectorAll('.treemap-node[data-pkg-path]').forEach(function(node) {\n      var pkgPath = node.getAttribute('data-pkg-path');\n      var ifaces = pkgInterfaces[pkgPath] || [];\n      var types = pkgTypes[pkgPath] || [];\n      var count = 0;\n      for (var i = 0; i \u003c ifaces.length; i++) {\n        if (selectedIfaceIDs[ifaces[i].id]) count++;\n      }\n      for (var i = 0; i \u003c types.length; i++) {\n        if (selectedTypeIDs[types[i].id]) count++;\n      }\n      var badge = node.querySelector('.tm-selection-count');\n      if (count \u003e 0) {\n        if (!badge) {\n          badge = document.createElement('span');\n          badge.className = 'tm-selection-count';\n          node.appendChild(badge);\n        }\n        badge.textContent = count;\n        badge.style.display = '';\n      } else if (badge) {\n        badge.style.display = 'none';\n      }\n    });\n  }\n  ```\n\n**Change 3: Call `updatePackageMapBadges()` from `updateSelectionUI()`**\n- At the end of `updateSelectionUI()`, just before `updatingUI = false;` (line 1273), add:\n  `updatePackageMapBadges();`\n\n**Change 4: Add CSS for `.tm-selection-count`**\n- Add after the `.treemap-node.tm-selected` block (after line 459):\n  ```css\n  .treemap-node .tm-selection-count {\n    position: absolute;\n    top: 2px;\n    right: 2px;\n    min-width: 20px;\n    height: 20px;\n    border-radius: 10px;\n    background: #4a9c6d;\n    color: #fff;\n    font-size: 11px;\n    font-weight: 600;\n    line-height: 20px;\n    text-align: center;\n    padding: 0 5px;\n    pointer-events: none;\n    z-index: 5;\n    box-sizing: border-box;\n  }\n  ```\n- Add dark mode variant inside the existing `@media (prefers-color-scheme: dark)` block (after line 520):\n  ```css\n  .treemap-node .tm-selection-count {\n    background: #66bb6a;\n    color: #1a1a1a;\n  }\n  ```\n\n## Files to Create\n\nNone.\n\n## Dependencies\n\n- **test-loom-xsi.2** (completed): Shared selection state — provides `selectedTypeIDs`, `selectedIfaceIDs`, and `updateSelectionUI()`.\n- No external packages needed. All changes are vanilla JS/CSS within the Go template.\n\n## Edge Cases \u0026 Error Handling\n\n1. **No selections** — Badge is hidden (display:none), not removed, so re-selection is fast (no DOM creation).\n2. **Package with no interfaces or types** — These nodes don't get `data-pkg-path` (same guard as `attachClickHandler`), so they're skipped.\n3. **Badge overflow on small nodes** — The badge uses `position:absolute` and `z-index:5`, so it can overflow small treemap nodes gracefully. The `pointer-events:none` ensures it doesn't interfere with click handlers.\n4. **Treemap re-layout on resize** — `layoutTreemap()` clears the container (`container.innerHTML = ''`), destroying old badges. The next `updateSelectionUI()` call will recreate badges for any selected items. Note: `layoutTreemap()` itself doesn't call `updatePackageMapBadges()`, but since the treemap is re-rendered and `updateSelectionUI()` is only called on selection change, we should also call `updatePackageMapBadges()` after `layoutTreemap()`. Add a call at the end of `layoutTreemap()` (after line 1101): `updatePackageMapBadges();`\n5. **Count accuracy** — Counting is done by iterating `pkgInterfaces[pkgPath]` and `pkgTypes[pkgPath]` arrays and checking membership in `selectedIfaceIDs`/`selectedTypeIDs`. This is O(items_per_package) per node, which is fine for typical package sizes.\n\n## Testing Strategy\n\n**Manual verification:**\n1. Open the app, switch to Package Map tab.\n2. Click a treemap node to open its overlay. Check some interfaces/types.\n3. Verify: the clicked node shows a green badge with the correct count.\n4. Open a different node's overlay, select items there. Verify both nodes show correct badges.\n5. Uncheck all items in a package. Verify the badge disappears.\n6. Switch to the Structures tab, check items from the sidebar. Switch back to Package Map — verify badges reflect those selections.\n7. Resize the browser window (triggers treemap re-layout). Verify badges are preserved.\n8. Test in dark mode — badge should use lighter green with dark text.\n9. Test with a node that has only 1 selected item (badge shows \"1\") and a node with many (e.g., \"12\") to verify the pill stretches correctly with `min-width`.\n\n**Automated test coverage:**\n- Covered by test-loom-xsi.7 (visual indicators test, depends on this task).","status":"closed","priority":1,"issue_type":"task","assignee":"spark","owner":"olesho@gmail.com","created_at":"2026-02-25T16:38:30.445811-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-26T08:40:13.810528-06:00","closed_at":"2026-02-26T08:40:13.810528-06:00","close_reason":"Already implemented in commit b0ffe53","dependencies":[{"issue_id":"test-loom-xsi.4","depends_on_id":"test-loom-xsi","type":"parent-child","created_at":"2026-02-25T16:38:30.446557-06:00","created_by":"Oleh Luchkiv"},{"issue_id":"test-loom-xsi.4","depends_on_id":"test-loom-xsi.2","type":"blocks","created_at":"2026-02-25T16:39:12.776819-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-xsi.5","title":"Test: Package Map overlay positioning below box","description":"Write tests verifying Package Map overlay positioning. Test scenarios: (1) Overlay appears below the clicked box, not to the right. (2) Overlay left edge aligns with box left edge. (3) When box is near the bottom of viewport, overlay doesn't overflow or is properly clamped. (4) Overlay width is at least 200px. Use the project's existing test approach - check if there are Go tests for server.go or JS test infrastructure. If no test infra exists, create a Go test that renders the template and checks the JS positioning logic, or add a simple browser-based test.","design":"## Summary\n\nWrite Go tests that verify the Package Map overlay positioning logic in `showPackageOverlay()`. Several positioning tests already exist in `server_test.go` (added with the xsi.1 implementation), but they focus on core coordinate computation. This task adds test coverage for the flip-above fallback logic, the CSS positioning foundations (position: absolute/relative), and the default max-height constraint, completing the full overlay positioning test suite.\n\n## Technical Approach\n\nFollow the existing white-box testing pattern in `server_test.go`: assert that the `interactiveHTMLTemplate` Go constant contains specific JavaScript and CSS strings. This is the established pattern—no browser automation or JS runtime is needed.\n\nTests are organized as focused test functions, each covering one aspect of positioning. This matches the existing file structure where each `Test*` function covers a single concern.\n\n## Files to Modify\n\n### `goifaces/internal/server/server_test.go`\n\nAdd these new test functions (the ONLY file that needs changes):\n\n### 1. `TestTreemapOverlayFlipAboveWhenNoSpaceBelow`\nVerifies the flip-above branch when `spaceBelow \u003c= 0`:\n- Assert template contains `nodeRect.top - vpRect.top + viewport.scrollTop - 4` (the flip-above top computation, mirroring the 4px gap above instead of below)\n- Assert template contains `overlay.offsetHeight` (the element must be measured after DOM insertion)\n- Assert template contains `top = top - oh` (shifts overlay upward by its rendered height)\n\n### 2. `TestTreemapOverlayTopEdgeClamping`\nVerifies that when the flipped-above overlay overflows the top edge:\n- Assert template contains `overlay.style.maxHeight = (oh + top) + 'px'` (shrink overlay to fit available space)\n- Assert template contains `top = 0` after the maxHeight clamping (pins overlay to viewport top)\n\n### 3. `TestTreemapOverlayCSSPositioning`\nVerifies the CSS positioning foundation that makes absolute positioning work:\n- Assert `.treemap-viewport` section contains `position: relative` (establishes the containing block)\n- Assert `.treemap-overlay` section contains `position: absolute` (enables left/top positioning)\n- Assert `.treemap-overlay` contains `z-index: 50` (overlay renders above treemap nodes)\n\n### 4. `TestTreemapOverlayDefaultMaxHeight`\nVerifies the CSS default max-height before any JS override:\n- Assert `.treemap-overlay` CSS contains `max-height: 300px` (the default constraint)\n- Assert template contains `spaceBelow \u003c 300` (the threshold that triggers JS override is tied to the CSS default)\n\n## Files to Create\n\nNone.\n\n## Dependencies\n\n- No external packages needed—tests use only `strings`, `testing`, and `github.com/stretchr/testify/assert` (already imported)\n- Depends on test-loom-xsi.1 being merged (it is—commit 665a8b1)\n\n## Edge Cases \u0026 Error Handling\n\n- String matching must be exact (including whitespace) to avoid false positives. Each assertion targets a unique code snippet.\n- The `top = 0` assertion needs context to avoid matching unrelated zero assignments—use a larger surrounding string if the bare `top = 0` appears elsewhere in the template.\n\n## Testing Strategy\n\n**Run the tests:**\n```bash\ncd goifaces \u0026\u0026 go test ./internal/server/ -v -run 'TestTreemapOverlay'\n```\n\n**Verify all pass.** Since these are string-contains assertions against the existing template, they should pass immediately without any production code changes.\n\n**Manual verification:** Review that each assertion targets a unique, meaningful line of the positioning logic—not a trivially common string pattern.","status":"closed","priority":2,"issue_type":"task","assignee":"spark","owner":"olesho@gmail.com","created_at":"2026-02-25T16:38:31.527905-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-26T08:56:55.118507-06:00","closed_at":"2026-02-26T08:56:55.118507-06:00","close_reason":"Tests already implemented and committed in de6e7f7. All 4 tests pass: FlipAboveWhenNoSpaceBelow, TopEdgeClamping, CSSPositioning, DefaultMaxHeight.","dependencies":[{"issue_id":"test-loom-xsi.5","depends_on_id":"test-loom-xsi","type":"parent-child","created_at":"2026-02-25T16:38:31.528556-06:00","created_by":"Oleh Luchkiv"},{"issue_id":"test-loom-xsi.5","depends_on_id":"test-loom-xsi.1","type":"blocks","created_at":"2026-02-25T16:39:13.643351-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-xsi.6","title":"Test: shared selection state syncs between Package Map and Structures","description":"Write tests verifying shared selection state syncs correctly between tabs. Test scenarios: (1) Selecting an item in Package Map overlay checks the corresponding checkbox in Structures sidebar. (2) Checking a checkbox in Structures sidebar is reflected when viewing the same package in Package Map overlay. (3) Deselecting in either tab updates the other. (4) Bulk actions (All/Clear buttons in Structures) update shared state and Package Map indicators. (5) Tab switching preserves selection state. (6) The Structures diagram re-renders when selection changes from Package Map.","design":"## Summary\n\nThis task adds Go tests to `server_test.go` that verify the shared selection state synchronization machinery exists in the HTML template JavaScript. These tests ensure that selections made in the Package Map overlay propagate to the Structures sidebar, and vice versa, through a shared state architecture with re-entrancy protection.\n\nThe tests follow the existing pattern: Go string assertions on `interactiveHTMLTemplate` to verify that key JavaScript code patterns are present.\n\n## Technical Approach\n\nAll tests go in `goifaces/internal/server/server_test.go`, following the existing pattern of asserting on `interactiveHTMLTemplate` string contents. The tests verify the **existence and correctness** of JavaScript code patterns — not runtime behavior (which would require a browser). This matches how all existing tests in this file work.\n\nEach of the 6 scenarios from the task description maps to specific JavaScript code patterns that must exist in the template.\n\n## Files to Modify\n\n### `goifaces/internal/server/server_test.go`\n\nAdd the following test functions:\n\n### Test 1: `TestSharedSelectionStateFromOverlayToSidebar`\n**Scenario:** Selecting an item in Package Map overlay checks the corresponding checkbox in Structures sidebar.\n\nVerify these code patterns exist:\n- Overlay checkbox change handler directly mutates shared state: `selectedIfaceIDs[iface.id] = true` and `selectedTypeIDs[t.id] = true`\n- After mutation, `updateSelectionUI()` is called (which syncs sidebar)\n- `updateSelectionUI` syncs sidebar checkboxes: `cb.checked = !!selectedTypeIDs[cb.value]` and `cb.checked = !!selectedIfaceIDs[cb.value]`\n\n### Test 2: `TestSharedSelectionStateFromSidebarToOverlay`\n**Scenario:** Checking a checkbox in Structures sidebar is reflected when viewing the same package in Package Map overlay.\n\nVerify these code patterns exist:\n- `onSelectionChange` rebuilds shared state from sidebar checkboxes: reads `.impl-cb:checked` and `.iface-cb:checked` and populates `selectedTypeIDs` and `selectedIfaceIDs`\n- `updateSelectionUI` syncs overlay checkboxes when open: `if (activeOverlay)` block that reads `data-id` and `data-kind` attributes\n- Overlay checkboxes initialized from shared state on creation: `cb.checked = !!selectedIfaceIDs[iface.id]` and `cb.checked = !!selectedTypeIDs[t.id]`\n\n### Test 3: `TestSharedSelectionStateDeselection`\n**Scenario:** Deselecting in either tab updates the other.\n\nVerify these code patterns exist:\n- Overlay deselection uses `delete`: `delete selectedIfaceIDs[iface.id]` and `delete selectedTypeIDs[t.id]`\n- Sidebar deselection: `onSelectionChange` rebuilds from scratch (only `:checked` items), so unchecked items are naturally excluded\n- The `:checked` pseudo-selector ensures only checked boxes populate the state objects\n\n### Test 4: `TestSharedSelectionStateBulkActions`\n**Scenario:** Bulk actions (All/Clear buttons in Structures) update shared state and Package Map indicators.\n\nVerify these code patterns exist:\n- `impls-all` button sets all `.impl-cb` to checked, then calls `onSelectionChange()`\n- `impls-clear` button sets all `.impl-cb` to unchecked, then calls `onSelectionChange()`\n- `ifaces-all` and `ifaces-clear` follow the same pattern\n- `updateSelectionUI` calls `updatePackageMapHighlights()` and `updatePackageMapBadges()` (which are the Package Map visual indicators)\n\n### Test 5: `TestSharedSelectionStateTabSwitchPreservation`\n**Scenario:** Tab switching preserves selection state.\n\nVerify these code patterns exist:\n- `selectedTypeIDs` and `selectedIfaceIDs` are module-level variables (declared with `var` outside any function, inside the IIFE)\n- `switchTab` function does NOT clear or reset `selectedTypeIDs` or `selectedIfaceIDs`\n- Tab switch does NOT call `onSelectionChange()` — state persists naturally through module scope\n\n### Test 6: `TestSharedSelectionStateDiagramReRender`\n**Scenario:** The Structures diagram re-renders when selection changes from Package Map.\n\nVerify these code patterns exist:\n- `updateSelectionUI` calls `triggerDiagramUpdate()` at the end\n- `triggerDiagramUpdate` calls `buildMermaid(typeIDs, ifaceIDs)` and `renderSelectionDiagram`\n- When selection is empty, `triggerDiagramUpdate` calls `showPlaceholder()`\n- The full chain: overlay change → `updateSelectionUI()` → `triggerDiagramUpdate()` exists\n\n### Bonus Test: `TestSharedSelectionStateReEntrancyGuard`\n**Scenario:** Re-entrancy guard prevents infinite loops between overlay and sidebar sync.\n\nVerify these code patterns exist:\n- `var updatingUI = false` declaration\n- `updateSelectionUI` sets `updatingUI = true` at start and `updatingUI = false` before `triggerDiagramUpdate`\n- `onSelectionChange` checks `if (updatingUI) return` at the top\n\n## Files to Create\n\nNone.\n\n## Dependencies\n\n- No external packages needed (uses existing `strings`, `testing`, `testify/assert`)\n- No other tasks need to be completed first\n- Depends on `test-loom-xsi.2` (shared selection state implementation) which is already complete\n\n## Edge Cases \u0026 Error Handling\n\n- Tests must use exact string matching to avoid false positives (e.g., matching partial variable names)\n- Some assertions use `strings.Contains` for patterns that may appear multiple times; others use `strings.Count` for patterns that should appear exactly N times\n- The `switchTab` negative assertion (does NOT clear state) should verify absence of `selectedTypeIDs = {}` inside the switchTab function — need to be careful not to match the initial declarations. Use a pattern like `switchTab` function body NOT containing state reset.\n\n## Testing Strategy\n\n**How to run:**\n```bash\ncd goifaces \u0026\u0026 go test ./internal/server/ -run \"TestSharedSelection\" -v\n```\n\n**Key scenarios covered:**\n1. Overlay → Sidebar sync (direct state mutation + updateSelectionUI)\n2. Sidebar → Overlay sync (onSelectionChange + overlay initialization from state)\n3. Deselection propagation (delete keyword + rebuild from :checked)\n4. Bulk actions update Package Map indicators (All/Clear → onSelectionChange → highlights/badges)\n5. Tab switch preservation (module-level scope, no state clearing)\n6. Diagram re-render chain (updateSelectionUI → triggerDiagramUpdate → buildMermaid)\n7. Re-entrancy guard (updatingUI flag protects against infinite loops)\n\n**Manual verification:**\nAll tests are deterministic string assertions on the template — no browser or server needed. Run `go test` and all should pass against the current template.","status":"closed","priority":2,"issue_type":"task","assignee":"spark","owner":"olesho@gmail.com","created_at":"2026-02-25T16:38:32.458311-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-26T08:53:58.424448-06:00","closed_at":"2026-02-26T08:53:58.424448-06:00","close_reason":"Completed: 7 tests covering overlay→sidebar sync, sidebar→overlay sync, deselection, bulk actions, tab switch preservation, diagram re-render, and re-entrancy guard. Code review issues fixed.","dependencies":[{"issue_id":"test-loom-xsi.6","depends_on_id":"test-loom-xsi","type":"parent-child","created_at":"2026-02-25T16:38:32.46019-06:00","created_by":"Oleh Luchkiv"},{"issue_id":"test-loom-xsi.6","depends_on_id":"test-loom-xsi.2","type":"blocks","created_at":"2026-02-25T16:39:14.671142-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-xsi.7","title":"Test: visual indicators (fat border and count badge) on Package Map boxes","description":"Write tests verifying visual indicators on Package Map boxes. Test scenarios: (1) Box with selected items has the fat border class (.tm-has-selection). (2) Box without selected items does NOT have the class. (3) Count badge shows correct number of selected items per package. (4) Count badge is hidden when count is 0. (5) Selecting/deselecting items updates border and badge in real-time. (6) Clearing all selections removes all highlights and badges.","design":"## Summary\n\nAdd tests to `server_test.go` verifying the visual indicators (fat border and count badge) on Package Map boxes. These tests ensure the CSS classes, JavaScript functions, and logic for highlighting packages with selected items are correctly implemented and will catch regressions if the code changes.\n\n## Technical Approach\n\nFollow the established test pattern in `server_test.go`: string-assertion tests against `interactiveHTMLTemplate`. Each test function uses `assert.Contains` / `assert.False(strings.Contains(...))` / `strings.Count` to verify that specific CSS rules, JS functions, and logic fragments are present in the embedded HTML template. No DOM rendering or browser testing is needed — these are compile-time structural assertions.\n\nThis approach is consistent with all 16 existing tests in the file. The trade-off (string matching vs. DOM testing) has already been decided by the project; we follow the same convention.\n\n## Files to Modify\n\n### `goifaces/internal/server/server_test.go`\n\nAdd the following 6 test functions (matching the 6 scenarios in the task description):\n\n---\n\n### Test 1: `TestPackageMapHasSelectionClass`\n\n**Scenario:** Box with selected items has the fat border class (.tm-has-selection).\n\nAssertions:\n- `assert.Contains(t, interactiveHTMLTemplate, \".treemap-node.tm-has-selection\")` — CSS selector exists\n- `assert.Contains(t, interactiveHTMLTemplate, \"border: 3px solid #1976d2\")` — light-theme fat border (3px, not the 2px of tm-selected)\n- `assert.Contains(t, interactiveHTMLTemplate, \"el.classList.add('tm-has-selection')\")` — JS adds the class when package has selections\n- `assert.Contains(t, interactiveHTMLTemplate, \"function updatePackageMapHighlights()\")` — the function that manages the class exists\n\n---\n\n### Test 2: `TestPackageMapNoSelectionRemovesClass`\n\n**Scenario:** Box without selected items does NOT have the class (class is removed).\n\nAssertions:\n- `assert.Contains(t, interactiveHTMLTemplate, \"el.classList.remove('tm-has-selection')\")` — JS removes the class when package has no selections\n- `assert.Contains(t, interactiveHTMLTemplate, \"activePkgs[pkg]\")` — the activePkgs lookup drives add/remove decision (the `if (activePkgs[pkg]) { add } else { remove }` pattern)\n\n---\n\n### Test 3: `TestPackageMapBadgeShowsCorrectCount`\n\n**Scenario:** Count badge shows correct number of selected items per package.\n\nAssertions:\n- `assert.Contains(t, interactiveHTMLTemplate, \"function updatePackageMapBadges()\")` — badge update function exists\n- `assert.Contains(t, interactiveHTMLTemplate, \"badge.textContent = count\")` — badge text is set to the computed count\n- `assert.Contains(t, interactiveHTMLTemplate, \"badge.className = 'tm-selection-count'\")` — badge gets the correct CSS class\n- Count computation uses both ifaces and types:\n  - `assert.Contains(t, interactiveHTMLTemplate, \"if (selectedIfaceIDs[ifaces[i].id]) count++\")` — counts selected interfaces\n  - `assert.Contains(t, interactiveHTMLTemplate, \"if (selectedTypeIDs[types[i].id]) count++\")` — counts selected types\n\n---\n\n### Test 4: `TestPackageMapBadgeHiddenWhenCountZero`\n\n**Scenario:** Count badge is hidden when count is 0.\n\nAssertions:\n- `assert.Contains(t, interactiveHTMLTemplate, \"badge.style.display = 'none'\")` — badge is hidden when count drops to 0\n- `assert.Contains(t, interactiveHTMLTemplate, \"badge.style.display = ''\")` — badge is shown (display reset) when count \u003e 0\n- The hide logic is conditional on `} else if (badge) {` — only acts if badge element exists\n\n---\n\n### Test 5: `TestPackageMapSelectionUpdatesIndicatorsRealTime`\n\n**Scenario:** Selecting/deselecting items updates border and badge in real-time.\n\nAssertions:\n- Both `updatePackageMapHighlights()` and `updatePackageMapBadges()` are called from `updateSelectionUI()`:\n  - `assert.Contains(t, interactiveHTMLTemplate, \"updatePackageMapHighlights();\")` — called during UI sync\n  - `assert.Contains(t, interactiveHTMLTemplate, \"updatePackageMapBadges();\")` — called during UI sync\n- `updateSelectionUI` is called on every selection change:\n  - `assert.Contains(t, interactiveHTMLTemplate, \"function updateSelectionUI()\")` — the orchestrator function exists\n- The `updatingUI` re-entrancy guard prevents infinite loops:\n  - `assert.Contains(t, interactiveHTMLTemplate, \"var updatingUI = false\")` — guard variable initialized\n\n---\n\n### Test 6: `TestPackageMapClearAllRemovesHighlightsAndBadges`\n\n**Scenario:** Clearing all selections removes all highlights and badges.\n\nAssertions:\n- The `updatePackageMapHighlights` function iterates ALL treemap nodes:\n  - `assert.Contains(t, interactiveHTMLTemplate, \"document.querySelectorAll('.treemap-node[data-pkgpath]').forEach\")` — iterates over all Package Map nodes (this string appears in both functions)\n  - `strings.Count(interactiveHTMLTemplate, \"document.querySelectorAll('.treemap-node[data-pkgpath]').forEach\") == 2` — appears exactly twice (once in highlights fn, once in badges fn), confirming both functions process all nodes\n- When `activePkgs` is empty (nothing selected), all nodes get class removed and all badges hidden\n\n---\n\n### CSS Styling Tests (consolidated into Test 1 and an additional test):\n\n### Test 7: `TestPackageMapBadgeCSSStyle`\n\n**Scenario:** Badge CSS styling is correct for both light and dark themes.\n\nAssertions:\n- `assert.Contains(t, interactiveHTMLTemplate, \".treemap-node .tm-selection-count\")` — CSS selector exists\n- `assert.Contains(t, interactiveHTMLTemplate, \"position: absolute\")` — badge is absolutely positioned (within node)\n- Badge positioning: `assert.Contains(t, interactiveHTMLTemplate, \"top: 2px\")` and `assert.Contains(t, interactiveHTMLTemplate, \"right: 2px\")` — anchored to top-right\n- `assert.Contains(t, interactiveHTMLTemplate, \"pointer-events: none\")` — badge doesn't intercept clicks\n- `assert.Contains(t, interactiveHTMLTemplate, \"z-index: 5\")` — badge renders above node content\n\n## Files to Create\n\nNone.\n\n## Dependencies\n\n- Internal: Tests depend on `interactiveHTMLTemplate` variable from `server.go` (same package)\n- External: `github.com/stretchr/testify/assert` (already imported)\n- No new packages needed\n\n## Edge Cases \u0026 Error Handling\n\n- **Overlap with tm-selected**: The CSS has a compound rule `.treemap-node.tm-selected.tm-has-selection` that gives `tm-selected` priority (2px border) when both classes are present. Test 1 verifies `tm-has-selection` gets 3px; the existing `TestTreemapOverlayCSS` already covers `tm-selected`.\n- **Badge created dynamically**: The badge `\u003cspan\u003e` is created on-demand by JS (not in static HTML), so we test the createElement logic rather than looking for static markup.\n- **Dark theme variants**: Test 7 could optionally verify dark-theme overrides (background: #66bb6a), but since the dark theme CSS for the badge just overrides two properties and the selector is the same, the base selector test is sufficient.\n\n## Testing Strategy\n\nRun `go test ./goifaces/internal/server/` to verify all new tests pass. All assertions are string-contains checks on the embedded template, so they run instantly with no external dependencies.\n\nKey scenarios covered:\n1. CSS class `.tm-has-selection` exists with correct 3px fat border\n2. JS adds/removes the class based on selection state  \n3. Badge function exists and sets count correctly from both ifaces and types\n4. Badge hidden when count is 0, shown when count \u003e 0\n5. Both indicator functions called in real-time via `updateSelectionUI()`\n6. All nodes are iterated (both functions use querySelectorAll on all nodes)\n7. Badge CSS styling (positioning, z-index, pointer-events)\n\nManual verification: `go test -run TestPackageMap ./goifaces/internal/server/ -v`","status":"closed","priority":2,"issue_type":"task","assignee":"spark","owner":"olesho@gmail.com","created_at":"2026-02-25T16:38:33.447535-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-26T10:51:01.23472-06:00","closed_at":"2026-02-26T10:51:01.23472-06:00","close_reason":"Completed with 7 tests and code review. Fixed 2 overly-generic CSS assertions per review feedback.","dependencies":[{"issue_id":"test-loom-xsi.7","depends_on_id":"test-loom-xsi","type":"parent-child","created_at":"2026-02-25T16:38:33.448308-06:00","created_by":"Oleh Luchkiv"},{"issue_id":"test-loom-xsi.7","depends_on_id":"test-loom-xsi.3","type":"blocks","created_at":"2026-02-25T16:39:15.232158-06:00","created_by":"Oleh Luchkiv"},{"issue_id":"test-loom-xsi.7","depends_on_id":"test-loom-xsi.4","type":"blocks","created_at":"2026-02-25T16:39:15.412284-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-xsi.8","title":"Selections in Structures tab do not update Package Map highlights and badges","description":"## Bug\n\nSelection state sync between Package Map and Structures is one-directional. Selecting items in Package Map correctly shows them in the Structures tab (Mermaid diagram renders, sidebar checkboxes sync). However, selecting/deselecting items in the Structures tab does NOT update the Package Map — no fat borders, no count badges, no visual feedback on Package Map blocks.\n\n## Steps to Reproduce\n\n1. Open the app\n2. Switch to the Structures tab\n3. Select some items (check interfaces/types in the sidebar)\n4. Switch back to the Package Map tab\n5. **Expected:** Blocks containing selected items show fat border and count badge\n6. **Actual:** All blocks appear unselected — no borders, no badges\n\n## Root Cause Hypothesis\n\nThe Structures tab selection change handler (checkbox change events in the sidebar) likely updates selectedIfaceIDs/selectedTypeIDs and triggers diagram update, but does NOT call updatePackageMapHighlights() and updatePackageMapBadges(). These Package Map visual update functions may only be called from the Package Map overlay's change handler, not from the shared updateSelectionUI() path — or the Structures tab has its own selection handler that bypasses updateSelectionUI().\n\n## Fix Requirements\n\n- Ensure that selecting/deselecting items in the Structures tab calls updatePackageMapHighlights() and updatePackageMapBadges()\n- Verify the fix works both ways: Package Map → Structures AND Structures → Package Map\n- Use agentic browser to confirm the bug before and fix after\n\n## Acceptance Criteria\n\n- Selecting items in Structures tab → Package Map blocks show fat borders and count badges\n- Deselecting items in Structures tab → Package Map blocks update accordingly\n- No regression on Package Map → Structures direction","design":"## Root Cause\n\nThe `switchTab()` function in `server.go` has an incomplete condition. When the user switches back to Package Map after selecting items in Structures:\n\n- `tab === 'pkgmap-html' \u0026\u0026 !pkgMapHtmlRendered` is **false** (already rendered on first load)\n- The `else if` only handles `structures`\n- So `switchTab` exits without refreshing Package Map highlights/badges\n\nThe treemap nodes persist in the DOM (hidden via CSS `display:none`), so we just need to re-apply the selection classes when returning to Package Map.\n\n## Fix\n\n**File:** `goifaces/internal/server/server.go`\n**Location:** `switchTab` function, the if/else-if chain (~lines 1247-1256)\n\nAdd an `else if (tab === 'pkgmap-html')` branch between the first-render case and the structures case:\n\n```javascript\n      if (tab === 'pkgmap-html' \u0026\u0026 !pkgMapHtmlRendered) {\n        requestAnimationFrame(function() {\n          layoutTreemap();\n          pkgMapHtmlRendered = true;\n        });\n      } else if (tab === 'pkgmap-html') {\n        requestAnimationFrame(function() {\n          updatePackageMapHighlights();\n          updatePackageMapBadges();\n        });\n      } else if (tab === 'structures') {\n        requestAnimationFrame(function() {\n          triggerDiagramUpdate();\n        });\n      }\n```\n\n3-line insertion. No new state, no new functions. Matches existing pattern.\n\n## Verification\n\nUse agentic browser to:\n1. Confirm bug: select items in Structures tab → switch to Package Map → no highlights\n2. Apply fix\n3. Confirm fix: same steps → Package Map blocks show fat borders and count badges","status":"closed","priority":1,"issue_type":"bug","assignee":"spark","owner":"olesho@gmail.com","created_at":"2026-02-26T14:53:33.412058-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-26T15:10:14.267562-06:00","closed_at":"2026-02-26T15:10:14.267562-06:00","close_reason":"Fix merged. Bi-directional selection sync now works between Package Map and Structures.","dependencies":[{"issue_id":"test-loom-xsi.8","depends_on_id":"test-loom-xsi","type":"parent-child","created_at":"2026-02-26T14:53:33.414843-06:00","created_by":"Oleh Luchkiv"}]}
{"id":"test-loom-ymy","title":"Remote repo cloning fails to resolve Go module - packages not loaded","description":"When analyzing a remote GitHub repo (e.g. https://github.com/vxcontrol/pentagi), the tool clones successfully but fails at go mod download with 'no modules specified' and package loading fails with 'directory prefix . does not contain main module'. The tool likely isn't setting the working directory to the cloned repo path before running Go commands. Repro: ./goifaces https://github.com/vxcontrol/pentagi -port 8084","design":"## Summary\n\nWhen goifaces receives a remote GitHub URL, cloneRepo() clones the repo to a temp directory and returns that directory directly. For repos where go.mod is in a subdirectory (e.g. pentagi has go.mod at backend/), the returned directory has no go.mod, causing go mod download to fail with 'no modules specified' and packages.Load to fail with 'directory prefix . does not contain main module'. The fix: after cloning, search the cloned tree for go.mod and return the module root, mirroring how the local path handler already works.\n\n## Technical Approach\n\nThe local path handler (resolver.go lines 37-50) already correctly calls findModuleRoot(absPath) which walks UP parent directories to find go.mod. For cloned repos, we need to walk DOWN from the repo root since go.mod may be in a subdirectory.\n\n**Approach**: Add a new findModuleRootInTree() function that searches downward through the cloned repo for go.mod files. Then update cloneRepo() to call it after cloning, before running go mod download. This mirrors the existing pattern in the local path handler.\n\n**Key design decisions**:\n- Search downward (breadth-first) to find the shallowest go.mod, which is most likely the primary module\n- Skip vendor/ and .git/ directories during the search\n- If go.mod is at the repo root, this is a no-op (same as current behavior)\n- If multiple go.mod files exist at different depths, pick the shallowest one\n- If multiple go.mod files exist at the SAME depth, log a warning and pick the first one found (alphabetically sorted for determinism)\n\n## Files to Modify\n\n### 1. goifaces/internal/resolver/resolver.go\n\n**Changes needed in cloneRepo() (lines 58-84):**\n- After the git clone succeeds (line 77), call a new findModuleRootInTree(tmpDir) function\n- Use the returned module root path for goModDownload() instead of tmpDir\n- Return the module root path instead of tmpDir\n- Keep tmpDir for the cleanup function (we still want to clean the whole clone)\n\nThe updated cloneRepo() should look like:\n```go\nfunc cloneRepo(ctx context.Context, url string, logger *slog.Logger) (string, func(), error) {\n    tmpDir, err := os.MkdirTemp(\"\", \"goifaces-clone-*\")\n    if err != nil {\n        return \"\", func() {}, fmt.Errorf(\"creating temp dir: %w\", err)\n    }\n\n    cleanup := func() {\n        _ = os.RemoveAll(tmpDir)\n    }\n\n    logger.Info(\"cloning repository\", \"url\", url, \"dest\", tmpDir)\n\n    cmd := exec.CommandContext(ctx, \"git\", \"clone\", \"--depth=1\", url, tmpDir)\n    cmd.Stderr = os.Stderr\n    if err := cmd.Run(); err != nil {\n        cleanup()\n        return \"\", func() {}, fmt.Errorf(\"git clone: %w\", err)\n    }\n\n    logger.Info(\"clone complete\", \"dest\", tmpDir)\n\n    // Find module root (go.mod) in the cloned tree\n    modRoot, err := findModuleRootInTree(tmpDir)\n    if err != nil {\n        cleanup()\n        return \"\", func() {}, fmt.Errorf(\"finding module root in cloned repo: %w\", err)\n    }\n\n    logger.Info(\"found module root\", \"module_root\", modRoot)\n\n    if err := goModDownload(ctx, modRoot, logger); err != nil {\n        logger.Warn(\"go mod download failed\", \"error\", err)\n    }\n\n    return modRoot, cleanup, nil\n}\n```\n\n**New function findModuleRootInTree():**\nAdd this function after the existing findModuleRoot() function. It does a breadth-first search of the directory tree looking for go.mod files:\n\n```go\n// findModuleRootInTree searches downward from root for the shallowest go.mod file.\n// This is used for cloned repos where go.mod may be in a subdirectory.\nfunc findModuleRootInTree(root string) (string, error) {\n    // First check the root itself (most common case)\n    if _, err := os.Stat(filepath.Join(root, \"go.mod\")); err == nil {\n        return root, nil\n    }\n\n    // BFS through subdirectories to find the shallowest go.mod\n    queue := []string{root}\n    for len(queue) \u003e 0 {\n        var nextLevel []string\n        var candidates []string\n\n        for _, dir := range queue {\n            entries, err := os.ReadDir(dir)\n            if err != nil {\n                continue\n            }\n            for _, entry := range entries {\n                if !entry.IsDir() {\n                    continue\n                }\n                name := entry.Name()\n                // Skip non-module directories\n                if name == \".git\" || name == \"vendor\" || name == \"node_modules\" || name[0] == '.' {\n                    continue\n                }\n                subdir := filepath.Join(dir, name)\n                if _, err := os.Stat(filepath.Join(subdir, \"go.mod\")); err == nil {\n                    candidates = append(candidates, subdir)\n                } else {\n                    nextLevel = append(nextLevel, subdir)\n                }\n            }\n        }\n\n        if len(candidates) \u003e 0 {\n            sort.Strings(candidates)\n            return candidates[0], nil\n        }\n        queue = nextLevel\n    }\n\n    return \"\", fmt.Errorf(\"no go.mod found in %s or any subdirectory\", root)\n}\n```\n\nNote: The sort import is already present in resolver.go (line 10 currently has strings; we need to add \"sort\").\n\nWait, checking the imports: the file has \"strings\" but not \"sort\". We need to add \"sort\" to the imports.\n\n## Files to Create\n\nNone.\n\n## Dependencies\n\n- No new external packages needed\n- \"sort\" from stdlib needs to be added to imports in resolver.go\n\n## Edge Cases \u0026 Error Handling\n\n1. **go.mod at repo root** (most common case): findModuleRootInTree checks root first, returning immediately. Zero behavior change.\n2. **go.mod in a subdirectory** (the bug case): BFS finds the shallowest go.mod and returns its directory.\n3. **Multiple go.mod at same depth**: Sort alphabetically and pick the first. Log a warning. This is a rare edge case but provides deterministic behavior.\n4. **No go.mod anywhere**: Return a clear error message. This handles repos that aren't Go projects.\n5. **Symlinks in repo**: os.ReadDir doesn't follow symlinks by default, which is the safe behavior for cloned repos.\n6. **Very deep directory trees**: BFS naturally handles this; the shallowest module is found first.\n7. **Hidden directories** (starting with .): Skipped to avoid searching .git and similar.\n\n## Testing Strategy\n\n### Unit Tests (add to resolver_test.go or a new file)\n\n1. **Test findModuleRootInTree with go.mod at root**: Create temp dir with go.mod at root, verify it returns root.\n2. **Test findModuleRootInTree with go.mod in subdirectory**: Create temp dir with go.mod in subdir/go.mod, verify it returns subdir path.\n3. **Test findModuleRootInTree with no go.mod**: Create empty temp dir, verify it returns error.\n4. **Test findModuleRootInTree skips .git**: Create temp dir with .git/go.mod and real/go.mod, verify it returns real/.\n5. **Test findModuleRootInTree picks shallowest**: Create temp dir with a/go.mod and a/b/go.mod, verify it returns a/.\n\n### Manual Verification\n\n1. Test with a repo that has go.mod at root: `./goifaces https://github.com/some/simple-go-repo`\n2. Test with pentagi (the original failing case): `./goifaces https://github.com/vxcontrol/pentagi`\n3. Test with a local directory (regression): `./goifaces .`","status":"closed","priority":1,"issue_type":"bug","assignee":"falcon","owner":"olesho@gmail.com","created_at":"2026-02-20T16:30:51.025652-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-21T08:05:31.829556-06:00","closed_at":"2026-02-21T08:05:31.829556-06:00","close_reason":"Replaced shallow depth-1 findModuleRootRecursive with proper BFS that searches all subdirectory levels, skips .git/vendor/node_modules/hidden dirs, and sorts candidates for determinism. Added 6 unit tests."}
{"id":"test-loom-z1t","title":"Treemap: package names truncated in narrow blocks","description":"In Package Map (html) tab, narrow treemap blocks truncate package names too aggressively. Example: pkg/providers/provider shows as pkg/prov... inside the providers group. The group label already provides parent context, so nested nodes should display just their leaf name (e.g. provider) instead of the full relative path. Word-break wrapping was tried but causes ugly mid-word breaks. Better approach: use d.name instead of d.relPath when depth \u003e 0 in renderTreemap(). File: goifaces/internal/server/server.go, lines ~668 and ~695.","design":"## Summary\n\nIn the Package Map (HTML) treemap tab, narrow blocks truncate package names like `pkg/providers/provider` to `pkg/prov...` because the display text uses `d.relPath` (the full module-relative path) even for nodes nested inside groups. Since group labels already display the parent directory name, nested nodes should show only their leaf segment name (`d.name`) — e.g., just `provider` instead of `pkg/providers/provider`. This avoids unnecessary truncation while preserving full context via the group label and the hover tooltip.\n\n## Technical Approach\n\nUse the `depth` parameter already available in `renderTreemap()` to decide which label to show:\n- When `depth === 0` (top-level nodes): keep using `d.relPath || d.name` (full relative path)\n- When `depth \u003e 0` (nodes nested inside a group): use `d.name` only (leaf segment)\n\nThis is a minimal, targeted fix. The group label already shows the parent context, and the tooltip (which uses `d.pkgPath` when available) continues to show the full package path on hover. No Go backend changes needed — the `name` field already contains the leaf segment in every `PackageMapNode`.\n\nThe plain-text treemap renderer (`buildTreemapText()` at line 1092) does NOT need this change because it uses indentation for hierarchy context rather than group labels.\n\n## Files to Modify\n\n### `goifaces/internal/server/server.go`\n\nTwo lines need changing in the embedded JavaScript within the `renderTreemap()` function:\n\n**Line 666** (self-node label inside a group node):\n```javascript\n// Before:\nsn.textContent = d.relPath || d.name;\n// After:\nsn.textContent = depth \u003e 0 ? d.name : (d.relPath || d.name);\n```\n\n**Line 693** (leaf node label):\n```javascript\n// Before:\nnameEl.textContent = d.relPath || d.name;\n// After:\nnameEl.textContent = depth \u003e 0 ? d.name : (d.relPath || d.name);\n```\n\nNo other files need changes.\n\n## Dependencies\n\nNone. This is a self-contained JavaScript fix within the Go template.\n\n## Edge Cases \u0026 Error Handling\n\n1. **Top-level leaf nodes (depth=0)**: These have no parent group label, so they must continue showing `d.relPath || d.name`. The `depth \u003e 0` check handles this.\n2. **Nodes where `d.name` equals `d.relPath`**: No visual change — the ternary just returns the same value.\n3. **Nodes with empty `d.name`**: Cannot happen — `insertNode()` in slides.go always sets `name` to the path segment, which is never empty (it comes from splitting a non-empty rel path on \"/\").\n4. **Tooltip still works**: `attachTooltip()` is called with the original `d` object and uses `d.pkgPath` for the full path — completely independent of the label text.\n\n## Testing Strategy\n\n1. Run the Go project against a multi-level package repository (e.g., one with packages like `pkg/providers/provider`, `internal/server`, etc.)\n2. Open the Package Map (html) tab\n3. Verify that:\n   - Nested blocks inside groups show only leaf names (e.g., `provider`, not `pkg/providers/provider`)\n   - Top-level blocks still show their full relative path\n   - Group labels still show parent directory names\n   - Hovering any block shows the full package path in the tooltip\n   - The plain-text Package Map tab is unaffected\n4. Run existing Go tests: `go test ./...` from the goifaces directory","status":"closed","priority":1,"issue_type":"bug","assignee":"nova","owner":"olesho@gmail.com","created_at":"2026-02-24T10:34:39.567489-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-24T11:46:33.102581-06:00","closed_at":"2026-02-24T11:46:33.102581-06:00","close_reason":"Fixed: nested treemap nodes now show leaf name instead of full relPath when depth \u003e 0"}
{"id":"test-loom-z87","title":"Slide threshold prevents splitting for go-memdb (17 nodes \u003c 20)","description":"go-memdb has 5 interfaces + 12 types = 17 nodes. The default slide threshold is 20, so BuildSlides returns a single Full Diagram slide and never invokes the splitter. The threshold should account for relation density, not just node count. A graph with 17 nodes and 38 relations is highly connected and benefits from splitting.","status":"closed","priority":1,"issue_type":"bug","owner":"olesho@gmail.com","created_at":"2026-02-19T19:29:55.026577-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-19T19:31:45.835999-06:00","closed_at":"2026-02-19T19:31:45.835999-06:00","close_reason":"Fixed threshold check to also split when relation count \u003e= threshold. go-memdb (17 nodes, 38 relations) now produces 5 slides."}
{"id":"test-loom-zd2","title":"Mermaid chart not rendered when switching to Structures tab with pre-selected items","description":"## Bug\n\nWhen selecting items via Package Map (clicking blocks, selecting items in overlay lists), then switching to the Structures tab, the Mermaid chart does not render. However, adding at least one more element from within the Structures tab causes the entire chart to appear — including the items that were previously selected from Package Map.\n\n## Root Cause Hypothesis\n\nThe selection state IS being stored correctly (proven by the fact that all items appear once a new element is added). The issue is that the Mermaid chart render/update is not triggered when switching to the Structures tab with an existing selection. The render likely only fires on selection change events within the Structures tab itself, not on tab switch.\n\n## Steps to Reproduce\n\n1. Open the app\n2. In Package Map, click on some blocks\n3. Select a few items from the overlay lists\n4. Switch to the Structures tab\n5. **Expected:** Mermaid chart shows all selected items\n6. **Actual:** Mermaid chart is blank/not rendered\n7. Select one more item from within the Structures tab\n8. Now the full chart renders with ALL items (including those from step 3)\n\n## Fix Requirements\n\n- Ensure Mermaid chart renders when switching to the Structures tab if items are already selected\n- Use agentic browser to confirm the bug before fixing\n- Use agentic browser to confirm the fix works after\n\n## Acceptance Criteria\n\n- Selecting items in Package Map, then switching to Structures tab, shows the Mermaid chart immediately\n- No regression: selecting items directly in Structures tab still works as before","design":"## Root Cause\n\n`switchTab()` in `server.go` (lines ~1240-1253) never triggers a Mermaid re-render when switching to the Structures tab.\n\nWhen items are selected via Package Map, `renderSelectionDiagram()` fires — but the Structures panel is `display:none` at that point. Mermaid.js renders into a zero-dimension container, producing a broken/invisible SVG. When the user later switches to Structures, `switchTab()` just toggles the `.active` class but never re-renders the diagram.\n\nAdding one more item from within Structures works because it triggers `updateSelectionUI() → triggerDiagramUpdate()` while the panel is now visible.\n\n## Fix\n\n**File:** `goifaces/internal/server/server.go`\n**Location:** `switchTab` function, lines ~1247-1253\n\nAdd an `else if` branch for the `structures` tab that calls `triggerDiagramUpdate()` via `requestAnimationFrame` (matching the existing pattern for `pkgmap-html`):\n\n```javascript\n        if (tab === 'pkgmap-html' \u0026\u0026 !pkgMapHtmlRendered) {\n          requestAnimationFrame(function() {\n            layoutTreemap();\n            pkgMapHtmlRendered = true;\n          });\n        } else if (tab === 'structures') {\n          requestAnimationFrame(function() {\n            triggerDiagramUpdate();\n          });\n        }\n```\n\nThis is a 3-line addition. `triggerDiagramUpdate()` already handles the no-selection case safely (shows placeholder and returns). No new state, no new functions.\n\n## Verification\n\nUse agentic browser to:\n1. Confirm bug: select items in Package Map → switch to Structures → chart missing\n2. Apply fix\n3. Confirm fix: same steps → chart renders immediately","notes":"Use agent-browser skill for verification. Run the app (go run ./goifaces/cmd/goifaces or similar), reproduce the bug in browser, fix, then confirm fix in browser.","status":"closed","priority":1,"issue_type":"bug","assignee":"spark","owner":"olesho@gmail.com","created_at":"2026-02-26T12:37:47.623245-06:00","created_by":"Oleh Luchkiv","updated_at":"2026-02-26T14:48:03.601622-06:00","closed_at":"2026-02-26T14:48:03.601622-06:00","close_reason":"Fix verified via agent-browser. Mermaid chart renders immediately on tab switch.","dependencies":[{"issue_id":"test-loom-zd2","depends_on_id":"test-loom-xsi","type":"parent-child","created_at":"2026-02-26T12:38:34.111857-06:00","created_by":"Oleh Luchkiv"}]}
